<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Zhan Hao&#39;s Blogs">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Zhan Hao&#39;s Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zhan Hao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Zhan Hao's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zhan Hao's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/26/%E6%B7%B1%E5%85%A5rabbitmq--%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/26/%E6%B7%B1%E5%85%A5rabbitmq--%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">深入rabbitmq--读书笔记（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-26 09:49:53" itemprop="dateCreated datePublished" datetime="2024-09-26T09:49:53+08:00">2024-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-18 13:49:41" itemprop="dateModified" datetime="2024-10-18T13:49:41+08:00">2024-10-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h1><p>RabbitMQ是采用Erlang编写的，开源消息代理服务器，目前隶属于 Pivotal Software。它基于AMQP开放协议，官方客户端库提供了大多数其他流行的编程语言编写的客户端库。</p>
<p>以下是来自<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/">官网的定义</a></p>
<blockquote>
<p>One broker to queue them all</p>
</blockquote>
<p>拥有以下特性：</p>
<ul>
<li>开源——属于Pivotal Software，其中Spring Framework也是Pivotal的开源作品。</li>
<li>平台和供应商无关性——作为实现了具有平台和供应商无关性的高级消息队列协议(Advanced Message Queuing Protocol，AMQP) 规范的一种消息代理服务器，RabbitMQ为几乎全部开发语言提供了客 户端工具并能运行在所有主流计算机平台上。</li>
<li>轻量级——RabbitMQ是轻量级的，运行RabbitMQ核心功能以及，诸如管理界面的插件只需要不到40MB内存。</li>
<li>面向大多数现代语言的客户端开发库——其客户端开发库的目标是 支持绝大多数编程语言并能运行于多个平台，这些语言包括Java、 Ruby、Python、PHP、JavaScript和C#等。</li>
<li>灵活控制消息通信的平衡性——在消息吞吐量和性能上， RabbitMQ提供了一种灵活性用于控制这两者在可靠消息通信上的平衡。</li>
<li>高延迟性环境插件——RabbitMQ既支持在低延迟环境下的消息通信机制，也提供了针 对如互联网的高延迟环境下的插件。</li>
<li>第三方插件——RabbitMQ提供了灵活的插件系统。</li>
<li>多层安全——在RabbitMQ的多个层次中包含着安全性设计。客户端连接可以通过使用SSL通信和客户端证书验证以提高安全性。在虚 拟主机(virtual-host)层可以管理用户访问，从而在较高层次实现消息和资源的隔离。另外，通过配置可以使用正则表达式模式匹配的 方式控制从队列中读取消息和把消息写入交换器的过程。最后，使用插件可与类似LDAP的外部认证系统进行集成。</li>
</ul>
<blockquote>
<h2 id="Interoperable"><a href="#Interoperable" class="headerlink" title="Interoperable"></a>Interoperable</h2><p>RabbitMQ <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/protocols">supports several open standard protocols</a>, including AMQP 1.0 and MQTT 5.0. There are multiple client libraries available, which can be used with your programming language of choice, just pick one. No vendor lock-in!</p>
</blockquote>
<blockquote>
<h2 id="Flexible"><a href="#Flexible" class="headerlink" title="Flexible"></a>Flexible</h2><p>RabbitMQ provides many options you can combine to define how your messages go from the publisher to one or many consumers. <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-python">Routing</a>, <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/amqp-concepts#exchange-topic">filtering</a>, <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/streams">streaming</a>, <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/federation">federation</a>, and so on, you name it.</p>
</blockquote>
<blockquote>
<h2 id="Reliable"><a href="#Reliable" class="headerlink" title="Reliable"></a>Reliable</h2><p>With the ability to <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/reliability">acknowledge message delivery</a> and to <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/quorum-queues">replicate messages across a cluster</a>, you can ensure your messages are safe with RabbitMQ.</p>
</blockquote>
<h1 id="AMQP"><a href="#AMQP" class="headerlink" title="AMQP"></a>AMQP</h1><p><a target="_blank" rel="noopener" href="https://www.amqp.org/about/what">官网定义</a>和<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol">维基的定义</a>：</p>
<blockquote>
<p>The Advanced Message Queuing Protocol (AMQP) is an open standard for passing business messages between applications or organizations. It connects systems, feeds business processes with the information they need and reliably transmits onward the instructions that achieve their goals. </p>
</blockquote>
<blockquote>
<p>The <strong>Advanced Message Queuing Protocol</strong> (<strong>AMQP</strong>) is an <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Open_standard">open standard</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Application_layer">application layer</a> protocol for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Message-oriented_middleware">message-oriented middleware</a>. The defining features of AMQP are message orientation, queuing, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Routing">routing</a> (including <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Point-to-point_(telecommunications)">point-to-point</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe">publish-and-subscribe</a>), reliability and security.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol#cite_note-acmqueue-1">1]</a></p>
</blockquote>
<p>其中AMQP1.0的<a target="_blank" rel="noopener" href="https://www.amqp.org/resources/download">定义文档</a>：<em><strong>RabbitMQ默认实现的是AMQP 0-9-1</strong></em></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240926112952711.png" alt="image-20240926112952711"></p>
<p>其中包含5部分，分别是Types、Transport、Messaging、Transactions、Security。</p>
<h1 id="RabbitMQ架构"><a href="#RabbitMQ架构" class="headerlink" title="RabbitMQ架构"></a>RabbitMQ架构</h1><p>首先，我们思考下，如果没有RabbitMQ。我们要实现一个MQ broker来解耦消息的Produer和Consumer，要如何实现，或者考虑哪些问题？</p>
<ul>
<li>如何通信？MQ broker作为服务端，如何和Publisher和Consumer客户端进行协商和通信以实现信息的传递，包括通信协议和消息体等语义。</li>
<li>Publisher把消息发到MQ broker，MQ  broker处理过程是什么样的。</li>
<li>MQ broker又是如何把消息投递给Consumer，MQ  broker处理过程是什么样的，是Push还是Pull。</li>
</ul>
<p>实现分别对应：</p>
<ul>
<li>RabbitMQ使用AMQP协议进行通信，使用的TCP通信方式，通信的数据结构，叫做帧(frame)的块结构。</li>
<li>以下是RabbitMQ，实现AMQP 0-9-1的模型。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/hello-world-example-routing-cbe9a872b37956a4072a5e13f9d76e7b.png" alt="Publish path from publisher to consumer via exchange and queue"></p>
<p>其中有几个概念：</p>
<ul>
<li>Publisher：消息的生产者</li>
<li>Consumer：消息的消费者</li>
<li>Connection：客户端和RabbitMQ通信的TCP连接</li>
</ul>
<blockquote>
<p>AMQP 0-9-1 connections are typically long-lived. <strong>AMQP 0-9-1 is an application level protocol that uses TCP for reliable delivery</strong>. Connections use authentication and can be protected using TLS. When an application no longer needs to be connected to the server, it should gracefully close its AMQP 0-9-1 connection instead of abruptly closing the underlying TCP connection.    </p>
</blockquote>
<ul>
<li>Channel：multiplexed多路复用的通信技术，逻辑通道，实现一个TCP通道，多个channel。后续frame中就带有channelid</li>
</ul>
<blockquote>
<p>Some applications need multiple connections to the broker. However, it is undesirable to keep many TCP connections open at the same time because doing so consumes system resources and makes it more difficult to configure firewalls. <strong>AMQP 0-9-1 connections are multiplexed with <em><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/channels">channels</a></em> that can be thought of as “lightweight connections that share a single TCP connection”.</strong></p>
<p>Every protocol operation performed by a client happens on a channel. Communication on a particular channel is completely separate from communication on another channel, therefore every protocol method also carries a channel ID (a.k.a. channel number), an integer that both the broker and clients use to figure out which channel the method is for.</p>
<p>A channel only exists in the context of a connection and never on its own. When a connection is closed, so are all channels on it.</p>
<p><strong>For applications that use multiple threads/processes for processing, it is very common to open a new channel per thread/process and not share channels between them.</strong></p>
</blockquote>
<ul>
<li>ExChange: 把消息路由到队列的组件。</li>
</ul>
<blockquote>
<p><em>Exchanges</em> are AMQP 0-9-1 entities <strong>where messages are sent to</strong>. Exchanges take a message and route it into zero or more queues.</p>
</blockquote>
<ul>
<li>Queue：队列负责存储接收到的消息</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/queues">Queues</a> in the AMQP 0-9-1 model are very similar to queues in other message- and task-queueing systems: <strong>they store messages that are consumed by applications.</strong> Queues share some properties with exchanges, but also have some additional properties:</p>
</blockquote>
<ul>
<li>Bindings：定义队列和交换器之间的关系</li>
</ul>
<blockquote>
<p><strong>Bindings are rules that exchanges use (among other things) to route messages to queues</strong>. To instruct an exchange E to route messages to a queue Q, Q has to be <em>bound</em> to E. Bindings may have an optional <em>routing key</em> attribute used by some exchange types. The purpose of the routing key is to select certain messages published to an exchange to be routed to the bound queue. In other words, the routing key acts like a filter.</p>
</blockquote>
<ul>
<li>Virtual Hosts：资源隔离</li>
</ul>
<blockquote>
<p><strong>To make it possible for a single broker to host multiple isolated “environments” (groups of users, exchanges, queues and so on)((, AMQP 0-9-1 includes the concept of <em><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/vhosts">virtual hosts</a></em> (vhosts).</strong> They are similar to virtual hosts used by many popular Web servers and provide completely isolated environments in which AMQP entities live. Protocol clients specify what vhosts they want to use during connection negotiation.</p>
</blockquote>
<p>Java实现，amp-client核心的类（分别对应以上的概念）：</p>
<ul>
<li>AMQP.class</li>
<li>Command.class</li>
<li>Frame.class</li>
<li>Method.class</li>
<li>Connection.class</li>
<li>Channel.class</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.AMQP AMQP协议定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AMQP</span> </span>&#123;</span><br><span class="line">  <span class="comment">//协议版本和端口</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PROTOCOL</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAJOR = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MINOR = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REVISION = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">5672</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//不同的帧类型</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_METHOD = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_HEADER = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_BODY = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_HEARTBEAT = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_MIN_SIZE = <span class="number">4096</span>;</span><br><span class="line">  <span class="comment">//帧结束位</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_END = <span class="number">206</span>;</span><br><span class="line">  <span class="comment">//不同响应码</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REPLY_SUCCESS = <span class="number">200</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONTENT_TOO_LARGE = <span class="number">311</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_ROUTE = <span class="number">312</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_CONSUMERS = <span class="number">313</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACCESS_REFUSED = <span class="number">403</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOT_FOUND = <span class="number">404</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESOURCE_LOCKED = <span class="number">405</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRECONDITION_FAILED = <span class="number">406</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONNECTION_FORCED = <span class="number">320</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INVALID_PATH = <span class="number">402</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_ERROR = <span class="number">501</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYNTAX_ERROR = <span class="number">502</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMAND_INVALID = <span class="number">503</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CHANNEL_ERROR = <span class="number">504</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNEXPECTED_FRAME = <span class="number">505</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESOURCE_ERROR = <span class="number">506</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOT_ALLOWED = <span class="number">530</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOT_IMPLEMENTED = <span class="number">540</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERNAL_ERROR = <span class="number">541</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Start</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StartOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Secure</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SecureOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Tune</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123; <span class="comment">//Start后，协商配置信息</span></span><br><span class="line">      <span class="function"><span class="keyword">int</span> <span class="title">getChannelMax</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="function"><span class="keyword">int</span> <span class="title">getFrameMax</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="function"><span class="keyword">int</span> <span class="title">getHeartbeat</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TuneOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Open</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OpenOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Close</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CloseOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Blocked</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123; <span class="comment">//内存、硬盘不足，网络问题、消费者处理缓慢、RabbitMQ配置问题，无法接受和发送消息</span></span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Unblocked</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UpdateSecret</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UpdateSecretOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Channel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Open</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OpenOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Flow</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123; <span class="comment">//流控，限制生产者发送消息，令牌机制，有信用值</span></span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FlowOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Close</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CloseOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Access</span> </span>&#123; <span class="comment">//未实现命令字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Request</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Exchange</span> </span>&#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Declare</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeclareOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Delete</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeleteOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Bind</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BindOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Unbind</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UnbindOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Declare</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略  </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeclareOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Bind</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BindOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Purge</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123; <span class="comment">//清空数据</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PurgeOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Delete</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略  </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeleteOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Unbind</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UnbindOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Basic</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Qos</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123; <span class="comment">//Quality of Service，prefetch_count参数来实现。指定了RabbitMQ最多可以向一个消费者发送未确认消息的数量。</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QosOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Consume</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConsumeOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cancel</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CancelOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Publish</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Return</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123; <span class="comment">//消息返回机制。当生产者发送一条消息到交换机，而这条消息无法路由到任何队列时，RabbitMQ就会将这条消息返回给生产者</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Deliver</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Get</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;<span class="comment">//Basic.Get，消费之主动拉模式</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GetOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GetEmpty</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Ack</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Reject</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123; <span class="comment">//与Basic.Ack对应，消费者在处理消息失败时，通知 RabbitMQ 拒绝该消息</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RecoverAsync</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;<span class="comment">//RabbitMQ 提供的一种异步恢复未确认消息的机制。当消费者在处理消息的过程中发生异常或网络中断，导致部分消息未被确认时，就可以调用这个方法，让 RabbitMQ 将这些未确认的消息重新投递到队列中，以便消费者再次尝试处理。</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Recover</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;<span class="comment">//与Basic.RecoverAsync对应，同步方式</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RecoverOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Nack</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;<span class="comment">//与Basic.Reject相比，Basic.Nack功能更加强大，可以批量拒绝多条消息，并且可以灵活控制拒绝消息的行为。</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Tx</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Select</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SelectOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Commit</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CommitOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Rollback</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RollbackOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Confirm</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Select</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;<span class="comment">//开启生产者确认模式。当生产者发送一条消息后，通过这种模式，可以获得消息是否成功投递到队列的确认。</span></span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SelectOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">          <span class="comment">//略</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicProperties</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">rabbitmq</span>.<span class="title">client</span>.<span class="title">impl</span>.<span class="title">AMQBasicProperties</span> </span>&#123;</span><br><span class="line">        <span class="comment">//属性信息</span></span><br><span class="line">        <span class="keyword">private</span> String contentType;</span><br><span class="line">        <span class="keyword">private</span> String contentEncoding;</span><br><span class="line">        <span class="keyword">private</span> Map&lt;String,Object&gt; headers;</span><br><span class="line">        <span class="keyword">private</span> Integer deliveryMode;</span><br><span class="line">        <span class="keyword">private</span> Integer priority;</span><br><span class="line">        <span class="keyword">private</span> String correlationId;</span><br><span class="line">        <span class="keyword">private</span> String replyTo;</span><br><span class="line">        <span class="keyword">private</span> String expiration;</span><br><span class="line">        <span class="keyword">private</span> String messageId;</span><br><span class="line">        <span class="keyword">private</span> Date timestamp;</span><br><span class="line">        <span class="keyword">private</span> String type;</span><br><span class="line">        <span class="keyword">private</span> String userId;</span><br><span class="line">        <span class="keyword">private</span> String appId;</span><br><span class="line">        <span class="keyword">private</span> String clusterId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.Command</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">Method <span class="title">getMethod</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">ContentHeader <span class="title">getContentHeader</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">byte</span>[] getContentBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.Method</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">protocolClassId</span><span class="params">()</span></span>; </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">protocolMethodId</span><span class="params">()</span></span>; </span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">protocolMethodName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>客户端与RabbitMQ服务器之间通信的是通过Command和Method进行的，两者之间。</p>
<ul>
<li><strong>Command是基于Method的：</strong> 每个Command都会对应一个或多个Method。当客户端发送一个Command时，实际上是将这个Command转化为一系列的Method，然后通过网络发送给服务器。</li>
<li><strong>Method是协议层面的定义：</strong> Method是AMQP协议中定义的，它规定了客户端和服务器之间通信的语法和语义。而Command则是客户端库对Method的封装，提供给开发者更方便的使用方式。</li>
<li><strong>Command是面向用户的：</strong> Command更接近于开发者的思维方式，它提供了一个抽象层，让开发者可以更方便地操作RabbitMQ。而Method则更底层，它关注的是协议的细节。</li>
</ul>
<p>其中，在Channel中，通过发送Method返回Command就能看出其中的关系。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.Channel</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Channel</span> <span class="keyword">extends</span> <span class="title">ShutdownNotifier</span>, <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">Command <span class="title">rpc</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">CompletableFuture&lt;Command&gt; <span class="title">asyncCompletableRpc</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Frame更底层，是关于数据传输。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.impl.Frame</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Frame</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Frame type code */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Frame channel number, 0-65535 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> channel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Frame payload bytes (for inbound frames) */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] payload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Frame payload (for outbound frames) */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ByteArrayOutputStream accumulator;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Connection大部分方法都是常规的IO操作，其中重要就是createChannel，创建channel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.Connection</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Connection</span> <span class="keyword">extends</span> <span class="title">ShutdownNotifier</span>, <span class="title">Closeable</span> </span>&#123; </span><br><span class="line">  <span class="function">InetAddress <span class="title">getAddress</span><span class="params">()</span></span>;、</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getChannelMax</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getFrameMax</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getHeartbeat</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Map&lt;String, Object&gt; <span class="title">getClientProperties</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">getClientProvidedName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Map&lt;String, Object&gt; <span class="title">getServerProperties</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Channel <span class="title">createChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>; <span class="comment">//创建channel</span></span><br><span class="line"></span><br><span class="line">  <span class="function">Channel <span class="title">createChannel</span><span class="params">(<span class="keyword">int</span> channelNumber)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> Optional&lt;Channel&gt; <span class="title">openChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(createChannel());</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">default</span> Optional&lt;Channel&gt; <span class="title">openChannel</span><span class="params">(<span class="keyword">int</span> channelNumber)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(createChannel(channelNumber));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> closeCode, String closeMessage)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> closeCode, String closeMessage, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">abort</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">abort</span><span class="params">(<span class="keyword">int</span> closeCode, String closeMessage)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">abort</span><span class="params">(<span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">abort</span><span class="params">(<span class="keyword">int</span> closeCode, String closeMessage, <span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addBlockedListener</span><span class="params">(BlockedListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">BlockedListener <span class="title">addBlockedListener</span><span class="params">(BlockedCallback blockedCallback, UnblockedCallback unblockedCallback)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">removeBlockedListener</span><span class="params">(BlockedListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clearBlockedListeners</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">ExceptionHandler <span class="title">getExceptionHandler</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.Channel</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Channel</span> <span class="keyword">extends</span> <span class="title">ShutdownNotifier</span>, <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getChannelNumber</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> closeCode, String closeMessage)</span> <span class="keyword">throws</span> IOException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">abort</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">abort</span><span class="params">(<span class="keyword">int</span> closeCode, String closeMessage)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addReturnListener</span><span class="params">(ReturnListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">ReturnListener <span class="title">addReturnListener</span><span class="params">(ReturnCallback returnCallback)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">removeReturnListener</span><span class="params">(ReturnListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clearReturnListeners</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addConfirmListener</span><span class="params">(ConfirmListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">ConfirmListener <span class="title">addConfirmListener</span><span class="params">(ConfirmCallback ackCallback, ConfirmCallback nackCallback)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">removeConfirmListener</span><span class="params">(ConfirmListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clearConfirmListeners</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Consumer <span class="title">getDefaultConsumer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setDefaultConsumer</span><span class="params">(Consumer consumer)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchSize, <span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicPublish</span><span class="params">(String exchange, String routingKey, BasicProperties props, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicPublish</span><span class="params">(String exchange, String routingKey, <span class="keyword">boolean</span> mandatory, BasicProperties props, <span class="keyword">byte</span>[] body)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicPublish</span><span class="params">(String exchange, String routingKey, <span class="keyword">boolean</span> mandatory, <span class="keyword">boolean</span> immediate, BasicProperties props, <span class="keyword">byte</span>[] body)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange, String type)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange, BuiltinExchangeType type)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange, String type, <span class="keyword">boolean</span> durable)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange, BuiltinExchangeType type, <span class="keyword">boolean</span> durable)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange, String type, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange, BuiltinExchangeType type, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     String type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">boolean</span> durable,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">boolean</span> internal,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     BuiltinExchangeType type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">boolean</span> durable,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">boolean</span> internal,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">exchangeDeclareNoWait</span><span class="params">(String exchange,</span></span></span><br><span class="line"><span class="params"><span class="function">                             String type,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">boolean</span> durable,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">boolean</span> internal,</span></span></span><br><span class="line"><span class="params"><span class="function">                             Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">exchangeDeclareNoWait</span><span class="params">(String exchange,</span></span></span><br><span class="line"><span class="params"><span class="function">                             BuiltinExchangeType type,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">boolean</span> durable,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">boolean</span> internal,</span></span></span><br><span class="line"><span class="params"><span class="function">                             Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclarePassive</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeleteOk <span class="title">exchangeDelete</span><span class="params">(String exchange, <span class="keyword">boolean</span> ifUnused)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">exchangeDeleteNoWait</span><span class="params">(String exchange, <span class="keyword">boolean</span> ifUnused)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">DeleteOk <span class="title">exchangeDelete</span><span class="params">(String exchange)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">BindOk <span class="title">exchangeBind</span><span class="params">(String destination, String source, String routingKey)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">BindOk <span class="title">exchangeBind</span><span class="params">(String destination, String source, String routingKey, Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">exchangeBindNoWait</span><span class="params">(String destination, String source, String routingKey, Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">UnbindOk <span class="title">exchangeUnbind</span><span class="params">(String destination, String source, String routingKey)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Exchange.<span class="function">UnbindOk <span class="title">exchangeUnbind</span><span class="params">(String destination, String source, String routingKey, Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">exchangeUnbindNoWait</span><span class="params">(String destination, String source, String routingKey, Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">(String queue, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> exclusive, <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                               Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">queueDeclareNoWait</span><span class="params">(String queue, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> exclusive, <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">DeclareOk <span class="title">queueDeclarePassive</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">DeleteOk <span class="title">queueDelete</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">DeleteOk <span class="title">queueDelete</span><span class="params">(String queue, <span class="keyword">boolean</span> ifUnused, <span class="keyword">boolean</span> ifEmpty)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">queueDeleteNoWait</span><span class="params">(String queue, <span class="keyword">boolean</span> ifUnused, <span class="keyword">boolean</span> ifEmpty)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">BindOk <span class="title">queueBind</span><span class="params">(String queue, String exchange, String routingKey)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">BindOk <span class="title">queueBind</span><span class="params">(String queue, String exchange, String routingKey, Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">queueBindNoWait</span><span class="params">(String queue, String exchange, String routingKey, Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">UnbindOk <span class="title">queueUnbind</span><span class="params">(String queue, String exchange, String routingKey)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">UnbindOk <span class="title">queueUnbind</span><span class="params">(String queue, String exchange, String routingKey, Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Queue.<span class="function">PurgeOk <span class="title">queuePurge</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">GetResponse <span class="title">basicGet</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicNack</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple, <span class="keyword">boolean</span> requeue)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicReject</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, DeliverCallback deliverCallback, CancelCallback cancelCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, DeliverCallback deliverCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, DeliverCallback deliverCallback, CancelCallback cancelCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, DeliverCallback deliverCallback, CancelCallback cancelCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, DeliverCallback deliverCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, DeliverCallback deliverCallback, CancelCallback cancelCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, Map&lt;String, Object&gt; arguments, Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, Map&lt;String, Object&gt; arguments, DeliverCallback deliverCallback, CancelCallback cancelCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, Map&lt;String, Object&gt; arguments, DeliverCallback deliverCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, Map&lt;String, Object&gt; arguments, DeliverCallback deliverCallback, CancelCallback cancelCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, DeliverCallback deliverCallback, CancelCallback cancelCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, DeliverCallback deliverCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, DeliverCallback deliverCallback, CancelCallback cancelCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, <span class="keyword">boolean</span> noLocal, <span class="keyword">boolean</span> exclusive, Map&lt;String, Object&gt; arguments, Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, <span class="keyword">boolean</span> noLocal, <span class="keyword">boolean</span> exclusive, Map&lt;String, Object&gt; arguments, DeliverCallback deliverCallback, CancelCallback cancelCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, <span class="keyword">boolean</span> noLocal, <span class="keyword">boolean</span> exclusive, Map&lt;String, Object&gt; arguments, DeliverCallback deliverCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, String consumerTag, <span class="keyword">boolean</span> noLocal, <span class="keyword">boolean</span> exclusive, Map&lt;String, Object&gt; arguments, DeliverCallback deliverCallback, CancelCallback cancelCallback, ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">basicCancel</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Basic.<span class="function">RecoverOk <span class="title">basicRecover</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Basic.<span class="function">RecoverOk <span class="title">basicRecover</span><span class="params">(<span class="keyword">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Tx.<span class="function">SelectOk <span class="title">txSelect</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Tx.<span class="function">CommitOk <span class="title">txCommit</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Tx.<span class="function">RollbackOk <span class="title">txRollback</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  Confirm.<span class="function">SelectOk <span class="title">confirmSelect</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">getNextPublishSeqNo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">waitForConfirms</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">waitForConfirms</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">waitForConfirmsOrDie</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">waitForConfirmsOrDie</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException, InterruptedException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">asyncRpc</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Command <span class="title">rpc</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">messageCount</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">consumerCount</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">CompletableFuture&lt;Command&gt; <span class="title">asyncCompletableRpc</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与面向对象编程概念非常相似， AMQP使用类和方法在客户端和服务器之间创建公共语言，这些类和方法被称为AMQP命令(AMQP commands)。AMQP中的类定义了一个功能范围，每个类都包含执行不同任务的方法。在连接协商过程中， RabbitMQ服务器发送一个Connection.Start命令，然后编组成一个帧，并发送给客户端。如图Connection.Start命令由两个组件组成:AMQP类(Class)和方法(Method)。</p>
<p>比如建立connetion的流程：</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240926165458337.png" alt="image-20240926165458337"></p>
<p>当使用command命令与RabbitMQ进行交互时，数据被封装在一个称为<strong>帧（frame）</strong>的数据结构中，帧对数据进行编码以便传输和分隔。</p>
<p>帧由五个不同的组件组成:</p>
<ul>
<li>帧类型</li>
<li>信道编号</li>
<li>以字节为单位的帧大小</li>
<li>帧有效载荷</li>
<li>结束字节标记(ASCII值206)</li>
</ul>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240926170317849.png" alt="image-20240926170317849"></p>
<p>AMQP规范定义了五种类型的帧:协议头帧、<strong>方法帧、内容头帧、 消息体帧</strong>及心跳帧。每种帧类型都有明确的目的，而有些帧的使用频 率比其他的要高很多。</p>
<ul>
<li>协议头帧：用于连接到RabbitMQ，仅使用一次。</li>
<li>方法帧：携带发送给RabbitMQ或从RabbitMQ接收到的RPC请求或响应。</li>
<li>内容头帧：包含一条消息的大小和属性。</li>
<li>消息体帧：包含消息的内容。</li>
<li>心跳帧：在客户端与RabbitMQ之间进行传递，作为一种校验机制，确保连接的两端都可用且在正常工作。</li>
</ul>
<p>使用方法帧、内容头帧和消息体帧向RabbitMQ发布消息，如下图：</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240926170731261.png" alt="image-20240926170731261"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240926170659437.png" alt="image-20240926170659437"></p>
<p>另外Consumer消费消息的流程如下：</p>
<p>不需要ack时：</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240926171345838.png" alt="image-20240926171345838"></p>
<p>需要ack时，需要用Basic.Consume命令中的no_ack参数，no_ack标志被设置为 false，则消费者必须通过发送Basic.Ack RPC请求来确认收到的每条消息。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240926171515982.png" alt="image-20240926171515982"></p>
<p>以下，将以Java RabbitMQ client的代码，来理解以上的概念。client代码基于 com.rabbitmq:amqp-client:5.22.0</p>
<p>最简单的<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/main/java/Send.java">Hello World</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/rabbitmq/rabbitmq-tutorials/blob/main/java/Send.java</span></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory(); <span class="comment">//1 创建ConnectionFactory</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> (Connection connection = factory.newConnection();<span class="comment">//2 创建Connection</span></span><br><span class="line">            Channel channel = connection.createChannel()) &#123; <span class="comment">//3 创建Channel</span></span><br><span class="line">            channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);<span class="comment">//4 声明队列</span></span><br><span class="line">            String message = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(StandardCharsets.UTF_8));<span class="comment">//5 发送消息</span></span><br><span class="line">            System.out.println(<span class="string">&quot; [x] Sent &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>com.rabbitmq.client.ConnectionFactory#newConnection，最终根据配置，会生成AutorecoveringConnection或者AMQConnection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.rabbitmq.client.ConnectionFactory</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">newConnection</span><span class="params">(ExecutorService executor, AddressResolver addressResolver, String clientProvidedName)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.metricsCollector == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.metricsCollector = <span class="keyword">new</span> NoOpMetricsCollector();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// make sure we respect the provided thread factory</span></span><br><span class="line">  FrameHandlerFactory fhFactory = createFrameHandlerFactory();</span><br><span class="line">  ConnectionParams params = params(executor);</span><br><span class="line">  <span class="comment">// set client-provided via a client property</span></span><br><span class="line">  <span class="keyword">if</span> (clientProvidedName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; properties = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(params.getClientProperties());</span><br><span class="line">    properties.put(<span class="string">&quot;connection_name&quot;</span>, clientProvidedName);</span><br><span class="line">    params.setClientProperties(properties);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isAutomaticRecoveryEnabled()) &#123;</span><br><span class="line">    <span class="comment">// see com.rabbitmq.client.impl.recovery.RecoveryAwareAMQConnectionFactory#newConnection</span></span><br><span class="line">    <span class="comment">// No Sonar: no need to close this resource because we&#x27;re the one that creates it</span></span><br><span class="line">    <span class="comment">// and hands it over to the user</span></span><br><span class="line">    AutorecoveringConnection conn = <span class="keyword">new</span> AutorecoveringConnection(</span><br><span class="line">      params, fhFactory, addressResolver, metricsCollector, observationCollector); <span class="comment">//NOSONAR</span></span><br><span class="line">    <span class="comment">//1 AutorecoveringConnection</span></span><br><span class="line">    conn.init();</span><br><span class="line">    <span class="keyword">return</span> conn;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    List&lt;Address&gt; addrs = addressResolver.getAddresses();</span><br><span class="line">    Exception lastException = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Address addr : addrs) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        FrameHandler handler = fhFactory.create(addr, clientProvidedName); <span class="comment">//FrameHandler是封装的读取Frame的TCP Sockect,后续的connection都是通过这个handler进行异步通信</span></span><br><span class="line">        AMQConnection conn = createConnection(params, handler, metricsCollector); <span class="comment">//2 AMQConnection</span></span><br><span class="line">        conn.start(); </span><br><span class="line">        <span class="keyword">this</span>.metricsCollector.newConnection(conn);</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        lastException = e;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (TimeoutException te) &#123;</span><br><span class="line">        lastException = te;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lastException != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastException <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (IOException) lastException;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastException <span class="keyword">instanceof</span> TimeoutException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (TimeoutException) lastException;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;failed to connect&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.impl.SocketFrameHandlerFactory</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FrameHandler <span class="title">create</span><span class="params">(Address addr, String connectionName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> portNumber = ConnectionFactory.portOrDefault(addr.getPort(), ssl);</span><br><span class="line">  Socket socket = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    socket = createSocket(connectionName); <span class="comment">//建立TCP连接</span></span><br><span class="line">    configurator.configure(socket);</span><br><span class="line"></span><br><span class="line">    socket.connect(addr.toInetSocketAddress(portNumber), connectionTimeout);</span><br><span class="line">    <span class="keyword">return</span> create(socket);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    quietTrySocketClose(socket);</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而FrameHandler的readFrame接口，就是从inputstream中读取数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.impl.SocketFrameHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Frame <span class="title">readFrame</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  _inputStreamLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Frame.readFrom(_inputStream, <span class="keyword">this</span>.maxInboundMessageBodySize);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    _inputStreamLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如com.rabbitmq.client.impl.AMQConnection是如何初始化的，com.rabbitmq.client.impl.AMQConnection#start方法，通过不受ChannelManager管理才channel0发送command实现初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.impl.AMQConnection</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Connetion中比较特殊的_channel0</span></span><br><span class="line"><span class="comment">/** The special channel 0 (&lt;i&gt;not&lt;/i&gt; managed by the &lt;code&gt;&lt;b&gt;_channelManager&lt;/b&gt;&lt;/code&gt;) */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AMQChannel _channel0</span><br><span class="line"></span><br><span class="line">  <span class="comment">//AMQConnection构造函数</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">AMQConnection</span><span class="params">(ConnectionParams params, FrameHandler frameHandler, MetricsCollector metricsCollector, ObservationCollector observationCollector)</span></span>&#123;</span><br><span class="line">  checkPreconditions();</span><br><span class="line">  <span class="keyword">this</span>.credentialsProvider = params.getCredentialsProvider();</span><br><span class="line">  <span class="keyword">this</span>._frameHandler = frameHandler;</span><br><span class="line">  <span class="keyword">this</span>._virtualHost = params.getVirtualHost();</span><br><span class="line">  <span class="keyword">this</span>._exceptionHandler = params.getExceptionHandler();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._clientProperties = <span class="keyword">new</span> HashMap&lt;&gt;(params.getClientProperties());</span><br><span class="line">  <span class="keyword">this</span>.requestedFrameMax = params.getRequestedFrameMax();</span><br><span class="line">  <span class="keyword">this</span>.requestedChannelMax = params.getRequestedChannelMax();</span><br><span class="line">  <span class="keyword">this</span>.requestedHeartbeat = params.getRequestedHeartbeat();</span><br><span class="line">  <span class="keyword">this</span>.handshakeTimeout = params.getHandshakeTimeout();</span><br><span class="line">  <span class="keyword">this</span>.shutdownTimeout = params.getShutdownTimeout();</span><br><span class="line">  <span class="keyword">this</span>.saslConfig = params.getSaslConfig();</span><br><span class="line">  <span class="keyword">this</span>.consumerWorkServiceExecutor = params.getConsumerWorkServiceExecutor();</span><br><span class="line">  <span class="keyword">this</span>.heartbeatExecutor = params.getHeartbeatExecutor();</span><br><span class="line">  <span class="keyword">this</span>.shutdownExecutor = params.getShutdownExecutor();</span><br><span class="line">  <span class="keyword">this</span>.threadFactory = params.getThreadFactory();</span><br><span class="line">  <span class="keyword">if</span>(params.getChannelRpcTimeout() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Continuation timeout on RPC calls cannot be less than 0&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.channelRpcTimeout = params.getChannelRpcTimeout();</span><br><span class="line">  <span class="keyword">this</span>.channelShouldCheckRpcResponseType = params.channelShouldCheckRpcResponseType();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.trafficListener = params.getTrafficListener() == <span class="keyword">null</span> ? TrafficListener.NO_OP : params.getTrafficListener();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.credentialsRefreshService = params.getCredentialsRefreshService();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._channel0 = createChannel0();<span class="comment">//构造函数初始化_channel0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._channelManager = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._brokerInitiatedShutdown = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._inConnectionNegotiation = <span class="keyword">true</span>; <span class="comment">// we start out waiting for the first protocol response</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.metricsCollector = metricsCollector;</span><br><span class="line">  <span class="keyword">this</span>.observationCollector = observationCollector;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.errorOnWriteListener = params.getErrorOnWriteListener() != <span class="keyword">null</span> ? params.getErrorOnWriteListener() :</span><br><span class="line">  (connection, exception) -&gt; &#123; <span class="keyword">throw</span> exception; &#125;; <span class="comment">// we just propagate the exception for non-recoverable connections</span></span><br><span class="line">  <span class="keyword">this</span>.workPoolTimeout = params.getWorkPoolTimeout();</span><br><span class="line">  <span class="keyword">this</span>.maxInboundMessageBodySize = params.getMaxInboundMessageBodySize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建channel0</span></span><br><span class="line"><span class="function">AMQChannel <span class="title">createChannel0</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Channel的构造函数，两个参数，Connetion+Channel_id</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> AMQChannel(<span class="keyword">this</span>, <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//public abstract boolean processAsync(Command command) throws IOException;</span></span><br><span class="line">    <span class="comment">//有两个实现，Connection和ChannelN，处理Command</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processAsync</span><span class="params">(Command c)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> getConnection().processControlCommand(c);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Connection处理对应的Command</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processControlCommand</span><span class="params">(Command c)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Similar trick to ChannelN.processAsync used here, except</span></span><br><span class="line">  <span class="comment">// we&#x27;re interested in whole-connection quiescing.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// See the detailed comments in ChannelN.processAsync.</span></span><br><span class="line"></span><br><span class="line">  Method method = c.getMethod();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isOpen()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (method <span class="keyword">instanceof</span> AMQP.Connection.Close) &#123;</span><br><span class="line">      handleConnectionClose(c);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method <span class="keyword">instanceof</span> AMQP.Connection.Blocked) &#123;</span><br><span class="line">      AMQP.Connection.Blocked blocked = (AMQP.Connection.Blocked) method;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BlockedListener l : <span class="keyword">this</span>.blockedListeners) &#123;</span><br><span class="line">          l.handleBlocked(blocked.getReason());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        getExceptionHandler().handleBlockedListenerException(<span class="keyword">this</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method <span class="keyword">instanceof</span> AMQP.Connection.Unblocked) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BlockedListener l : <span class="keyword">this</span>.blockedListeners) &#123;</span><br><span class="line">          l.handleUnblocked();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        getExceptionHandler().handleBlockedListenerException(<span class="keyword">this</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (method <span class="keyword">instanceof</span> AMQP.Connection.Close) &#123;</span><br><span class="line">      <span class="comment">// Already shutting down, so just send back a CloseOk.</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        _channel0.quiescingTransmit(<span class="keyword">new</span> AMQP.Connection.CloseOk.Builder().build());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ignored) &#123; &#125; <span class="comment">// ignore</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method <span class="keyword">instanceof</span> AMQP.Connection.CloseOk) &#123;</span><br><span class="line">      <span class="comment">// It&#x27;s our final &quot;RPC&quot;. Time to shut down.</span></span><br><span class="line">      _running = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// If Close was sent from within the MainLoop we</span></span><br><span class="line">      <span class="comment">// will not have a continuation to return to, so</span></span><br><span class="line">      <span class="comment">// we treat this as processed in that case.</span></span><br><span class="line">      <span class="keyword">return</span> !_channel0.isOutstandingRpc();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// Ignore all others.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Connection的start方法，核心逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">  initializeConsumerWorkService();</span><br><span class="line">  initializeHeartbeatSender();</span><br><span class="line">  <span class="keyword">this</span>._running = <span class="keyword">true</span>;</span><br><span class="line">  <span class="comment">// Make sure that the first thing we do is to send the header,</span></span><br><span class="line">  <span class="comment">// which should cause any socket errors to show up for us, rather</span></span><br><span class="line">  <span class="comment">// than risking them pop out in the MainLoop</span></span><br><span class="line">  AMQChannel.SimpleBlockingRpcContinuation connStartBlocker =</span><br><span class="line">    <span class="keyword">new</span> AMQChannel.SimpleBlockingRpcContinuation();</span><br><span class="line">  <span class="comment">// We enqueue an RPC continuation here without sending an RPC</span></span><br><span class="line">  <span class="comment">// request, since the protocol specifies that after sending</span></span><br><span class="line">  <span class="comment">// the version negotiation header, the client (connection</span></span><br><span class="line">  <span class="comment">// initiator) is to wait for a connection.start method to</span></span><br><span class="line">  <span class="comment">// arrive.</span></span><br><span class="line">  _channel0.enqueueRpc(connStartBlocker); <span class="comment">//TCP建立连接发送PRC配置信息Blocker</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// The following two lines are akin to AMQChannel&#x27;s</span></span><br><span class="line">    <span class="comment">// transmit() method for this pseudo-RPC.</span></span><br><span class="line">    _frameHandler.setTimeout(handshakeTimeout);</span><br><span class="line">    _frameHandler.sendHeader();<span class="comment">//第一步发送协议头，后续等待接受Connection.Start</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    _frameHandler.close();</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._frameHandler.initialize(<span class="keyword">this</span>); <span class="comment">//这里初始化frameHandler，这里就是个线程Runnable读取Frame</span></span><br><span class="line"></span><br><span class="line">  AMQP.Connection.Start connStart; <span class="comment">//Connection.Start</span></span><br><span class="line">  AMQP.Connection.Tune connTune = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    connStart =</span><br><span class="line">      (AMQP.Connection.Start) connStartBlocker.getReply(handshakeTimeout/<span class="number">2</span>).getMethod(); <span class="comment">//一直等待拿到服务端给的Connection.Start</span></span><br><span class="line"></span><br><span class="line">    _serverProperties = Collections.unmodifiableMap(connStart.getServerProperties());</span><br><span class="line"></span><br><span class="line">    Version serverVersion =</span><br><span class="line">      <span class="keyword">new</span> Version(connStart.getVersionMajor(),</span><br><span class="line">                  connStart.getVersionMinor());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Version.checkVersion(clientVersion, serverVersion)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolVersionMismatchException(clientVersion,</span><br><span class="line">                                                 serverVersion);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] mechanisms = connStart.getMechanisms().toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    SaslMechanism sm = <span class="keyword">this</span>.saslConfig.getSaslMechanism(mechanisms);</span><br><span class="line">    <span class="keyword">if</span> (sm == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;No compatible authentication mechanism found - &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;server offered [&quot;</span> + connStart.getMechanisms() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String username = credentialsProvider.getUsername();</span><br><span class="line">    String password = credentialsProvider.getPassword();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (credentialsProvider.getTimeBeforeExpiration() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.credentialsRefreshService == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Credentials can expire, a credentials refresh service should be set&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.credentialsRefreshService.isApproachingExpiration(credentialsProvider.getTimeBeforeExpiration())) &#123;</span><br><span class="line">        credentialsProvider.refresh();</span><br><span class="line">        username = credentialsProvider.getUsername();</span><br><span class="line">        password = credentialsProvider.getPassword();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LongString challenge = <span class="keyword">null</span>;</span><br><span class="line">    LongString response = sm.handleChallenge(<span class="keyword">null</span>, username, password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      Method method = (challenge == <span class="keyword">null</span>)</span><br><span class="line">        ? <span class="keyword">new</span> AMQP.Connection.StartOk.Builder() <span class="comment">//发送StartOK</span></span><br><span class="line">        .clientProperties(_clientProperties)</span><br><span class="line">        .mechanism(sm.getName())</span><br><span class="line">        .response(response)</span><br><span class="line">        .build()</span><br><span class="line">        : <span class="keyword">new</span> AMQP.Connection.SecureOk.Builder().response(response).build();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Method serverResponse = _channel0.rpc(method, handshakeTimeout/<span class="number">2</span>).getMethod(); <span class="comment">//回复StartOk</span></span><br><span class="line">        <span class="keyword">if</span> (serverResponse <span class="keyword">instanceof</span> AMQP.Connection.Tune) &#123; <span class="comment">//接受服务端响应ServerResponse,Tune配置信息</span></span><br><span class="line">          connTune = (AMQP.Connection.Tune) serverResponse;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          challenge = ((AMQP.Connection.Secure) serverResponse).getChallenge();</span><br><span class="line">          response = sm.handleChallenge(challenge, username, password);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ShutdownSignalException e) &#123;</span><br><span class="line">        Method shutdownMethod = e.getReason();</span><br><span class="line">        <span class="keyword">if</span> (shutdownMethod <span class="keyword">instanceof</span> AMQP.Connection.Close) &#123;</span><br><span class="line">          AMQP.Connection.Close shutdownClose = (AMQP.Connection.Close) shutdownMethod;</span><br><span class="line">          <span class="keyword">if</span> (shutdownClose.getReplyCode() == AMQP.ACCESS_REFUSED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationFailureException(shutdownClose.getReplyText());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PossibleAuthenticationFailureException(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (connTune == <span class="keyword">null</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (TimeoutException te) &#123;</span><br><span class="line">    _frameHandler.close();</span><br><span class="line">    <span class="keyword">throw</span> te;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ShutdownSignalException sse) &#123;</span><br><span class="line">    _frameHandler.close();</span><br><span class="line">    <span class="keyword">throw</span> AMQChannel.wrap(sse);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(IOException ioe) &#123;</span><br><span class="line">    _frameHandler.close();</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//处理Tune的配置信息</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> negotiatedChannelMax =</span><br><span class="line">      negotiateChannelMax(<span class="keyword">this</span>.requestedChannelMax,</span><br><span class="line">                          connTune.getChannelMax());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> channelMax = ConnectionFactory.ensureUnsignedShort(negotiatedChannelMax);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (channelMax != negotiatedChannelMax) &#123;</span><br><span class="line">      LOGGER.warn(<span class="string">&quot;Channel max must be between 0 and &#123;&#125;, value has been set to &#123;&#125; instead of &#123;&#125;&quot;</span>,</span><br><span class="line">                  MAX_UNSIGNED_SHORT, channelMax, negotiatedChannelMax);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _channelManager = instantiateChannelManager(channelMax, threadFactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> frameMax =</span><br><span class="line">      negotiatedMaxValue(<span class="keyword">this</span>.requestedFrameMax,</span><br><span class="line">                         connTune.getFrameMax());</span><br><span class="line">    <span class="keyword">this</span>._frameMax = frameMax;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> negotiatedHeartbeat =</span><br><span class="line">      negotiatedMaxValue(<span class="keyword">this</span>.requestedHeartbeat,</span><br><span class="line">                         connTune.getHeartbeat());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> heartbeat = ConnectionFactory.ensureUnsignedShort(negotiatedHeartbeat);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (heartbeat != negotiatedHeartbeat) &#123;</span><br><span class="line">      LOGGER.warn(<span class="string">&quot;Heartbeat must be between 0 and &#123;&#125;, value has been set to &#123;&#125; instead of &#123;&#125;&quot;</span>,</span><br><span class="line">                  MAX_UNSIGNED_SHORT, heartbeat, negotiatedHeartbeat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setHeartbeat(heartbeat);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.connectionInfo = <span class="keyword">new</span> DefaultConnectionInfo(</span><br><span class="line">      <span class="keyword">this</span>._frameHandler.getAddress().getHostAddress(),</span><br><span class="line">      <span class="keyword">this</span>._frameHandler.getPort()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    _channel0.transmit(<span class="keyword">new</span> AMQP.Connection.TuneOk.Builder()</span><br><span class="line">                       .channelMax(channelMax)</span><br><span class="line">                       .frameMax(frameMax)</span><br><span class="line">                       .heartbeat(heartbeat)</span><br><span class="line">                       .build());</span><br><span class="line">    _channel0.exnWrappingRpc(<span class="keyword">new</span> AMQP.Connection.Open.Builder()</span><br><span class="line">                             .virtualHost(_virtualHost)</span><br><span class="line">                             .build());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    _heartbeatSender.shutdown();</span><br><span class="line">    _frameHandler.close();</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ShutdownSignalException sse) &#123;</span><br><span class="line">    _heartbeatSender.shutdown();</span><br><span class="line">    _frameHandler.close();</span><br><span class="line">    <span class="keyword">throw</span> AMQChannel.wrap(sse);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.credentialsProvider.getTimeBeforeExpiration() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String registrationId = <span class="keyword">this</span>.credentialsRefreshService.register(credentialsProvider, () -&gt; &#123;</span><br><span class="line">      <span class="comment">// return false if connection is closed, so refresh service can get rid of this registration</span></span><br><span class="line">      <span class="keyword">if</span> (!isOpen()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>._inConnectionNegotiation) &#123;</span><br><span class="line">        <span class="comment">// this should not happen</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      String refreshedPassword = credentialsProvider.getPassword();</span><br><span class="line"></span><br><span class="line">      UpdateSecretExtension.UpdateSecret updateSecret = <span class="keyword">new</span> UpdateSecretExtension.UpdateSecret(</span><br><span class="line">        LongStringHelper.asLongString(refreshedPassword), <span class="string">&quot;Refresh scheduled by client&quot;</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        _channel0.rpc(updateSecret);<span class="comment">//Secret相关信息</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (ShutdownSignalException e) &#123;</span><br><span class="line">        LOGGER.warn(<span class="string">&quot;Error while trying to update secret: &#123;&#125;. Connection has been closed.&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    addShutdownListener(sse -&gt; <span class="keyword">this</span>.credentialsRefreshService.unregister(<span class="keyword">this</span>.credentialsProvider, registrationId));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We can now respond to errors having finished tailoring the connection</span></span><br><span class="line">  <span class="keyword">this</span>._inConnectionNegotiation = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SocketFrameHandler执行startMainLoop，初始化MainLoop死循环线程，读取frame</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startMainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  MainLoop loop = <span class="keyword">new</span> MainLoop();</span><br><span class="line">  String name = <span class="string">&quot;AMQP Connection &quot;</span> + <span class="keyword">this</span>.getHostAddress() + <span class="string">&quot;:&quot;</span> + <span class="keyword">this</span>.getPort();</span><br><span class="line">  <span class="keyword">this</span>.mainLoopThread = Environment.newThread(<span class="keyword">this</span>.threadFactory, loop, name);</span><br><span class="line">  <span class="keyword">this</span>.ioLoopThread(<span class="keyword">this</span>.mainLoopThread);</span><br><span class="line">  <span class="keyword">this</span>.mainLoopThread.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//死循环线程，读取frame，处理frame</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MainLoop</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">MainLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> shouldDoFinalShutdown = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span>(AMQConnection.<span class="keyword">this</span>._running) &#123;</span><br><span class="line">        Frame frame = AMQConnection.<span class="keyword">this</span>._frameHandler.readFrame();<span class="comment">//从IO读取Frame</span></span><br><span class="line">        AMQConnection.<span class="keyword">this</span>.readFrame(frame); <span class="comment">//处理Frame</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">      <span class="keyword">if</span> (var6 <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">        shouldDoFinalShutdown = <span class="keyword">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        AMQConnection.<span class="keyword">this</span>.handleFailure(var6);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldDoFinalShutdown) &#123;</span><br><span class="line">        AMQConnection.<span class="keyword">this</span>.doFinalShutdown();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理Frame</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readFrame</span><span class="params">(Frame frame)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (frame != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>._missedHeartbeats = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (frame.type != <span class="number">8</span>) &#123; <span class="comment">//FRAME_HEARTBEAT = 8;非心跳</span></span><br><span class="line">      <span class="keyword">if</span> (frame.channel == <span class="number">0</span>) &#123; <span class="comment">//多路复用，根据channel_id确认，具体channel处理，Connetion的channel0处理</span></span><br><span class="line">        <span class="keyword">this</span>._channel0.handleFrame(frame);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.isOpen()) &#123;<span class="comment">//ChannelManager处理</span></span><br><span class="line">        ChannelManager cm = <span class="keyword">this</span>._channelManager;</span><br><span class="line">        <span class="keyword">if</span> (cm != <span class="keyword">null</span>) &#123;</span><br><span class="line">          ChannelN channel;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            channel = cm.getChannel(frame.channel);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (UnknownChannelException var5) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Received a frame on an unknown channel, ignoring it&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          channel.handleFrame(frame);<span class="comment">//channel处理Frame</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Socket timeout waiting for a frame.</span></span><br><span class="line">    <span class="comment">// Maybe missed heartbeat.</span></span><br><span class="line">    <span class="keyword">this</span>.handleSocketTimeout();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用Command处理Frame</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFrame</span><span class="params">(Frame frame)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  AMQCommand command = _command;</span><br><span class="line">  <span class="keyword">if</span> (command.handleFrame(frame)) &#123; <span class="comment">// a complete command has rolled off the assembly line</span></span><br><span class="line">    _command = <span class="keyword">new</span> AMQCommand(<span class="keyword">this</span>.maxInboundMessageBodySize); <span class="comment">// prepare for the next one</span></span><br><span class="line">    handleCompleteInboundCommand(command);<span class="comment">//处理逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用processAsync处理Command</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCompleteInboundCommand</span><span class="params">(AMQCommand command)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// First, offer the command to the asynchronous-command</span></span><br><span class="line">  <span class="comment">// handling mechanism, which gets to act as a filter on the</span></span><br><span class="line">  <span class="comment">// incoming command stream.  If processAsync() returns true,</span></span><br><span class="line">  <span class="comment">// the command has been dealt with by the filter and so should</span></span><br><span class="line">  <span class="comment">// not be processed further.  It will return true for</span></span><br><span class="line">  <span class="comment">// asynchronous commands (deliveries/returns/other events),</span></span><br><span class="line">  <span class="comment">// and false for commands that should be passed on to some</span></span><br><span class="line">  <span class="comment">// waiting RPC continuation.</span></span><br><span class="line">  <span class="keyword">this</span>._trafficListener.read(command);</span><br><span class="line">  <span class="keyword">if</span> (!processAsync(command)) &#123;</span><br><span class="line">    <span class="comment">// The filter decided not to handle/consume the command,</span></span><br><span class="line">    <span class="comment">// so it must be a response to an earlier RPC.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_checkRpcResponseType) &#123;</span><br><span class="line">      _channelLock.lock();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// check if this reply command is intended for the current waiting request before calling nextOutstandingRpc()</span></span><br><span class="line">        <span class="keyword">if</span> (_activeRpc != <span class="keyword">null</span> &amp;&amp; !_activeRpc.canHandleReply(command)) &#123;</span><br><span class="line">          <span class="comment">// this reply command is not intended for the current waiting request</span></span><br><span class="line">          <span class="comment">// most likely a previous request timed out and this command is the reply for that.</span></span><br><span class="line">          <span class="comment">// Throw this reply command away so we don&#x27;t stop the current request from waiting for its reply</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        _channelLock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> RpcWrapper nextOutstandingRpc = nextOutstandingRpc();</span><br><span class="line">    <span class="comment">// the outstanding RPC can be null when calling Channel#asyncRpc</span></span><br><span class="line">    <span class="keyword">if</span>(nextOutstandingRpc != <span class="keyword">null</span>) &#123;</span><br><span class="line">      nextOutstandingRpc.complete(command);</span><br><span class="line">      markRpcFinished();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.impl.SocketFrameHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketFrameHandler</span> <span class="keyword">implements</span> <span class="title">FrameHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(AMQConnection connection)</span> </span>&#123;</span><br><span class="line">    connection.startMainLoop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Frame <span class="title">readFrame</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    _inputStreamLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Frame.readFrom(_inputStream, <span class="keyword">this</span>.maxInboundMessageBodySize);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      _inputStreamLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    sendHeader(AMQP.PROTOCOL.MAJOR, AMQP.PROTOCOL.MINOR, AMQP.PROTOCOL.REVISION);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._socket <span class="keyword">instanceof</span> SSLSocket) &#123;</span><br><span class="line">      TlsUtils.logPeerCertificateInfo(((SSLSocket) <span class="keyword">this</span>._socket).getSession());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendHeader</span><span class="params">(<span class="keyword">int</span> major, <span class="keyword">int</span> minor, <span class="keyword">int</span> revision)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    _outputStreamLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      _outputStream.write(<span class="string">&quot;AMQP&quot;</span>.getBytes(<span class="string">&quot;US-ASCII&quot;</span>));</span><br><span class="line">      _outputStream.write(<span class="number">0</span>);</span><br><span class="line">      _outputStream.write(major);</span><br><span class="line">      _outputStream.write(minor);</span><br><span class="line">      _outputStream.write(revision);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        _outputStream.flush();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SSLHandshakeException e) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">&quot;TLS connection failed: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      _outputStreamLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中com.rabbitmq.client.impl.AMQConnection实现的createChannel方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.rabbitmq.client.impl.AMQConnection</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Channel <span class="title">createChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ensureIsOpen();</span><br><span class="line">  ChannelManager cm = _channelManager; <span class="comment">//1 ChannelManager负责管理Channel的生命周期，并持有Channel的引用	</span></span><br><span class="line">  <span class="keyword">if</span> (cm == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  Channel channel = cm.createChannel(<span class="keyword">this</span>);<span class="comment">//2 直接创建channel</span></span><br><span class="line">  <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</span><br><span class="line">    metricsCollector.newChannel(channel);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> channel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol">https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol</a></p>
<p><a target="_blank" rel="noopener" href="https://www.amqp.org/">https://www.amqp.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/">https://www.rabbitmq.com/</a></p>
<p>《深入rabbitmq》–rabbitmq in depth</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/28/mysql%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/28/mysql%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2/" class="post-title-link" itemprop="url">mysql源码分析(2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-07-28 20:52:31" itemprop="dateCreated datePublished" datetime="2024-07-28T20:52:31+08:00">2024-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-01 21:24:09" itemprop="dateModified" datetime="2024-08-01T21:24:09+08:00">2024-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、源码目录结构"><a href="#一、源码目录结构" class="headerlink" title="一、源码目录结构"></a>一、源码目录结构</h1><p>以下均以mysql-9.0.1源码为基础</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801101127618.png" alt="image-20240801101127618"></p>
<p>其中，各个目录的作用，以下为简单描述：</p>
<blockquote>
<blockquote>
<p>client: 客户端工具，包括mysql、mysqladmin、mysqlbinlog、mysqldump等。<br>cmake: cmake编译脚本<br>components: 组件工具<br>Docs: 文档文件夹<br>doxyen_resources: doxyen工具相关资源<br>extra: 引入的其它包，比如boost、curl、zlib等。<br>include: 源码用的相关的头文件放置的文件夹，但不包括存储引擎的头文件。<br>libbinlogevents: 解析binlog的lib库。<br>libchangestreams: 实时同步数据流的lib库<br>libmysql: 可嵌入mysql的lib库<br>libs: mysql其他lib库<br>libservices: 动态服务插件的lib库<br>man: man帮助文档<br>mysql-test :mysqld测试工具集<br>mysys: mysql自己实现的数据结构和基本算法，比如数组、链表等。<br>packaging: 打包相关<br>plugin: 插件管理。<br>router: 集群路由<br>scripts: 系统工具运行的脚本。<br>share: 共享信息，err和字符集<br><strong>sql: 服务端的主要代码，包括main函数。</strong><br>sql-common: 服务端和客户端通用的一些代码。<br><strong>storage: 存储引擎相关文件。</strong><br>strings: 字符串库<br>support-files: 编译所需文件的工具。<br>testclients: 客户框架测试。<br>unittest: 单元测试，这个搞程序的都知道。<br>utilities: 公用的工具<br>vio: 虚拟网络IO，不同平台或不同协议的网络通信API的二次封装。</p>
</blockquote>
</blockquote>
<p>其中，sql和stroage目录为主要逻辑。</p>
<h1 id="二、DEBUG源码"><a href="#二、DEBUG源码" class="headerlink" title="二、DEBUG源码"></a>二、DEBUG源码</h1><h2 id="1、依赖"><a href="#1、依赖" class="headerlink" title="1、依赖"></a>1、依赖</h2><ul>
<li>mysql源码</li>
<li>Clion</li>
<li>cmake</li>
</ul>
<h1 id="2、下载源码"><a href="#2、下载源码" class="headerlink" title="2、下载源码"></a>2、下载源码</h1><p>git clone代码到本地：<a target="_blank" rel="noopener" href="https://github.com/mysql/mysql-server%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8root%E6%A0%B9%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95cmake-build-debug%EF%BC%8C%E5%B9%B6%E5%88%9B%E5%BB%BA%E5%AD%90%E7%9B%AE%E5%BD%95data%E3%80%81etc%E3%80%82">https://github.com/mysql/mysql-server，然后在root根目录，创建目录cmake-build-debug，并创建子目录data、etc。</a></p>
<h1 id="3、配置Clion-cmake"><a href="#3、配置Clion-cmake" class="headerlink" title="3、配置Clion cmake"></a>3、配置Clion cmake</h1><p>Clion&gt;Settings&gt;Build,Execution,Deployment&gt;Toolchains，这里使用Clion默认的cmake，前提是系统安装cmake，mac使用的brew install cmake。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801114537742.png" alt="image-20240801114537742"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801114931448.png" alt="image-20240801114931448"></p>
<p>CMake options 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-DWITH_DEBUG=1                     # 开启DEBUG模式</span><br><span class="line">-DDOWNLOAD_BOOST=1                 # boost不存在时自动下载</span><br><span class="line">-DDOWNLOAD_BOOST_TIMEOUT=60000     # 下载boost的超时时间</span><br><span class="line">-DWITH_BOOST=boost                 # boost目录，不存在时会自动下载到该目录</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=build_out   # MySQL安装目录，可在启动时指定`--basedir`覆盖</span><br><span class="line">-DMYSQL_DATADIR=build_out/data     # MySQL数据目录，可在启动时指定`--datadir`覆盖</span><br><span class="line">-DSYSCONFDIR=build_out/etc         # `my.cnf`默认目录，可在启动时指定`--defaults-file=file_name`覆盖</span><br><span class="line">-DMYSQL_TCP_PORT=3307              # 如果本机已安装过MySQL，避免冲突换个别的</span><br><span class="line">-DMYSQL_UNIX_ADDR=mysql-debug.sock # 默认/tmp/mysql.sock，避免冲突，此处相对与`--datadir`目录会自动创建</span><br></pre></td></tr></table></figure>

<h2 id="4、运行cmake"><a href="#4、运行cmake" class="headerlink" title="4、运行cmake"></a>4、运行cmake</h2><p>执行完后，cmake窗口输出如下内容表示执行成功</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801135417628.png" alt="image-20240801135417628"></p>
<h2 id="5、编译mysqld"><a href="#5、编译mysqld" class="headerlink" title="5、编译mysqld"></a>5、编译mysqld</h2><p>在Clion的build中，选中mysqld，然后选中并编辑配置<code>--initialize-insecure</code> ，初始化配置，并在cmake-build-debug/data目录，完成数据初始化</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801135915918.png" alt="image-20240801135915918"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801151712805.png" alt="image-20240801151712805"></p>
<p>初始化后，输出如下内容，并在data目录生成mysql的数据</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801161758897.png" alt="image-20240801161758897"></p>
<p>此时，MySQL 已自动创建一个 <code>root@localhost</code> 账号，密码为空</p>
<p>再将 <code>Program arguments</code> 配置中的 <code>--initialize-insecure</code> <strong>删除</strong></p>
<p>因为初始化只需执行一次，后续的执行或 Debug 都会用到这里的配置，不删除就会报错。</p>
<h2 id="6、DEBUG代码"><a href="#6、DEBUG代码" class="headerlink" title="6、DEBUG代码"></a>6、DEBUG代码</h2><p>此时，可以使用工具连接mysql，执行SQL，然后DEBUG断点mysql server端的代码。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801161909631.png" alt="image-20240801161909631"></p>
<p>比如执行个简单的select SQL：</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240801153408827.png" alt="image-20240801153408827"></p>
<p>![image-20240801153131710](/Users/zhanhao/Library/Application Support/typora-user-images/image-20240801153131710.png)</p>
<h1 id="三、mysqld启动主流程"><a href="#三、mysqld启动主流程" class="headerlink" title="三、mysqld启动主流程"></a>三、mysqld启动主流程</h1><p>mysql 源代码，压缩后zip都有几百MB ，文件数量又是个天文数字。我们如何DEBUG，mysql的第一行代码在哪里呢？</p>
<p>mysql是 C++ 程序，它的入口函数是 main 。也就是说只要在 main 函数上打断点，就能直接找到mysql 服务端启动后的第一行代码了。</p>
<p>main函数的入口，在sql\main.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#sql\main.cc</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mysqld_main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">mysqld_main</span>(argc, argv); &#125;</span><br></pre></td></tr></table></figure>

<p>mysqld_main的核心逻辑是:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init_server_components（）  <span class="comment">/* 初始化系统模块，比如MDL、存储引擎、慢查询日志、binlog */</span></span><br><span class="line"><span class="built_in">network_init</span>() <span class="comment">/* 初始化网络 */</span></span><br><span class="line"><span class="built_in">start_handle_manager</span>(); <span class="comment">/* 启动连接管理器，创建 handle_manager 线程 */</span></span><br></pre></td></tr></table></figure>

<p>以下为mysqld_main的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#sql\mysqld.cc，启动主流程比较复杂，有1000行代码，不过mysql的代码注释还是比较清晰和容易理解</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mysqld_main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">initialize_stack_direction</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Substitute the full path to the executable in argv[0]</span></span><br><span class="line">  <span class="built_in">substitute_progpath</span>(argv);</span><br><span class="line">  sysd::<span class="built_in">notify_connect</span>();</span><br><span class="line">  sysd::<span class="built_in">notify</span>(<span class="string">&quot;STATUS=Server startup in progress\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Perform basic thread library and malloc initialization,</span></span><br><span class="line"><span class="comment">    to be able to read defaults files and parse options.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  my_progname = argv[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">calculate_mysql_home_from_my_progname</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> _WIN32</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> WITH_PERFSCHEMA_STORAGE_ENGINE</span></span><br><span class="line">  <span class="built_in">pre_initialize_performance_schema</span>();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/*WITH_PERFSCHEMA_STORAGE_ENGINE */</span></span></span><br><span class="line">  <span class="comment">// For windows, my_init() is called from the win specific mysqld_main</span></span><br><span class="line">  <span class="comment">/* 初始化mysys lib和pthread */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">my_init</span>())  <span class="comment">// init my_sys library &amp; pthreads</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_MYINIT_FAILED);</span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _WIN32 */</span></span></span><br><span class="line"></span><br><span class="line">  orig_argc = argc;</span><br><span class="line">  orig_argv = argv;</span><br><span class="line">  my_getopt_use_args_separator = <span class="literal">true</span>;</span><br><span class="line">  my_defaults_read_login_file = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">/* 加载和处理配置文件my.cnf以及启动参数 */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">load_defaults</span>(MYSQL_CONFIG_NAME, load_default_groups, &amp;argc, &amp;argv,</span><br><span class="line">                    &amp;argv_alloc)) &#123;</span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  argc_cached = argc;</span><br><span class="line">  argv_cached = <span class="built_in"><span class="keyword">new</span></span> (&amp;argv_alloc) <span class="keyword">char</span> *[argc_cached + <span class="number">1</span>];</span><br><span class="line">  <span class="built_in">memcpy</span>(argv_cached, argv, argc_cached * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">char</span> *));</span><br><span class="line">  argv_cached[argc_cached] = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set data dir directory paths */</span></span><br><span class="line">  <span class="built_in">strmake</span>(mysql_real_data_home, <span class="built_in">get_relative_path</span>(MYSQL_DATADIR),</span><br><span class="line">          <span class="built_in"><span class="keyword">sizeof</span></span>(mysql_real_data_home) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Must be initialized early for comparison of options name */</span></span><br><span class="line">  system_charset_info = &amp;my_charset_utf8mb3_general_ci;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Write mysys error messages to the error log. */</span></span><br><span class="line">  local_message_hook = error_log_print;</span><br><span class="line">  <span class="comment">/* 初始化系统变量 */</span></span><br><span class="line">  <span class="built_in">sys_var_init</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  <span class="keyword">if</span> (mysys::<span class="built_in">is_my_malloc_using_jemalloc</span>()) &#123;</span><br><span class="line">    <span class="built_in">LogErr</span>(INFORMATION_LEVEL, ER_MY_MALLOC_USING_JEMALLOC);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;msg : mysys::<span class="built_in">fetch_jemalloc_initialization_messages</span>()) &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(msg.m_severity, ER_MY_MALLOC_USING_JEMALLOC + msg.m_ecode,</span><br><span class="line">             msg.m_message.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   Initialize variables cache for persisted variables, load persisted</span></span><br><span class="line"><span class="comment">   config file and append parse early  read only persisted variables</span></span><br><span class="line"><span class="comment">   to command line options if present.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">bool</span> arg_separator_added = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (persisted_variables_cache.<span class="built_in">init</span>(&amp;argc, &amp;argv) ||</span><br><span class="line">      persisted_variables_cache.<span class="built_in">load_persist_file</span>() ||</span><br><span class="line">      persisted_variables_cache.<span class="built_in">append_parse_early_variables</span>(</span><br><span class="line">        &amp;argc, &amp;argv, arg_separator_added)) &#123;</span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  remaining_argc = argc;</span><br><span class="line">  remaining_argv = argv;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init_variable_default_paths</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> heo_error;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> WITH_PERFSCHEMA_STORAGE_ENGINE</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Initialize the array of performance schema instrument configurations.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">init_pfs_instrument_array</span>();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_PERFSCHEMA_STORAGE_ENGINE */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 处理早期就会被使用到的EARLY系统变量 */</span></span><br><span class="line">  heo_error = <span class="built_in">handle_early_options</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// this is to prevent mtr from accidentally printing this log when it runs</span></span><br><span class="line">  <span class="comment">// mysqld with --verbose --help to extract version info and variable values</span></span><br><span class="line">  <span class="comment">// and when mysqld is run with --validate-config option</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_help_or_validate_option</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (opt_initialize) &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(SYSTEM_LEVEL, ER_SRV_INIT_START);</span><br><span class="line">      sysd::<span class="built_in">notify</span>(<span class="string">&quot;STATUS=Server initialization in progress\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(SYSTEM_LEVEL, ER_SRV_START);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">init_sql_statement_names</span>();</span><br><span class="line">  ulong requested_open_files = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  Init error log subsystem. This does not actually open the log yet.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">init_error_log</span>()) <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">  <span class="keyword">if</span> (!opt_validate_config) <span class="built_in">adjust_related_options</span>(&amp;requested_open_files);</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> WITH_PERFSCHEMA_STORAGE_ENGINE</span></span><br><span class="line">  <span class="keyword">if</span> (heo_error == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">is_help_or_validate_option</span>() &amp;&amp; !opt_initialize) &#123;</span><br><span class="line">      <span class="keyword">int</span> pfs_rc;</span><br><span class="line">      <span class="comment">/* Add sizing hints from the server sizing parameters. */</span></span><br><span class="line">      pfs_param.m_hints.m_table_definition_cache = table_def_size;</span><br><span class="line">      pfs_param.m_hints.m_table_open_cache = table_cache_size;</span><br><span class="line">      pfs_param.m_hints.m_max_connections = max_connections;</span><br><span class="line">      pfs_param.m_hints.m_open_files_limit = requested_open_files;</span><br><span class="line">      pfs_param.m_hints.m_max_prepared_stmt_count = max_prepared_stmt_count;</span><br><span class="line"></span><br><span class="line">      pfs_rc = <span class="built_in">initialize_performance_schema</span>(</span><br><span class="line">        &amp;pfs_param, &amp;psi_thread_hook, &amp;psi_mutex_hook, &amp;psi_rwlock_hook,</span><br><span class="line">        &amp;psi_cond_hook, &amp;psi_file_hook, &amp;psi_socket_hook, &amp;psi_table_hook,</span><br><span class="line">        &amp;psi_mdl_hook, &amp;psi_idle_hook, &amp;psi_stage_hook, &amp;psi_statement_hook,</span><br><span class="line">        &amp;psi_transaction_hook, &amp;psi_memory_hook, &amp;psi_error_hook,</span><br><span class="line">        &amp;psi_data_lock_hook, &amp;psi_system_hook, &amp;psi_tls_channel_hook,</span><br><span class="line">        &amp;psi_metric_hook);</span><br><span class="line">      <span class="keyword">if</span> ((pfs_rc != <span class="number">0</span>) &amp;&amp; pfs_param.m_enabled) &#123;</span><br><span class="line">        pfs_param.m_enabled = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">LogErr</span>(WARNING_LEVEL, ER_PERFSCHEMA_INIT_FAILED);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_PERFSCHEMA_STORAGE_ENGINE */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> WITH_LOCK_ORDER</span></span><br><span class="line">  <span class="keyword">if</span> (heo_error == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lo_param.m_enabled &amp;&amp; !opt_help &amp;&amp; !opt_initialize) &#123;</span><br><span class="line">      <span class="keyword">int</span> lo_rc;</span><br><span class="line">      lo_rc = <span class="built_in">LO_init</span>(&amp;lo_param, &amp;psi_thread_hook, &amp;psi_mutex_hook,</span><br><span class="line">                      &amp;psi_rwlock_hook, &amp;psi_cond_hook, &amp;psi_file_hook,</span><br><span class="line">                      &amp;psi_socket_hook, &amp;psi_table_hook, &amp;psi_mdl_hook,</span><br><span class="line">                      &amp;psi_idle_hook, &amp;psi_stage_hook, &amp;psi_statement_hook,</span><br><span class="line">                      &amp;psi_transaction_hook, &amp;psi_memory_hook);</span><br><span class="line">      <span class="keyword">if</span> (lo_rc != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LogErr</span>(WARNING_LEVEL, ER_LOCK_ORDER_INIT_FAILED);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_LOCK_ORDER */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Other provider of the instrumentation interface should</span></span><br><span class="line"><span class="comment">    initialize PSI_hook here:</span></span><br><span class="line"><span class="comment">    - HAVE_PSI_INTERFACE is for the instrumentation interface</span></span><br><span class="line"><span class="comment">    - WITH_PERFSCHEMA_STORAGE_ENGINE is for one implementation</span></span><br><span class="line"><span class="comment">      of the interface,</span></span><br><span class="line"><span class="comment">    but there could be alternate implementations, which is why</span></span><br><span class="line"><span class="comment">    these two defines are kept separate.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_PSI_INTERFACE</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Obtain the current performance schema instrumentation interface,</span></span><br><span class="line"><span class="comment">    if available.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *service;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_thread_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_thread_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_THREAD_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_thread_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_mutex_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_mutex_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_MUTEX_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_mutex_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_rwlock_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_rwlock_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_RWLOCK_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_rwlock_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_cond_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_cond_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_COND_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_cond_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_file_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_file_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_FILE_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_file_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_socket_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_socket_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_SOCKET_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_socket_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_table_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_table_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_TABLE_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_table_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_mdl_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_mdl_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_MDL_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_mdl_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_idle_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_idle_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_IDLE_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_idle_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_stage_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_stage_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_STAGE_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_stage_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_statement_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_statement_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_STATEMENT_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_statement_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_transaction_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service =</span><br><span class="line">      psi_transaction_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_TRANSACTION_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_transaction_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_memory_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_memory_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_MEMORY_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_memory_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_error_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_error_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_ERROR_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_error_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_data_lock_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_data_lock_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_DATA_LOCK_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_data_lock_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_system_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_system_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_SYSTEM_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_system_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_tls_channel_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service =</span><br><span class="line">      psi_tls_channel_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_TLS_CHANNEL_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_tls_channel_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (psi_metric_hook != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    service = psi_metric_hook-&gt;<span class="built_in">get_interface</span>(PSI_CURRENT_METRIC_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">set_psi_metric_service</span>(service);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Now that we have parsed the command line arguments, and have initialized</span></span><br><span class="line"><span class="comment">    the performance schema itself, the next step is to register all the</span></span><br><span class="line"><span class="comment">    server instruments.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">init_server_psi_keys</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Now that some instrumentation is in place,</span></span><br><span class="line"><span class="comment">    recreate objects which were initialised early,</span></span><br><span class="line"><span class="comment">    so that they are instrumented as well.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">my_thread_global_reinit</span>();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_PSI_INTERFACE */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* This limits ability to configure SSL library through config options */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">init_ssl</span>()) &#123;</span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="built_in">exit</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set umask as early as possible */</span></span><br><span class="line">  <span class="built_in">umask</span>(((~my_umask) &amp; <span class="number">0666</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Initialize Components core subsystem early on, once we have PSI, which it</span></span><br><span class="line"><span class="comment">    uses. This part doesn&#x27;t use any more MySQL-specific functionalities but</span></span><br><span class="line"><span class="comment">    error logging and PFS.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">component_infrastructure_init</span>()) &#123;</span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* Must be initialized early because it is required by dynamic loader */</span></span><br><span class="line">    files_charset_info = &amp;my_charset_utf8mb3_general_ci;</span><br><span class="line">    <span class="keyword">auto</span> keyring_helper = std::make_unique&lt;Manifest_file_option_parser_helper&gt;(</span><br><span class="line">      remaining_argc, remaining_argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (keyring_helper-&gt;<span class="built_in">valid</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">initialize_manifest_file_components</span>()) &#123;</span><br><span class="line">      <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If keyring component was loaded through manifest file, services provided</span></span><br><span class="line"><span class="comment">      by such a component should get priority over keyring plugin. That&#x27;s why</span></span><br><span class="line"><span class="comment">      we have to set defaults before proxy keyring services are loaded.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">set_srv_keyring_implementation_as_default</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Append read only persisted variables to command line now.</span></span><br><span class="line"><span class="comment">    Note that if arg separator is already added, it will not</span></span><br><span class="line"><span class="comment">    be added again.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (persisted_variables_cache.<span class="built_in">append_read_only_variables</span>(</span><br><span class="line">    &amp;remaining_argc, &amp;remaining_argv, arg_separator_added, <span class="literal">false</span>)) &#123;</span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  my_getopt_use_args_separator = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the resource group subsystem.</span></span><br><span class="line">  <span class="keyword">auto</span> res_grp_mgr = resourcegroups::Resource_group_mgr::<span class="built_in">instance</span>();</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_help_or_validate_option</span>() &amp;&amp; !opt_initialize) &#123;</span><br><span class="line">    <span class="keyword">if</span> (res_grp_mgr-&gt;<span class="built_in">init</span>()) &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_RESOURCE_GROUP_SUBSYSTEM_INIT_FAILED);</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_PSI_THREAD_INTERFACE</span></span><br><span class="line">  <span class="comment">/* Instrument the main thread */</span></span><br><span class="line">  PSI_thread *psi = <span class="built_in">PSI_THREAD_CALL</span>(new_thread)(key_thread_main, <span class="number">0</span>, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">PSI_THREAD_CALL</span>(set_thread_os_id)(psi);</span><br><span class="line">  <span class="built_in">PSI_THREAD_CALL</span>(set_thread)(psi);</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_PSI_THREAD_INTERFACE */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Initialize audit interface globals. Audit plugins are inited later. */</span></span><br><span class="line">  <span class="built_in">mysql_audit_initialize</span>();</span><br><span class="line"></span><br><span class="line">  Srv_session::<span class="built_in">module_init</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Perform basic query log initialization. Should be called after</span></span><br><span class="line"><span class="comment">    MY_INIT, as it initializes mutexes.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  query_logger.<span class="built_in">init</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (heo_error) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Parsing command line option failed,</span></span><br><span class="line"><span class="comment">      Since we don&#x27;t have a workable remaining_argc/remaining_argv</span></span><br><span class="line"><span class="comment">      to continue the server initialization, this is as far as this</span></span><br><span class="line"><span class="comment">      code can go.</span></span><br><span class="line"><span class="comment">      This is the best effort to log meaningful messages:</span></span><br><span class="line"><span class="comment">      - messages will be printed to stderr, which is not redirected yet,</span></span><br><span class="line"><span class="comment">      - messages will be printed in the NT event log, for windows.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Not enough initializations for unireg_abort()</span></span><br><span class="line"><span class="comment">      Using exit() for windows.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">exit</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 初始化系统变量 */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">init_common_variables</span>()) &#123;</span><br><span class="line">    <span class="built_in">setup_error_log</span>();</span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);  <span class="comment">// Will do exit</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">keyring_lockable_init</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 初始化信号系统 */</span></span><br><span class="line">  <span class="built_in">my_init_signals</span>();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Install server&#x27;s my_abort routine to assure my_aborts prints signal info</span></span><br><span class="line"><span class="comment">    sequentially without sudden termination.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">set_my_abort</span>(my_server_abort);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> guardize = <span class="number">0</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> _WIN32</span></span><br><span class="line">  <span class="keyword">int</span> retval = <span class="built_in">pthread_attr_getguardsize</span>(&amp;connection_attrib, &amp;guardize);</span><br><span class="line">  <span class="built_in">assert</span>(retval == <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (retval != <span class="number">0</span>) guardize = my_thread_stack_size;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined(__ia64__) || defined(__ia64)</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Peculiar things with ia64 platforms - it seems we only have half the</span></span><br><span class="line"><span class="comment">    stack size in reality, so we have to double it here</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  guardize = my_thread_stack_size;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">my_thread_attr_setstacksize</span>(&amp;connection_attrib,</span><br><span class="line">                                       my_thread_stack_size + guardize)) &#123;</span><br><span class="line">    <span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* Retrieve used stack size;  Needed for checking stack overflows */</span></span><br><span class="line">    <span class="keyword">size_t</span> stack_size = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">my_thread_attr_getstacksize</span>(&amp;connection_attrib, &amp;stack_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We must check if stack_size = 0 as Solaris 2.9 can return 0 here */</span></span><br><span class="line">    <span class="keyword">if</span> (stack_size &amp;&amp; stack_size &lt; (my_thread_stack_size + guardize)) &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(WARNING_LEVEL, ER_STACKSIZE_UNEXPECTED,</span><br><span class="line">             my_thread_stack_size + guardize, (<span class="keyword">long</span>)stack_size);</span><br><span class="line">      <span class="meta">#<span class="meta-keyword">if</span> defined(__ia64__) || defined(__ia64)</span></span><br><span class="line">      my_thread_stack_size = stack_size / <span class="number">2</span>;</span><br><span class="line">      <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">      my_thread_stack_size = <span class="keyword">static_cast</span>&lt;ulong&gt;(stack_size - guardize);</span><br><span class="line">      <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> NDEBUG</span></span><br><span class="line">  <span class="built_in">test_lc_time_sz</span>();</span><br><span class="line">  <span class="built_in">srand</span>(<span class="keyword">static_cast</span>&lt;uint&gt;(<span class="built_in">time</span>(<span class="literal">nullptr</span>)));</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> !defined(_WIN32)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_initialize &amp;&amp; opt_daemonize) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Initialize and daemon options are incompatible.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_daemonize &amp;&amp; log_error_dest == disabled_my_option &amp;&amp;</span><br><span class="line">      (<span class="built_in">isatty</span>(STDOUT_FILENO) || <span class="built_in">isatty</span>(STDERR_FILENO))) &#123;</span><br><span class="line">    <span class="comment">// Just use the default in this case.</span></span><br><span class="line">    log_error_dest = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_daemonize &amp;&amp; !opt_validate_config) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">chdir</span>(<span class="string">&quot;/&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_CANNOT_CHANGE_TO_ROOT_DIR, <span class="built_in">strerror</span>(errno));</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((pipe_write_fd = mysqld::runtime::<span class="built_in">mysqld_daemonize</span>()) &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_FAILED_START_MYSQLD_DAEMON);</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe_write_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the launching process and the daemon appears to have</span></span><br><span class="line">      <span class="comment">// started ok (Need to call unireg_abort with success here to</span></span><br><span class="line">      <span class="comment">// clean up resources in the launching process.</span></span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_SUCCESS_EXIT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Need to update the value of current_pid so that it reflects the</span></span><br><span class="line">    <span class="comment">// pid of the daemon (the previous value was set by unireg_init()</span></span><br><span class="line">    <span class="comment">// while still in the launcher process.</span></span><br><span class="line">    current_pid = <span class="keyword">static_cast</span>&lt;ulong&gt;(<span class="built_in">getpid</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> _WIN32</span></span><br><span class="line">  user_info = <span class="built_in">check_user</span>(mysqld_user);</span><br><span class="line">  <span class="keyword">if</span> (!user_info.<span class="built_in">IsVoid</span>()) &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> HAVE_CHOWN</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">unlikely</span>(opt_initialize)) &#123;</span><br><span class="line">      <span class="comment">/* need to change the owner of the freshly created data directory */</span></span><br><span class="line">      MY_STAT stat;</span><br><span class="line">      <span class="keyword">char</span> errbuf[MYSYS_STRERROR_SIZE];</span><br><span class="line">      <span class="keyword">bool</span> must_chown = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* fetch the directory&#x27;s owner */</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">my_stat</span>(mysql_real_data_home, &amp;stat, <span class="built_in">MYF</span>(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="built_in">LogErr</span>(INFORMATION_LEVEL, ER_CANT_STAT_DATADIR, <span class="built_in">my_errno</span>(),</span><br><span class="line">               <span class="built_in">my_strerror</span>(errbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(errbuf), <span class="built_in">my_errno</span>()));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* Don&#x27;t change it if it&#x27;s already the same as SElinux stops this */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (stat.st_uid == user_info.pw_uid &amp;&amp;</span><br><span class="line">               stat.st_gid == user_info.pw_gid)</span><br><span class="line">        must_chown = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (must_chown &amp;&amp;</span><br><span class="line">          <span class="built_in">chown</span>(mysql_real_data_home, user_info.pw_uid, user_info.pw_gid)) &#123;</span><br><span class="line">        <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_CANT_CHOWN_DATADIR, mysqld_user);</span><br><span class="line">        <span class="built_in">unireg_abort</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(HAVE_MLOCKALL) &amp;&amp; defined(MCL_CURRENT)</span></span><br><span class="line">    <span class="keyword">if</span> (locked_in_memory)  <span class="comment">// getuid() == 0 here</span></span><br><span class="line">      <span class="built_in">set_effective_user</span>(user_info);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="built_in">set_user</span>(mysqld_user, user_info);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// !_WIN32</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   initiate key migration if any one of the migration specific</span></span><br><span class="line"><span class="comment">   options are provided.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (opt_keyring_migration_source || opt_keyring_migration_destination ||</span><br><span class="line">      migrate_connect_options) &#123;</span><br><span class="line">    <span class="keyword">int</span> exit_state = MYSQLD_ABORT_EXIT;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      Migrate_keyring mk;</span><br><span class="line">      my_getopt_skip_unknown = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (mk.<span class="built_in">init</span>(remaining_argc, remaining_argv, opt_keyring_migration_source,</span><br><span class="line">                  opt_keyring_migration_destination, opt_keyring_migration_user,</span><br><span class="line">                  opt_keyring_migration_host, opt_keyring_migration_password,</span><br><span class="line">                  opt_keyring_migration_socket, opt_keyring_migration_port,</span><br><span class="line">                  opt_keyring_migration_to_component,</span><br><span class="line">                  opt_keyring_migration_from_component)) &#123;</span><br><span class="line">        <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_KEYRING_MIGRATION_FAILED);</span><br><span class="line">        log_error_dest = <span class="string">&quot;stderr&quot;</span>;</span><br><span class="line">        <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (mk.<span class="built_in">execute</span>()) &#123;</span><br><span class="line">        <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_KEYRING_MIGRATION_FAILED);</span><br><span class="line">        log_error_dest = <span class="string">&quot;stderr&quot;</span>;</span><br><span class="line">        <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      my_getopt_skip_unknown = <span class="literal">false</span>;</span><br><span class="line">      <span class="built_in">LogErr</span>(INFORMATION_LEVEL, ER_KEYRING_MIGRATION_SUCCESSFUL);</span><br><span class="line">      log_error_dest = <span class="string">&quot;stderr&quot;</span>;</span><br><span class="line">      <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">      exit_state = MYSQLD_SUCCESS_EXIT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">unireg_abort</span>(exit_state);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   We have enough space for fiddling with the argv, continue</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="built_in">is_help_or_validate_option</span>()) &amp;&amp;</span><br><span class="line">      <span class="built_in">my_setwd</span>(mysql_real_data_home, <span class="built_in">MYF</span>(<span class="number">0</span>))) &#123;</span><br><span class="line">    <span class="keyword">char</span> errbuf[MYSYS_STRERROR_SIZE];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_CANT_SET_DATA_DIR, mysql_real_data_home, errno,</span><br><span class="line">           <span class="built_in">my_strerror</span>(errbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(errbuf), errno));</span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT); <span class="comment">/* purecov: inspected */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   The subsequent calls may take a long time : e.g. innodb log read.</span></span><br><span class="line"><span class="comment">   Thus set the long running service control manager timeout</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined(_WIN32)</span></span><br><span class="line">  <span class="keyword">if</span> (windows_service) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setup_service_status_cmd_processed_handle</span>())</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(buf, <span class="built_in"><span class="keyword">sizeof</span></span>(buf), <span class="string">&quot;T %lu&quot;</span>, slow_start_timeout);</span><br><span class="line">    <span class="function"><span class="keyword">const</span> Service_status_msg <span class="title">msg</span><span class="params">(buf)</span></span>;</span><br><span class="line">    <span class="built_in">send_service_status</span>(msg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Determine default TCP port and unix socket name */</span></span><br><span class="line">  <span class="built_in">set_ports</span>();</span><br><span class="line">  <span class="comment">/* 初始化系统模块，比如MDL、存储引擎、慢查询日志、binlog */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">init_server_components</span>()) <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!server_id_supplied)</span><br><span class="line">    <span class="built_in">LogErr</span>(INFORMATION_LEVEL, ER_WARN_NO_SERVERID_SPECIFIED);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Add server_uuid to the tsid_map.  This must be done after</span></span><br><span class="line"><span class="comment">    server_uuid has been initialized in init_server_auto_options and</span></span><br><span class="line"><span class="comment">    after the binary log (and tsid_map file) has been initialized in</span></span><br><span class="line"><span class="comment">    init_server_components().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    No error message is needed: init_tsid_map() prints a message.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Strictly speaking, this is not currently needed when</span></span><br><span class="line"><span class="comment">    opt_bin_log==0, since the variables that gtid_state-&gt;init</span></span><br><span class="line"><span class="comment">    initializes are not currently used in that case.  But we call it</span></span><br><span class="line"><span class="comment">    regardless to avoid possible future bugs if gtid_state ever</span></span><br><span class="line"><span class="comment">    needs to do anything else.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  global_tsid_lock-&gt;<span class="built_in">wrlock</span>();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> gtid_ret = gtid_state-&gt;<span class="built_in">init</span>();</span><br><span class="line">  global_tsid_lock-&gt;<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (gtid_ret) <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!opt_initialize &amp;&amp; !opt_initialize_insecure) &#123;</span><br><span class="line">    <span class="comment">// Initialize executed_gtids from mysql.gtid_executed table.</span></span><br><span class="line">    <span class="keyword">if</span> (gtid_state-&gt;<span class="built_in">read_gtid_executed_from_table</span>() == <span class="number">-1</span>) <span class="built_in">unireg_abort</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_bin_log) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Initialize GLOBAL.GTID_EXECUTED and GLOBAL.GTID_PURGED from</span></span><br><span class="line"><span class="comment">      gtid_executed table and binlog files during server startup.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Gtid_set *executed_gtids =</span><br><span class="line">      <span class="keyword">const_cast</span>&lt;Gtid_set *&gt;(gtid_state-&gt;<span class="built_in">get_executed_gtids</span>());</span><br><span class="line">    Gtid_set *lost_gtids = <span class="keyword">const_cast</span>&lt;Gtid_set *&gt;(gtid_state-&gt;<span class="built_in">get_lost_gtids</span>());</span><br><span class="line">    Gtid_set *gtids_only_in_table =</span><br><span class="line">      <span class="keyword">const_cast</span>&lt;Gtid_set *&gt;(gtid_state-&gt;<span class="built_in">get_gtids_only_in_table</span>());</span><br><span class="line">    Gtid_set *previous_gtids_logged =</span><br><span class="line">      <span class="keyword">const_cast</span>&lt;Gtid_set *&gt;(gtid_state-&gt;<span class="built_in">get_previous_gtids_logged</span>());</span><br><span class="line"></span><br><span class="line">    <span class="function">Gtid_set <span class="title">purged_gtids_from_binlog</span><span class="params">(global_tsid_map, global_tsid_lock)</span></span>;</span><br><span class="line">    <span class="function">Gtid_set <span class="title">gtids_in_binlog</span><span class="params">(global_tsid_map, global_tsid_lock)</span></span>;</span><br><span class="line">    <span class="function">Gtid_set <span class="title">gtids_in_binlog_not_in_table</span><span class="params">(global_tsid_map, global_tsid_lock)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mysql_bin_log.<span class="built_in">init_gtid_sets</span>(</span><br><span class="line">      &amp;gtids_in_binlog, &amp;purged_gtids_from_binlog,</span><br><span class="line">      opt_source_verify_checksum, <span class="literal">true</span> <span class="comment">/*true=need lock*/</span>,</span><br><span class="line">      <span class="literal">nullptr</span> <span class="comment">/*trx_parser*/</span>, <span class="literal">nullptr</span> <span class="comment">/*partial_trx*/</span>,</span><br><span class="line">      <span class="literal">true</span> <span class="comment">/*is_server_starting*/</span>))</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">    global_tsid_lock-&gt;<span class="built_in">wrlock</span>();</span><br><span class="line"></span><br><span class="line">    purged_gtids_from_binlog.<span class="built_in">dbug_print</span>(<span class="string">&quot;purged_gtids_from_binlog&quot;</span>);</span><br><span class="line">    gtids_in_binlog.<span class="built_in">dbug_print</span>(<span class="string">&quot;gtids_in_binlog&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!gtids_in_binlog.<span class="built_in">is_empty</span>() &amp;&amp;</span><br><span class="line">        !gtids_in_binlog.<span class="built_in">is_subset</span>(executed_gtids)) &#123;</span><br><span class="line">      gtids_in_binlog_not_in_table.<span class="built_in">add_gtid_set</span>(&amp;gtids_in_binlog);</span><br><span class="line">      <span class="keyword">if</span> (!executed_gtids-&gt;<span class="built_in">is_empty</span>())</span><br><span class="line">        gtids_in_binlog_not_in_table.<span class="built_in">remove_gtid_set</span>(executed_gtids);</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Save unsaved GTIDs into gtid_executed table, in the following</span></span><br><span class="line"><span class="comment">        four cases:</span></span><br><span class="line"><span class="comment">          1. the upgrade case.</span></span><br><span class="line"><span class="comment">          2. the case that a slave is provisioned from a backup of</span></span><br><span class="line"><span class="comment">             the master and the slave is cleaned by RESET BINARY LOGS AND GTIDS</span></span><br><span class="line"><span class="comment">             and RESET REPLICA before this.</span></span><br><span class="line"><span class="comment">          3. the case that no binlog rotation happened from the</span></span><br><span class="line"><span class="comment">             last RESET BINARY LOGS AND GTIDS on the server before it crashes.</span></span><br><span class="line"><span class="comment">          4. The set of GTIDs of the last binlog is not saved into the</span></span><br><span class="line"><span class="comment">             gtid_executed table if server crashes, so we save it into</span></span><br><span class="line"><span class="comment">             gtid_executed table and executed_gtids during recovery</span></span><br><span class="line"><span class="comment">             from the crash.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (gtid_state-&gt;<span class="built_in">save</span>(&amp;gtids_in_binlog_not_in_table) == <span class="number">-1</span>) &#123;</span><br><span class="line">        global_tsid_lock-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">        <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">      &#125;</span><br><span class="line">      executed_gtids-&gt;<span class="built_in">add_gtid_set</span>(&amp;gtids_in_binlog_not_in_table);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* gtids_only_in_table= executed_gtids - gtids_in_binlog */</span></span><br><span class="line">    <span class="keyword">if</span> (gtids_only_in_table-&gt;<span class="built_in">add_gtid_set</span>(executed_gtids) != RETURN_STATUS_OK) &#123;</span><br><span class="line">      global_tsid_lock-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">    &#125;</span><br><span class="line">    gtids_only_in_table-&gt;<span class="built_in">remove_gtid_set</span>(&amp;gtids_in_binlog);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      lost_gtids = executed_gtids -</span></span><br><span class="line"><span class="comment">                   (gtids_in_binlog - purged_gtids_from_binlog)</span></span><br><span class="line"><span class="comment">                 = gtids_only_in_table + purged_gtids_from_binlog;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">assert</span>(lost_gtids-&gt;<span class="built_in">is_empty</span>());</span><br><span class="line">    <span class="keyword">if</span> (lost_gtids-&gt;<span class="built_in">add_gtid_set</span>(gtids_only_in_table) != RETURN_STATUS_OK ||</span><br><span class="line">        lost_gtids-&gt;<span class="built_in">add_gtid_set</span>(&amp;purged_gtids_from_binlog) !=</span><br><span class="line">        RETURN_STATUS_OK) &#123;</span><br><span class="line">      global_tsid_lock-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Prepare previous_gtids_logged for next binlog */</span></span><br><span class="line">    <span class="keyword">if</span> (previous_gtids_logged-&gt;<span class="built_in">add_gtid_set</span>(&amp;gtids_in_binlog) !=</span><br><span class="line">        RETURN_STATUS_OK) &#123;</span><br><span class="line">      global_tsid_lock-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Write the previous set of gtids at this point because during</span></span><br><span class="line"><span class="comment">      the creation of the binary log this is not done as we cannot</span></span><br><span class="line"><span class="comment">      move the init_gtid_sets() to a place before opening the binary</span></span><br><span class="line"><span class="comment">      log. This requires some investigation.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      /Alfranio</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">Previous_gtids_log_event <span class="title">prev_gtids_ev</span><span class="params">(&amp;gtids_in_binlog)</span></span>;</span><br><span class="line"></span><br><span class="line">    global_tsid_lock-&gt;<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    (prev_gtids_ev.common_footer)-&gt;checksum_alg =</span><br><span class="line">      <span class="keyword">static_cast</span>&lt;enum_binlog_checksum_alg&gt;(binlog_checksum_options);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mysql_bin_log.<span class="built_in">write_event_to_binlog_and_sync</span>(&amp;prev_gtids_ev))</span><br><span class="line">      <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run auto purge member function. It will evaluate auto purge controls</span></span><br><span class="line">    <span class="comment">// and configuration, calculate which log files are to be purged, and</span></span><br><span class="line">    <span class="comment">// if any file is to be purged, it will purge it. This is all encapsulated</span></span><br><span class="line">    <span class="comment">// insiude the auto purge member function.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Note on the DBUG_EVALUATE_IF usage below:</span></span><br><span class="line">    <span class="comment">// - when compiling it out: the condition evaluates to true, thus</span></span><br><span class="line">    <span class="comment">//   mysql_bin_log.auto_purge_at_server_startup() runs</span></span><br><span class="line">    <span class="comment">// - when &quot;expire_logs_always_at_start&quot; is set: evaluates to false,</span></span><br><span class="line">    <span class="comment">//   thus mysql_bin_log.purge_logs_before_date() runs</span></span><br><span class="line">    <span class="comment">// - when &quot;expire_logs_always_at_start&quot; is not set: evaluates to true,</span></span><br><span class="line">    <span class="comment">//   this mysql_bin_log.auto_purge_at_server_startup() runs</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">DBUG_EVALUATE_IF</span>(<span class="string">&quot;expire_logs_always_at_start&quot;</span>, <span class="literal">false</span>, <span class="literal">true</span>))</span><br><span class="line">      mysql_bin_log.<span class="built_in">auto_purge_at_server_startup</span>();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (binlog_expire_logs_seconds &gt; <span class="number">0</span>)</span><br><span class="line">      mysql_bin_log.<span class="built_in">purge_logs_before_date</span>(<span class="built_in">time</span>(<span class="literal">nullptr</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>)<span class="built_in">RUN_HOOK</span>(server_state, after_engine_recovery, (<span class="literal">nullptr</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 初始化SSL */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">init_ssl_communication</span>()) <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">  <span class="comment">/* 初始化网络 */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">network_init</span>()) <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  <span class="keyword">if</span> (opt_require_secure_transport &amp;&amp; !opt_enable_shared_memory &amp;&amp;</span><br><span class="line">      !<span class="built_in">have_ssl</span>() &amp;&amp; !opt_initialize) &#123;</span><br><span class="line">    <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_TRANSPORTS_WHAT_TRANSPORTS);</span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   Initialize my_str_malloc(), my_str_realloc() and my_str_free()</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  my_str_malloc = &amp;my_str_malloc_mysqld;</span><br><span class="line">  my_str_free = &amp;my_str_free_mysqld;</span><br><span class="line">  my_str_realloc = &amp;my_str_realloc_mysqld;</span><br><span class="line"></span><br><span class="line">  error_handler_hook = my_message_sql;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> abort = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Save pid of this process in a file */</span></span><br><span class="line">  <span class="keyword">if</span> (!opt_initialize) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">create_pid_file</span>()) abort = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Read the optimizer cost model configuration tables */</span></span><br><span class="line">  <span class="keyword">if</span> (!opt_initialize) <span class="built_in">reload_optimizer_cost_constants</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Read components table to restore previously installed components. This</span></span><br><span class="line"><span class="comment">        requires read access to mysql.component table.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    (!opt_initialize &amp;&amp; <span class="built_in">mysql_component_infrastructure_init</span>()) ||</span><br><span class="line">    <span class="built_in">mysql_rm_tmp_tables</span>()) &#123;</span><br><span class="line">    abort = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* we do want to exit if there are any other unknown options */</span></span><br><span class="line">  <span class="keyword">if</span> (remaining_argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> ho_error;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_option</span> <span class="title">no_opts</span>[] =</span> &#123;&#123;<span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>,</span><br><span class="line">                                   <span class="literal">nullptr</span>, GET_NO_ARG, NO_ARG, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                                   <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>&#125;&#125;;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      We need to eat any &#x27;loose&#x27; arguments first before we conclude</span></span><br><span class="line"><span class="comment">      that there are unprocessed options.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    my_getopt_skip_unknown = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ho_error = <span class="built_in">handle_options</span>(&amp;remaining_argc, &amp;remaining_argv, no_opts,</span><br><span class="line">                                   mysqld_get_one_option)))</span><br><span class="line">      abort = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/* Add back the program name handle_options removes */</span></span><br><span class="line">      remaining_argc++;</span><br><span class="line">      remaining_argv--;</span><br><span class="line">      my_getopt_skip_unknown = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (remaining_argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_EXCESS_ARGUMENTS, remaining_argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">LogErr</span>(INFORMATION_LEVEL, ER_VERBOSE_HINT);</span><br><span class="line">        abort = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Bootstrap the dynamic privilege service implementation</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">dynamic_privilege_init</span>()) &#123;</span><br><span class="line">    <span class="built_in">LogErr</span>(WARNING_LEVEL, ER_PERSISTENT_PRIVILEGES_BOOTSTRAP);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (abort || <span class="built_in">acl_init</span>(opt_noacl)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!abort) <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_PRIVILEGE_SYSTEM_INIT_FAILED);</span><br><span class="line">    abort = <span class="literal">true</span>;</span><br><span class="line">    opt_noacl = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   if running with --initialize, explicitly allocate the memory</span></span><br><span class="line"><span class="comment">   to be used by ACL objects.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (opt_initialize) <span class="built_in">init_acl_memory</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (abort || <span class="built_in">my_tz_init</span>((THD *)<span class="literal">nullptr</span>, default_tz_name, opt_initialize) ||</span><br><span class="line">      <span class="built_in">grant_init</span>(opt_noacl)) &#123;</span><br><span class="line">    <span class="built_in">set_connection_events_loop_aborted</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">delete_pid_file</span>(<span class="built_in">MYF</span>(MY_WME));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    In the case of upgrade, the bootstrap thread would have already initialized</span></span><br><span class="line"><span class="comment">    the structures necessary for federated server from mysql.servers table.</span></span><br><span class="line"><span class="comment">    Hence we need not initialize them again here.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!opt_initialize &amp;&amp; (dd::upgrade::<span class="built_in">no_server_upgrade_required</span>() ||</span><br><span class="line">                          opt_upgrade_mode == UPGRADE_MINIMAL))</span><br><span class="line">    <span class="built_in">servers_init</span>(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!opt_noacl) &#123;</span><br><span class="line">    <span class="built_in">udf_read_functions_table</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init_status_vars</span>();</span><br><span class="line">  <span class="comment">/* If running with --initialize, do not start replication. */</span></span><br><span class="line">  <span class="keyword">if</span> (opt_initialize) opt_skip_replica_start = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check_binlog_cache_size</span>(<span class="literal">nullptr</span>);</span><br><span class="line">  <span class="built_in">check_binlog_stmt_cache_size</span>(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">binlog_unsafe_map_init</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">const</span> ReplicaInitializer <span class="title">replica_initializer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    opt_initialize, opt_skip_replica_start, rpl_channel_filters,</span></span></span><br><span class="line"><span class="params"><span class="function">    &amp;opt_replica_skip_errors)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> WITH_LOCK_ORDER</span></span><br><span class="line">  <span class="keyword">if</span> (!opt_initialize) &#123;</span><br><span class="line">    <span class="built_in">LO_activate</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_LOCK_ORDER */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> WITH_PERFSCHEMA_STORAGE_ENGINE</span></span><br><span class="line">  <span class="built_in">initialize_performance_schema_acl</span>(opt_initialize);</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WITH_PERFSCHEMA_STORAGE_ENGINE */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">initialize_information_schema_acl</span>();</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">void</span>)<span class="built_in">RUN_HOOK</span>(server_state, after_recovery, (<span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Events::<span class="built_in">init</span>(opt_noacl || opt_initialize))</span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> _WIN32</span></span><br><span class="line">  <span class="comment">//  Start signal handler thread.</span></span><br><span class="line">  <span class="built_in">start_signal_handler</span>();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (authentication_policy::<span class="built_in">init</span>(opt_authentication_policy)) &#123;</span><br><span class="line">    <span class="comment">/* --authentication_policy is set to invalid value */</span></span><br><span class="line">    <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_INVALID_AUTHENTICATION_POLICY);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* set all persistent options */</span></span><br><span class="line">  <span class="keyword">if</span> (persisted_variables_cache.<span class="built_in">set_persisted_options</span>(<span class="literal">false</span>)) &#123;</span><br><span class="line">    <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_CANT_SET_UP_PERSISTED_VALUES);</span><br><span class="line">    <span class="built_in">flush_error_log_messages</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Invoke the bootstrap thread, if required.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">process_bootstrap</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Initialize command maps */</span></span><br><span class="line">  <span class="built_in">init_command_maps</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Event must be invoked after error_handler_hook is assigned to</span></span><br><span class="line"><span class="comment">    my_message_sql, otherwise my_message will not cause the event to abort.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">void</span> *argv_p = argv;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">mysql_event_tracking_startup_notify</span>(</span><br><span class="line">    <span class="built_in">AUDIT_EVENT</span>(EVENT_TRACKING_STARTUP_STARTUP),</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span> **&gt;(argv_p), argc))</span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_ABORT_EXIT);</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  <span class="built_in">create_shutdown_and_restart_thread</span>();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (mysqld_process_must_end_at_startup) &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> !defined(_WIN32)</span></span><br><span class="line">    <span class="keyword">if</span> (opt_daemonize) mysqld::runtime::<span class="built_in">signal_parent</span>(pipe_write_fd, <span class="number">1</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="built_in">unireg_abort</span>(MYSQLD_SUCCESS_EXIT);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 启动连接管理器，创建 handle_manager 线程 */</span></span><br><span class="line">  <span class="built_in">start_handle_manager</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">create_compress_gtid_table_thread</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">LogEvent</span>()</span><br><span class="line">    .<span class="built_in">type</span>(LOG_TYPE_ERROR)</span><br><span class="line">    .<span class="built_in">subsys</span>(LOG_SUBSYSTEM_TAG)</span><br><span class="line">    .<span class="built_in">prio</span>(SYSTEM_LEVEL)</span><br><span class="line">    .<span class="built_in">lookup</span>(ER_SERVER_STARTUP_MSG, my_progname, server_version,</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SYS_UN_H</span></span><br><span class="line">            (opt_initialize ? <span class="string">&quot;&quot;</span> : mysqld_unix_port),</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            mysqld_port, MYSQL_COMPILATION_COMMENT_SERVER);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!opt_disable_networking &amp;&amp; my_admin_bind_addr_str)</span><br><span class="line">    <span class="built_in">LogEvent</span>()</span><br><span class="line">    .<span class="built_in">type</span>(LOG_TYPE_ERROR)</span><br><span class="line">    .<span class="built_in">subsys</span>(LOG_SUBSYSTEM_TAG)</span><br><span class="line">    .<span class="built_in">prio</span>(SYSTEM_LEVEL)</span><br><span class="line">    .<span class="built_in">lookup</span>(ER_SERVER_STARTUP_ADMIN_INTERFACE, my_admin_bind_addr_str,</span><br><span class="line">            mysqld_admin_port, MYSQL_COMPILATION_COMMENT);</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined(_WIN32)</span></span><br><span class="line">  <span class="keyword">if</span> (windows_service) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> Service_status_msg <span class="title">s</span><span class="params">(<span class="string">&quot;R&quot;</span>)</span></span>;</span><br><span class="line">    <span class="built_in">send_service_status</span>(s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">server_components_initialized</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Set opt_super_readonly here because if opt_super_readonly is set</span></span><br><span class="line"><span class="comment">    in get_option, it will create problem while setting up event scheduler.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">set_super_read_only_post_init</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Expose MySQL metrics.</span></span><br><span class="line"><span class="comment">    This is done only when the server bootstrap is complete,</span></span><br><span class="line"><span class="comment">    to avoid observing states that are not fully initialized.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">register_server_metric_sources</span>();</span><br><span class="line">  <span class="built_in">register_pfs_metric_sources</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;info&quot;</span>, (<span class="string">&quot;Block, listening for incoming connections&quot;</span>));</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">void</span>)<span class="built_in">MYSQL_SET_STAGE</span>(<span class="number">0</span>, __FILE__, __LINE__);</span><br><span class="line"></span><br><span class="line">  server_operational_state = SERVER_OPERATING;</span><br><span class="line">  sysd::<span class="built_in">notify</span>(<span class="string">&quot;READY=1\nSTATUS=Server is operational\nMAIN_PID=&quot;</span>, <span class="built_in">getpid</span>(),</span><br><span class="line">               <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">void</span>)<span class="built_in">RUN_HOOK</span>(server_state, before_handle_connection, (<span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined(_WIN32)</span></span><br><span class="line">  <span class="keyword">if</span> (mysqld_socket_acceptor != <span class="literal">nullptr</span>)</span><br><span class="line">    mysqld_socket_acceptor-&gt;<span class="built_in">check_and_spawn_admin_connection_handler_thread</span>();</span><br><span class="line">  <span class="built_in">setup_conn_event_handler_threads</span>();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="built_in">mysql_mutex_lock</span>(&amp;LOCK_socket_listener_active);</span><br><span class="line">  <span class="comment">// Make it possible for the signal handler to kill the listener.</span></span><br><span class="line">  socket_listener_active = <span class="literal">true</span>;</span><br><span class="line">  <span class="built_in">mysql_mutex_unlock</span>(&amp;LOCK_socket_listener_active);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_daemonize) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nstdout != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="comment">// Show the pid on stdout if daemonizing and connected to tty</span></span><br><span class="line">      <span class="built_in">fprintf</span>(nstdout, <span class="string">&quot;mysqld is running as pid %lu\n&quot;</span>, current_pid);</span><br><span class="line">      <span class="built_in">fclose</span>(nstdout);</span><br><span class="line">      nstdout = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysqld::runtime::<span class="built_in">signal_parent</span>(pipe_write_fd, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mysqld_socket_acceptor-&gt;<span class="built_in">check_and_spawn_admin_connection_handler_thread</span>();</span><br><span class="line">  mysqld_socket_acceptor-&gt;<span class="built_in">connection_event_loop</span>();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _WIN32 */</span></span></span><br><span class="line">  server_operational_state = SERVER_SHUTTING_DOWN;</span><br><span class="line">  sysd::<span class="built_in">notify</span>(<span class="string">&quot;STOPPING=1\nSTATUS=Server shutdown in progress\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;info&quot;</span>, (<span class="string">&quot;No longer listening for incoming connections&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    No longer expose MySQL metrics.</span></span><br><span class="line"><span class="comment">    This is done before performing the cleanup to shutdown,</span></span><br><span class="line"><span class="comment">    to avoid observing states that are being destroyed.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">unregister_pfs_metric_sources</span>();</span><br><span class="line">  <span class="built_in">unregister_server_metric_sources</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mysql_event_tracking_shutdown_notify</span>(</span><br><span class="line">    <span class="built_in">AUDIT_EVENT</span>(EVENT_TRACKING_SHUTDOWN_SHUTDOWN),</span><br><span class="line">    EVENT_TRACKING_SHUTDOWN_REASON_SHUTDOWN, MYSQLD_SUCCESS_EXIT);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">terminate_compress_gtid_table_thread</span>();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Save set of GTIDs of the last binlog into gtid_executed table</span></span><br><span class="line"><span class="comment">    on server shutdown.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (opt_bin_log)</span><br><span class="line">    <span class="keyword">if</span> (gtid_state-&gt;<span class="built_in">save_gtids_of_last_binlog_into_table</span>())</span><br><span class="line">      <span class="built_in">LogErr</span>(WARNING_LEVEL, ER_CANT_SAVE_GTIDS);</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> _WIN32</span></span><br><span class="line">  <span class="built_in">mysql_mutex_lock</span>(&amp;LOCK_socket_listener_active);</span><br><span class="line">  <span class="comment">// Notify the signal handler that we have stopped listening for connections.</span></span><br><span class="line">  socket_listener_active = <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">mysql_cond_broadcast</span>(&amp;COND_socket_listener_active);</span><br><span class="line">  <span class="built_in">mysql_mutex_unlock</span>(&amp;LOCK_socket_listener_active);</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// !_WIN32</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_PSI_THREAD_INTERFACE</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Disable the main thread instrumentation,</span></span><br><span class="line"><span class="comment">    to avoid recording events during the shutdown.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">PSI_THREAD_CALL</span>(delete_current_thread)();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_PSI_THREAD_INTERFACE */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;info&quot;</span>, (<span class="string">&quot;Waiting for shutdown proceed&quot;</span>));</span><br><span class="line">  <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  <span class="keyword">if</span> (shutdown_restart_thr_handle.handle)</span><br><span class="line">    ret = <span class="built_in">my_thread_join</span>(&amp;shutdown_restart_thr_handle, <span class="literal">nullptr</span>);</span><br><span class="line">  shutdown_restart_thr_handle.handle = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != ret)</span><br><span class="line">    <span class="built_in">LogErr</span>(WARNING_LEVEL, ER_CANT_JOIN_SHUTDOWN_THREAD, <span class="string">&quot;shutdown &quot;</span>, ret);</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">if</span> (signal_thread_id.thread != null_thread_initializer)</span><br><span class="line">    ret = <span class="built_in">my_thread_join</span>(&amp;signal_thread_id, <span class="literal">nullptr</span>);</span><br><span class="line">  signal_thread_id.thread = null_thread_initializer;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != ret)</span><br><span class="line">    <span class="built_in">LogErr</span>(WARNING_LEVEL, ER_CANT_JOIN_SHUTDOWN_THREAD, <span class="string">&quot;signal_&quot;</span>, ret);</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// _WIN32</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">clean_up</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="built_in">mysqld_exit</span>(signal_hand_thr_exit_code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="四、参考文档"><a href="#四、参考文档" class="headerlink" title="四、参考文档"></a>四、参考文档</h1><p><a target="_blank" rel="noopener" href="https://shockerli.net/post/mysql-source-macos-vscode-debug-5-7/">https://shockerli.net/post/mysql-source-macos-vscode-debug-5-7/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/shockerli/mysql-annotated-5.7.35">https://github.com/shockerli/mysql-annotated-5.7.35</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cndba.cn/dave/article/107751">https://www.cndba.cn/dave/article/107751</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/13/mysql%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/13/mysql%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1/" class="post-title-link" itemprop="url">mysql源码分析(1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-06-13 21:57:35" itemprop="dateCreated datePublished" datetime="2024-06-13T21:57:35+08:00">2024-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-06-14 00:32:22" itemprop="dateModified" datetime="2024-06-14T00:32:22+08:00">2024-06-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、mysql体系结构"><a href="#一、mysql体系结构" class="headerlink" title="一、mysql体系结构"></a>一、mysql体系结构</h1><p>啰嗦一句，最好的学习资料，来源官网，比如mysql的文档：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.4/en/">https://dev.mysql.com/doc/refman/8.4/en/</a></p>
<p>首先，引用8.4官方的图：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.4/en/pluggable-storage-overview.html"><strong>MySQL Architecture with Pluggable Storage Engines</strong></a></p>
<img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/mysql-architecture.png" alt="MySQL architecture diagram showing connectors, interfaces, pluggable storage engines, the file system with files and logs."  />

<p>从图中，可以看到mysql数据库实例，mysqld分几部分组成：</p>
<ul>
<li>NoSQL接口组件（接收处理NoSQL语句）</li>
<li>SQL接口组件（接收处理SQL语句）</li>
<li>查询分析器组件（解析SQL，生成语法树）</li>
<li>优化器组件（根据语法树，生成执行计划，和存储层交互）</li>
<li>缓存组件（提高查询性能）</li>
<li>插件式存储引擎（插件式、统一API接口）</li>
<li>物理文件（frm、MYD、MYI、ibd等结尾的文体）</li>
<li><em><strong>连接池组件（8.4图未体现，Connection Pool）</strong></em></li>
<li><em><strong>管理服务和工具组件（8.4图未提现，Management Service &amp;Utillites）</strong></em></li>
</ul>
<p>其中，NoSQL接口组件，可以参考官网<a target="_blank" rel="noopener" href="https://www.mysql.com/products/enterprise/document_store.html">MySQL Document Store</a>，</p>
<img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/mysql_document_store_architecture.png" alt="MySQL Document Store" style="zoom:67%;" />

<h1 id="二、innodb体系"><a href="#二、innodb体系" class="headerlink" title="二、innodb体系"></a>二、innodb体系</h1><p>还是来看下，官网给的一张图：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.4/en/innodb-architecture.html">InnoDB Architecture</a></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/innodb-architecture-8-0.png" alt="InnoDB architecture diagram showing in-memory and on-disk structures. In-memory structures include the buffer pool, adaptive hash index, change buffer, and log buffer. On-disk structures include tablespaces, redo logs, and doublewrite buffer files."></p>
<p>上图，简要的说明，innodb存储引擎架构，分为两块，<strong>in-memory structures</strong> 和 <strong>on-disk structures</strong>。</p>
<p>on-disk structures，innodb存储引擎，是基于磁盘存储的，存储是基于页（Page）的方式。为提高性能，innodb使用in-memory structures来提高整体的性能。</p>
<p>in-memory structures中，最重要的是缓存池（Buffer Pool），Buffer Pool可以简单理解为磁盘数据Page的内存映射，记录数据的读写，均发生在内存的Buffer Pool上，其中，写操作会异步刷新（Change Buffer）回磁盘（Checkpoint机制）。Buffer Pool中，<strong>默认的<code>16KB</code>的大小划分出一个个的页（Page）， Buffer Pool 中的页就叫做缓存页</strong>。</p>
<p>Buffer Pool，包含以下数据页类型：</p>
<ul>
<li>数据页（data page）</li>
<li>索引页（index page）</li>
<li>插入缓存页（insert buffer）</li>
<li>undo页（undo page）</li>
<li>自适应哈希索引（adaptive hash index）</li>
<li>锁信息（lock info）</li>
<li>数据字典（data dictionary）</li>
</ul>
<p>然后，就是redo log buffer，其作用，就是通过WAL （Write-Ahead Logging）技术**，先更新内存的Buffer Pool 的脏页，然后写redo log，再刷新到磁盘上。</p>
<p>on-disk structures，可以看到，逻辑存储结构，都是tablespace(表空间)，继续分解，tablespace是由segment（段），extent（区），page（页）组成。</p>
<p>另外，<strong>in-memory structures</strong> 和 <strong>on-disk structures</strong>的数据交互，是通过多个后台线程完成，其中就包括</p>
<ul>
<li>Master Thread，核心线程，完成数据异步刷盘，合并插入缓冲等</li>
<li>IO Thread，AIO线程，处理IO请求</li>
<li>Purge Thread，回收undo页</li>
<li>Page Cleaner Thread，脏页刷新</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/26/SpringBoot3+GraalVM%E5%BC%80%E5%8F%91Native%20Executable%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/26/SpringBoot3+GraalVM%E5%BC%80%E5%8F%91Native%20Executable%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">SpringBoot3+GraalVM开发Native Executable踩坑记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-26 16:52:07" itemprop="dateCreated datePublished" datetime="2024-02-26T16:52:07+08:00">2024-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-04 14:53:48" itemprop="dateModified" datetime="2024-03-04T14:53:48+08:00">2024-03-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SpringBoot3-GraalVM如何构建Native-Executable"><a href="#SpringBoot3-GraalVM如何构建Native-Executable" class="headerlink" title="SpringBoot3+GraalVM如何构建Native Executable"></a>SpringBoot3+GraalVM如何构建Native Executable</h1><h2 id="GraalVM简介"><a href="#GraalVM简介" class="headerlink" title="GraalVM简介"></a>GraalVM简介</h2><p>简单介绍下Graalvm，<a target="_blank" rel="noopener" href="https://www.graalvm.org/">官网</a>，摘抄定义：</p>
<blockquote>
<p>Build faster, smaller, leaner applications</p>
<p>An advanced JDK with ahead-of-time Native Image compilation</p>
</blockquote>
<p>关键字：</p>
<ul>
<li><strong>JDK</strong>：Oracle，出品的JDK，具备AOT功能的JDK，有CE和EE两个版本。</li>
<li><strong>Faster</strong>：启动速度更快，常规Java服务启动速度，长期被吐槽慢，特别是云计算，其他云原生语言比如golang兴起后，特别明显。</li>
</ul>
<blockquote>
<h5 id="Native-executables-compiled-ahead-of-time-start-up-instantly-and-require-no-warmup-to-run-at-peak-performance"><a href="#Native-executables-compiled-ahead-of-time-start-up-instantly-and-require-no-warmup-to-run-at-peak-performance" class="headerlink" title="Native executables compiled ahead of time start up instantly and require no warmup to run at peak performance."></a>Native executables compiled ahead of time start up instantly and require no warmup to run at peak performance.</h5></blockquote>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/0*i34nDR-r0mzhm0YM-20240226170407490.png" alt="img"></p>
<ul>
<li><strong>Smaller</strong>：程序使用内存减少，相比常规Java内存占用减少明显。</li>
</ul>
<blockquote>
<h5 id="Native-executables-use-only-a-fraction-of-memory-and-CPU-resources-required-by-a-JVM-which-improves-utilization-and-reduces-costs"><a href="#Native-executables-use-only-a-fraction-of-memory-and-CPU-resources-required-by-a-JVM-which-improves-utilization-and-reduces-costs" class="headerlink" title="Native executables use only a fraction of memory and CPU resources required by a JVM, which improves utilization and reduces costs."></a>Native executables use only a fraction of memory and CPU resources required by a JVM, which improves utilization and reduces costs.</h5></blockquote>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/0*DNhwYei4b-_2iFUF.png" alt="img"></p>
<ul>
<li><strong>Leaner</strong>：高效，性能不输带JIT C2编译器的JVM。</li>
</ul>
<p>参考GraalVM JDK21的<a target="_blank" rel="noopener" href="https://medium.com/graalvm/graalvm-for-jdk-21-is-here-ee01177dd12d#0df7">性能测试报告</a>，性能甚至比JIT C2的JVM高一点。测试服务，是用的<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-petclinic">spring-petclinic</a></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/1*4HNCqfF7cQyLeijXkXjzmA.png" alt="img"></p>
<blockquote>
<p>Performance of Spring Petclinic with Oracle GraalVM Native Image and GraalVM CE with C2 JIT. The benchmarking experiment ran the latest <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a> on Oracle X5–2 servers (Intel Xeon E5–2699 v3), restricting the workload to 16 CPUs and setting a maximum heap size of 1GB.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/1*01_HtHD4jfuXOsgDMhkljQ.png" alt="img"></p>
<blockquote>
<p>Performance of Spring Petclinic with Oracle GraalVM Native Image and GraalVM CE with C2 JIT. The benchmarking experiment ran the latest <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a> on Oracle X5–2 servers (Intel Xeon E5–2699 v3), restricting the workload to 16 CPUs and setting a maximum heap size of 512MB.</p>
</blockquote>
<p>GraalVM比较关键的时间线：</p>
<p><img src="https://miro.medium.com/v2/resize:fit:2000/1*u3Y5MLzJZpC9GIlZtZyqig.png" alt="img"></p>
<h2 id="Native-Executable（原生二进制程序）"><a href="#Native-Executable（原生二进制程序）" class="headerlink" title="Native Executable（原生二进制程序）"></a>Native Executable（原生二进制程序）</h2><p>以下，将以Gradle为例子，把一个SpringBoot应用，使用nativeCompile命令，编译成Native Executable（原生二进制程序），而非常规的Jar+JVM运行。</p>
<p>首先引入插件，其中包括springboot插件和gradle graalvm buildtools 插件。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">  id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;3.2.3&#x27;</span> apply <span class="literal">false</span></span><br><span class="line">  id <span class="string">&#x27;org.graalvm.buildtools.native&#x27;</span> version <span class="string">&#x27;0.10.1&#x27;</span> apply <span class="literal">false</span>  <span class="comment">//若直接使用，可不需要apply false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启插件</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.springframework.boot&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.graalvm.buildtools.native&quot;</span></span><br></pre></td></tr></table></figure>

<p>设置GraalVM参数，详细的参数设置，参考<a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/reference-manual/native-image/overview/Options/">官网</a>.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">graalvmNative &#123;</span><br><span class="line">  binaries &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">      <span class="comment">//编译物件为单独的二进制文件，不产生so动态链接文件</span></span><br><span class="line">      sharedLibrary = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//显示完整日志</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--verbose&#x27;</span>)</span><br><span class="line">      <span class="comment">//不使用fallback回退镜像方式</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--no-fallback&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//打开指定的模块的包</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--add-opens=java.base/java.nio=ALL-UNNAMED&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--add-opens=java.base/jdk.internal.misc=ALL-UNNAMED&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--add-opens=java.base/jdk.internal.ref=ALL-UNNAMED&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//跟踪实例化的类</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--trace-class-initialization=ch.qos.logback.classic.Logger&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--trace-class-initialization=java.net.Inet4Address&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//跟踪实例化的对象</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--trace-object-instantiation=ch.qos.logback.core.AsyncAppenderBase$Worker&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--trace-object-instantiation=java.net.Inet4Address&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//显示指定类初始化（运行时）</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-run-time=io.netty.util.NetUtil&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//显示指定类初始化（编译期）</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=org.springframework.util.unit.DataSize&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=org.slf4j.LoggerFactory,ch.qos.logback&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=org.slf4j.MDC&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.classic.Level&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.classic.Logger&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.core.util.StatusPrinter&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.core.status.StatusBase&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.core.status.InfoStatus&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.core.spi.AppenderAttachableImpl&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=org.slf4j.LoggerFactory&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.core.util.Loader&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=org.slf4j.impl.StaticLoggerBinder&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.classic.spi.ThrowableProxy&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--initialize-at-build-time=ch.qos.logback.core.CoreConstants&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//打印编译期详细错误</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--report-unsupported-elements-at-runtime&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--allow-incomplete-classpath&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;-H:+ReportExceptionStackTraces&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//perf</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;-H:-DeleteLocalSymbols&#x27;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&#x27;-H:+PreserveFramePointer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//增加features</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--features=pers.james.practice.springboog3.config.LambdaRegistrationFeature&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//使用GraalVM的G1 GC</span></span><br><span class="line">      buildArgs.add(<span class="string">&#x27;--gc=G1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//Optimize Level O3</span></span><br><span class="line">      buildArgs.add(<span class="string">&quot;-O3&quot;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//静态链接</span></span><br><span class="line">      buildArgs.add(<span class="string">&quot;--static&quot;</span>)</span><br><span class="line">      buildArgs.add(<span class="string">&quot;--libc=musl&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是个简单的demo springboot3程序，只需要引入springboot3，并下载graalvm jdk，执行gradle task</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle nativeCompile</span><br></pre></td></tr></table></figure>

<p>就会在对应build目录，看到二进制可执行文件。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226180638440.png" alt="image-20240226180638440"></p>
<p>直接执行二进制文件。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226180947323.png" alt="image-20240226180947323"></p>
<h1 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h1><h2 id="GraalVM版本选择"><a href="#GraalVM版本选择" class="headerlink" title="GraalVM版本选择"></a>GraalVM版本选择</h2><h4 id="Oracle-GraalVM"><a href="#Oracle-GraalVM" class="headerlink" title="Oracle GraalVM"></a>Oracle GraalVM</h4><p>Oracle的GraalVM，分为CE和EE版本，23年6月前，EE版本是要收费的，后面Oracle出了个新的 <a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/jdk-faqs.html#GraalVM-licensing">GFTC license</a>，可以在开发和生产环境使用EE的功能（比如PGO、ML配置文件推理、G1 GC、额外的编译器优化等）。</p>
<p>其中EE版本，直接在Oracle官网下载，<a target="_blank" rel="noopener" href="https://www.graalvm.org/">官网</a></p>
<p>而CE版本，在github下载，<a target="_blank" rel="noopener" href="https://github.com/graalvm/graalvm-ce-builds">graalvm-ce</a></p>
<h4 id="LibericaNIK"><a href="#LibericaNIK" class="headerlink" title="LibericaNIK"></a>LibericaNIK</h4><p><a target="_blank" rel="noopener" href="https://bell-sw.com/liberica-native-image-kit/">LibericaNIK</a>是<a target="_blank" rel="noopener" href="https://bell-sw.com/">bellsoft公司</a>，基于GraalVM CE版本修改，开源的GraalVM版本，LibericaNIK是<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html">SpringBoot官方</a>推荐的native image JDK</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226185648949.png" alt="image-20240226185648949"></p>
<h2 id="graalvm-reachability-metadata"><a href="#graalvm-reachability-metadata" class="headerlink" title="graalvm-reachability-metadata"></a>graalvm-reachability-metadata</h2><p>GraalVM不是没有缺点，其中一个缺点就是Java丰富的生态里面，很多类库和框架，都需要根据AOT特性做适配，比如动态功能变静态功能，比如反射、代理、序列化，而这些适配是分散和困难，如果将这些适配当做元数据集中起来复用，生成native的时候，就可以使用。就是 <a target="_blank" rel="noopener" href="https://github.com/oracle/graalvm-reachability-metadata">graalvm-reachability-metadata</a>。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226190541405.png" alt="image-20240226190541405"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226190701540.png" alt="image-20240226190701540"></p>
<p>graalvm-reachability-metadata在gradle native buildtools插件中，默认是开启的。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226190842653.png" alt="image-20240226190842653"></p>
<p>graalvm-reachability-metadata，可以快速查找哪些类库和框架是支持GraalVM和学习如何支持GraalVM。</p>
<h2 id="AOT适配工作"><a href="#AOT适配工作" class="headerlink" title="AOT适配工作"></a>AOT适配工作</h2><h3 id="反射（RuntimeHintsRegistrar）"><a href="#反射（RuntimeHintsRegistrar）" class="headerlink" title="反射（RuntimeHintsRegistrar）"></a>反射（RuntimeHintsRegistrar）</h3><p>当使用GraalVM AOT编译SpringBoot，编译期一切正常，但是运行二进制文件的时候，报错，即运行期报错的时候，报ClassNotFound，或者NoSuchMethodError报错，就是依赖的类库或者框架，使用到了反射，这时就需要显示的指定类，需要用到RuntimeHintsRegistrar。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ImportRuntimeHints(MyBatisNativeConfiguration.MyBaitsRuntimeHintsRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisNativeConfiguration</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBaitsRuntimeHintsRegistrar</span> <span class="keyword">implements</span> <span class="title">RuntimeHintsRegistrar</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerHints</span><span class="params">(RuntimeHints hints, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">      Stream.of(RawLanguageDriver.class).forEach(x -&gt; hints.reflection().registerType(x, MemberCategory.values()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是starter，则需要在META-INF的aot.factories下指定对应的RuntimeHintsRegistrar。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226192756244.png" alt="image-20240226192756244"></p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><p>Json序列化，也使用到了动态特性，需要指定反射的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Json指定反射对应类，比如UserPo.class</span></span><br><span class="line"><span class="meta">@RegisterReflectionForBinding(UserPo.class)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(Application.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="lambda表达式"><a href="#lambda表达式" class="headerlink" title="lambda表达式"></a>lambda表达式</h3><p>使用lambada表达式，需要将lambda表达式所使用的成员类都注册到org.graalvm.nativeimage.hosted.Feature。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * lambda 表达式注入到graal中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaRegistrationFeature</span> <span class="keyword">implements</span> <span class="title">Feature</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">duringSetup</span><span class="params">(DuringSetupAccess access)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO 这里需要将lambda表达式所使用的成员类都注册上来,具体情况视项目情况而定,一般扫描@Controller和@Service的会多点.</span></span><br><span class="line">    RuntimeSerialization.registerLambdaCapturingClass(UserRepository.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后增加编译参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义Feature类的全路径</span></span><br><span class="line">buildArgs.add(<span class="string">&#x27;--features=pers.james.practice.springboog3.config.LambdaRegistrationFeature&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h2><p>编译成二进制可执行文件，二进制文件和平台强相关，其实就丧失了Java JVM中间层跨平台的特性，如果非容器化的直接部署二进制文件，就会遇到兼容性问题，比如编译是高版本的gcc+glibc，而部署时事低版本的gcc+glibc（不建议轻易升级glibc，glibc是底层的C的API类库，升级需谨慎）。因为GraalVM底层依赖gcc，类似C\C++，就有动态链接和静态链接。兼容性问题，静态链接就可有了用武之地。</p>
<p>GraalVM的静态链接可执行文件，可以参考如下两篇文章：</p>
<ul>
<li><a href="/build-static-executables/">build-static-executables</a></li>
<li><a target="_blank" rel="noopener" href="https://bell-sw.com/blog/static-images-with-liberica-native-image-kit/">static-images-with-liberica-native-image-kit</a></li>
</ul>
<p>其中，推荐两种标准C类库，glibc和musl。</p>
<p>glibc，按照参考文章，在centos7，debian12操作环境下，JDK：LibericaNIK-23.0.2(JDK17)，均报错，报undefined__xmknod in Glibc，.text.java_sun_nio_fs_UnixNativeDispathcer，NIO文件读取函数错误。</p>
<p>musl，在centos7，debian12操作环境下，JDK：LibericaNIK-23.0.2(JDK17)，均验证成功。</p>
<p>其中按照文章步骤，安装musl、zlib，添加PATH，最重要的是在GraalVM构建参加中，添加一下参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buildArgs.add(<span class="string">&quot;--static&quot;</span>)</span><br><span class="line">buildArgs.add(<span class="string">&quot;--libc=musl&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="GC选择"><a href="#GC选择" class="headerlink" title="GC选择"></a>GC选择</h2><ul>
<li><p>Oracle  GraalVM EE，提供G1 GC；</p>
</li>
<li><p>LibericaNIK，提供Parallel GC；当前LibericaNIK贡献的Parallel GC，还没有合并到GraalVM CE的主干master分支，<a target="_blank" rel="noopener" href="https://github.com/oracle/graal/pull/5362">github pull</a>。但是LibericaNIK发行版的Parallel GC，生产可用，<a target="_blank" rel="noopener" href="https://bell-sw.com/blog/new-version-of-liberica-nik-23-0-with-parallelgc-is-available/">new-version-of-liberica-nik-23-0-with-parallelgc-is-available</a>.</p>
</li>
</ul>
<p>生产使用，最好选用G1GC，或者Parallel GC。</p>
<p>内存管理，比如在GraalVM中如何设置GC参数，参考<a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/reference-manual/native-image/optimizations-and-performance/MemoryManagement/">MemoryManagement</a></p>
<h2 id="Optimize-Level"><a href="#Optimize-Level" class="headerlink" title="Optimize Level"></a>Optimize Level</h2><p>gcc的compiler优化等级，参考gcc官网的<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">Optimize-Options</a>，其中-O0到-O3，定义如下：</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;-O0</span><br></pre></td></tr></table></figure>

<p>Minimum optimization. Turns off most optimizations. When debugging is enabled, this option gives the best possible debug view because the structure of the generated code directly corresponds to the source code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;-O1</span><br></pre></td></tr></table></figure>

<p>Restricted optimization. The compiler only performs optimizations that can be described by debug information. Removes unused inline functions and unused static functions. Turns off optimizations that seriously degrade the debug view. If used with <code>--debug</code>, this option gives a generally satisfactory debug view with good code density.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;-O2</span><br></pre></td></tr></table></figure>

<p>High optimization. If used with <code>--debug</code>, the debug view might be less satisfactory because the mapping of object code to source code is not always clear. The compiler may perform optimizations that cannot be described by debug information. The compiler automatically inlines functions.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;-O3</span><br></pre></td></tr></table></figure>

<p>Maximum optimization. When debugging is enabled, this option typically gives a poor debug view. Arm recommends debugging at lower optimization levels.</p>
</blockquote>
<p>默认GraalVM编译是-O2，如果是生产编译，建议开启-O3，如果是开发调试，建议开启-O1，相应的Optimize Level优化等级越高，优化效果越好，编译也越耗时。</p>
<p>更多优化，比如PGO，参考<a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/reference-manual/native-image/optimizations-and-performance/">optimizations-and-performance</a></p>
<h2 id="monitoring"><a href="#monitoring" class="headerlink" title="monitoring"></a>monitoring</h2><p>常规JVM的Java服务，可以使用JDK自带的jmap jstat监控JVM情况，或者直接使用visualvm。</p>
<p>GraalVM中的，如何监控Substrate VM。参考文章：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/tools/visualvm/">visualvm</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/reference-manual/native-image/guides/build-and-run-native-executable-with-jfr/">build-and-run-native-executable-with-jfr</a></p>
</li>
</ul>
<p>只需要在GraalVM构建参数，添加参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buildArgs.add(<span class="string">&#x27;--enable-monitoring=jmxserver,jvmstat,heapdump&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226205911591.png" alt="image-20240226205911591"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226205948186.png" alt="image-20240226205948186"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226210028513.png" alt="image-20240226210028513"></p>
<h2 id="perf"><a href="#perf" class="headerlink" title="perf"></a>perf</h2><p>GraalVM编译的native excutable无法使用JDK提供的jstack jmap性能分析工具，可以使用linux 工具perf进行性能分析和调优。</p>
<p>首先，GraalVM构造参数，添加以下参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buildArgs.add(<span class="string">&#x27;-H:-DeleteLocalSymbols&#x27;</span>)</span><br><span class="line">buildArgs.add(<span class="string">&#x27;-H:+PreserveFramePointer&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>Linux环境安装好perf之后，执行perf命令，采样生成perf data</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf record -F 500 -p PID -g -o perf.data -- sleep 10 //其中PID为进程号</span><br></pre></td></tr></table></figure>

<p>然后，目录下会生成perf.data，转换perf data文件为perf.svg火焰图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">perf script &gt; out.perf</span><br><span class="line">./FlameGraph/stackcollapse-perf.pl out.perf | ./FlameGraph/flamegraph.pl &gt; perf.svg</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226224758174.png" alt="image-20240226224758174"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/image-20240226224728170.png" alt="image-20240226224728170"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.graalvm.org/">https://www.graalvm.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.geekyants.com/diving-deep-into-graalvm-and-mastering-the-art-of-observability-using-micrometer-37e59038a8ee">https://blog.geekyants.com/diving-deep-into-graalvm-and-mastering-the-art-of-observability-using-micrometer-37e59038a8ee</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/graalvm/graalvm-in-2023-a-year-in-review-60f7f0635671">https://medium.com/graalvm/graalvm-in-2023-a-year-in-review-60f7f0635671</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/graalvm/graalvm-for-jdk-21-is-here-ee01177dd12d#0df7">https://medium.com/graalvm/graalvm-for-jdk-21-is-here-ee01177dd12d#0df7</a></p>
<p><a target="_blank" rel="noopener" href="https://build-native-java-apps.cc/native-image/">https://build-native-java-apps.cc/native-image/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/reference-manual/native-image/overview/Options/">https://www.graalvm.org/latest/reference-manual/native-image/overview/Options/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/tools/visualvm/">https://www.graalvm.org/latest/tools/visualvm/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.graalvm.org/latest/reference-manual/native-image/guides/build-and-run-native-executable-with-jfr/">https://www.graalvm.org/latest/reference-manual/native-image/guides/build-and-run-native-executable-with-jfr/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.loicmathieu.fr/wordpress/en/informatique/profiler-une-image-native-graalvm-avec-perf/">https://www.loicmathieu.fr/wordpress/en/informatique/profiler-une-image-native-graalvm-avec-perf/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/07/spring-rabbitmq-consumer-reconnect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/07/spring-rabbitmq-consumer-reconnect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">spring rabbitmq consumer reconnect源码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-07 15:11:00" itemprop="dateCreated datePublished" datetime="2023-11-07T15:11:00+08:00">2023-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 11:32:59" itemprop="dateModified" datetime="2024-02-27T11:32:59+08:00">2024-02-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、起因"><a href="#一、起因" class="headerlink" title="一、起因"></a>一、起因</h1><p>某日深夜，生产环境，rabbitmq服务器集群宕机，收到企微告警，以为rabbitmq server端有灾难恢复和高可用机制，业务不会受影响，就没关注该异常。</p>
<p>早上，到公司之后，就被运维告知，负责的某个服务消费的queue有消息积压，和平常的业务表现不同，隐约感觉和晚上的rabbitmq服务器异常有关。检查服务日志，发现服务没有消费rabbitmq数据，grafana上消费的某些queue consumer数量为0，而某些queue consumer正常。</p>
<p><strong>疑问</strong>：该服务对rabbitmq的使用，抽象一下，A-&gt;B-&gt;C，其中A\B\C是queue，现象是rabbitmq server发生宕机恢复后，服务对A\B queue consumer 数量为0，服务对A\B queue consumer 数量正常，spring rabbitmq consumer reconnect客户端机制是怎么样的？为什么会有差异？</p>
<h1 id="二、源码分析"><a href="#二、源码分析" class="headerlink" title="二、源码分析"></a>二、源码分析</h1><p>带着疑问，分析服务业务代码，阅读spring rabbitmq源码。</p>
<p><strong>结论</strong>：发现服务对A\B\C queue的消费，有差异，差异造成了rabbitmq server发生宕机恢复后，consumer reconnect表现形式不同，其中A\B使用的是@RabbitListener注解，底层是<strong>SimpleMessageListenerContainer</strong>，C是继承的接口MessageListener，底层是<strong>DirectMessageListenerContainer</strong>。</p>
<p>从日志搜索关键字，</p>
<ul>
<li><em><strong>SimpleMessageListenerContainer</strong></em>，有限次重试reconnect，日志只有打印几次关键字：<em><strong>“Consumer threw missing queues exception, fatal=true”</strong></em>，<em><strong>“Stopping container from aborted consumer”</strong></em>，<em><strong>“Restarting Consumer XXX”</strong></em>。</li>
<li><em><strong>DirectMessageListenerContainer</strong></em>，有不断重试reconnect，日志有不断打印关键字：***”Queue not present, scheduling consumer XXX for queue  XXX for restart”***</li>
</ul>
<p>生产环境，springboot版本为2.4.6，spring-rabbit版本为2.3.7；以下源码，springboot版本为3.1.5，spring-rabbit版本为3.0.10。</p>
<h2 id="1-SimpleMessageListenerContainer"><a href="#1-SimpleMessageListenerContainer" class="headerlink" title="1.SimpleMessageListenerContainer"></a>1.SimpleMessageListenerContainer</h2><p>SimpleMessageListenerContainer消费者consumer核心逻辑在<strong>org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.AsyncMessageProcessingConsumer</strong>类，AsyncMessageProcessingConsumer是一个Runnable，主要逻辑在run方法，主要是控制逻辑，真正的消费逻辑，在内部属性BlockingQueueConsumer类，源码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">#org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.AsyncMessageProcessingConsumer</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncMessageProcessingConsumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueueConsumer consumer; <span class="comment">//真正的消费mq逻辑,其他属性略</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// NOSONAR - complexity - many catch blocks</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// NOSONAR - line count</span></span><br><span class="line">      <span class="keyword">if</span> (!isActive()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.start.countDown();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>; <span class="comment">//重要的标志位，异常时为true</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.consumer.setLocallyTransacted(isChannelLocallyTransacted());</span><br><span class="line"></span><br><span class="line">      String routingLookupKey = getRoutingLookupKey();</span><br><span class="line">      <span class="keyword">if</span> (routingLookupKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">        SimpleResourceHolder.bind(getRoutingConnectionFactory(), routingLookupKey); <span class="comment">// NOSONAR both never null</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.consumer.getQueueCount() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Consumer stopping; no queues for &quot;</span> + <span class="keyword">this</span>.consumer);</span><br><span class="line">        &#125;</span><br><span class="line">        SimpleMessageListenerContainer.<span class="keyword">this</span>.cancellationLock.release(<span class="keyword">this</span>.consumer);</span><br><span class="line">        <span class="keyword">if</span> (getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">          getApplicationEventPublisher().publishEvent(</span><br><span class="line">            <span class="keyword">new</span> AsyncConsumerStoppedEvent(SimpleMessageListenerContainer.<span class="keyword">this</span>, <span class="keyword">this</span>.consumer));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.start.countDown();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        initialize();</span><br><span class="line">        <span class="keyword">while</span> (isActive(<span class="keyword">this</span>.consumer) || <span class="keyword">this</span>.consumer.hasDelivery() || !<span class="keyword">this</span>.consumer.cancelled()) &#123;</span><br><span class="line">          mainLoop(); <span class="comment">//有条件的死循环，mainLoop为BlockingQueueConsumer consumer真正消费rabbitmq消息，mainLoop不是异常重连reconnect的重点，重点关注while的循环条件，发生异常或者，不满足条件时，会跳出死循环。</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Consumer thread interrupted, processing stopped.&quot;</span>);</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">        aborted = <span class="keyword">true</span>;</span><br><span class="line">        publishConsumerFailedEvent(<span class="string">&quot;Consumer thread interrupted, processing stopped&quot;</span>, <span class="keyword">true</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (QueuesNotAvailableException ex) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Consumer threw missing queues exception, fatal=&quot;</span> + isMissingQueuesFatal(), ex); <span class="comment">//该日志就是日志输出的异常，rabbitmq server端不可用，这时aborted标志位会设置为true。</span></span><br><span class="line">        <span class="keyword">if</span> (isMissingQueuesFatal()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.startupException = ex;</span><br><span class="line">          <span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">          aborted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        publishConsumerFailedEvent(<span class="string">&quot;Consumer queue(s) not available&quot;</span>, aborted, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (FatalListenerStartupException ex) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Consumer received fatal exception on startup&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">this</span>.startupException = ex;</span><br><span class="line">        <span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">        aborted = <span class="keyword">true</span>;</span><br><span class="line">        publishConsumerFailedEvent(<span class="string">&quot;Consumer received fatal exception on startup&quot;</span>, <span class="keyword">true</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (FatalListenerExecutionException ex) &#123; <span class="comment">// NOSONAR exception as flow control</span></span><br><span class="line">        logger.error(<span class="string">&quot;Consumer received fatal exception during processing&quot;</span>, ex);</span><br><span class="line">        <span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">        aborted = <span class="keyword">true</span>;</span><br><span class="line">        publishConsumerFailedEvent(<span class="string">&quot;Consumer received fatal exception during processing&quot;</span>, <span class="keyword">true</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (PossibleAuthenticationFailureException ex) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Consumer received fatal=&quot;</span> + isPossibleAuthenticationFailureFatal() +</span><br><span class="line">                     <span class="string">&quot; exception during processing&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">if</span> (isPossibleAuthenticationFailureFatal()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.startupException =</span><br><span class="line">            <span class="keyword">new</span> FatalListenerStartupException(<span class="string">&quot;Authentication failure&quot;</span>,</span><br><span class="line">                                              <span class="keyword">new</span> AmqpAuthenticationException(ex));</span><br><span class="line">          <span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">          aborted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        publishConsumerFailedEvent(<span class="string">&quot;Consumer received PossibleAuthenticationFailure during startup&quot;</span>, aborted, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ShutdownSignalException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (RabbitUtils.isNormalShutdown(e)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Consumer received Shutdown Signal, processing stopped: &quot;</span> + e.getMessage());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          logConsumerException(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (AmqpIOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.getCause() <span class="keyword">instanceof</span> IOException &amp;&amp; e.getCause().getCause() <span class="keyword">instanceof</span> ShutdownSignalException</span><br><span class="line">            &amp;&amp; e.getCause().getCause().getMessage().contains(<span class="string">&quot;in exclusive use&quot;</span>)) &#123;</span><br><span class="line">          getExclusiveConsumerExceptionLogger().log(logger,</span><br><span class="line">                                                    <span class="string">&quot;Exclusive consumer failure&quot;</span>, e.getCause().getCause());</span><br><span class="line">          publishConsumerFailedEvent(<span class="string">&quot;Consumer raised exception, attempting restart&quot;</span>, <span class="keyword">false</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          logConsumerException(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Error e) &#123; <span class="comment">//NOSONAR</span></span><br><span class="line">        logger.error(<span class="string">&quot;Consumer thread error, thread abort.&quot;</span>, e);</span><br><span class="line">        publishConsumerFailedEvent(<span class="string">&quot;Consumer threw an Error&quot;</span>, <span class="keyword">true</span>, e);</span><br><span class="line">        getJavaLangErrorHandler().handle(e);</span><br><span class="line">        aborted = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">//NOSONAR</span></span><br><span class="line">        <span class="comment">// by now, it must be an exception</span></span><br><span class="line">        <span class="keyword">if</span> (isActive()) &#123;</span><br><span class="line">          logConsumerException(t);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getTransactionManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">          ConsumerChannelRegistry.unRegisterConsumerChannel();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// In all cases count down to allow container to progress beyond startup</span></span><br><span class="line">      <span class="keyword">this</span>.start.countDown();</span><br><span class="line"></span><br><span class="line">      killOrRestart(aborted); <span class="comment">//当发生异常，当前AsyncMessageProcessingConsumer会跳出死循环，aborted=true。</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (routingLookupKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">        SimpleResourceHolder.unbind(getRoutingConnectionFactory()); <span class="comment">// NOSONAR never null here</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">killOrRestart</span><span class="params">(<span class="keyword">boolean</span> aborted)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!isActive(<span class="keyword">this</span>.consumer) || aborted) &#123; <span class="comment">//注意IF条件，二选一为真会进入，aborted=true，会执行stop方法</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Cancelling &quot;</span> + <span class="keyword">this</span>.consumer);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.consumer.stop();</span><br><span class="line">          SimpleMessageListenerContainer.<span class="keyword">this</span>.cancellationLock.release(<span class="keyword">this</span>.consumer);</span><br><span class="line">          <span class="keyword">if</span> (getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            getApplicationEventPublisher().publishEvent(</span><br><span class="line">              <span class="keyword">new</span> AsyncConsumerStoppedEvent(SimpleMessageListenerContainer.<span class="keyword">this</span>, <span class="keyword">this</span>.consumer));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (AmqpException e) &#123;</span><br><span class="line">          logger.info(<span class="string">&quot;Could not cancel message consumer&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (aborted &amp;&amp; SimpleMessageListenerContainer.<span class="keyword">this</span>.containerStoppingForAbort</span><br><span class="line">            .compareAndSet(<span class="keyword">null</span>, Thread.currentThread())) &#123;</span><br><span class="line">          logger.error(<span class="string">&quot;Stopping container from aborted consumer&quot;</span>);</span><br><span class="line">          stop(); <span class="comment">//stop是核心方法,stop是父类AbstractMessageListenerContainer的方法</span></span><br><span class="line">          SimpleMessageListenerContainer.<span class="keyword">this</span>.containerStoppingForAbort.set(<span class="keyword">null</span>);</span><br><span class="line">          ListenerContainerConsumerFailedEvent event = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              event = SimpleMessageListenerContainer.<span class="keyword">this</span>.abortEvents.poll(ABORT_EVENT_WAIT_SECONDS,</span><br><span class="line">                                                                           TimeUnit.SECONDS);</span><br><span class="line">              <span class="keyword">if</span> (event != <span class="keyword">null</span>) &#123;</span><br><span class="line">                SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(</span><br><span class="line">                  event.getReason(), event.isFatal(), event.getThrowable());</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> (event != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123; <span class="comment">//不满足!isActive(this.consumer) || aborted，会重启consumer，即BlockingQueueConsumer</span></span><br><span class="line">        logger.info(<span class="string">&quot;Restarting &quot;</span> + <span class="keyword">this</span>.consumer);<span class="comment">//日志的关键字，也有Restarting关键字</span></span><br><span class="line">        restart(<span class="keyword">this</span>.consumer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>而AbstractMessageListenerContainer的stop方法，调用的是shutdown方法，shutdown方法，是把AbstractMessageListenerContainer的active设置为false。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#org.springframework.amqp.rabbit.listener.<span class="function">AbstractMessageListenerContainer	</span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">(<span class="meta">@Nullable</span> Runnable callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.lifecycleMonitor) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isActive()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Shutdown ignored - container is not active already&quot;</span>);</span><br><span class="line">      <span class="keyword">this</span>.lifecycleMonitor.notifyAll();</span><br><span class="line">      <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        callback.run();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.active = <span class="keyword">false</span>; <span class="comment">//设置active为false</span></span><br><span class="line">    <span class="keyword">this</span>.lifecycleMonitor.notifyAll();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  logger.debug(<span class="string">&quot;Shutting down Rabbit listener container&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Shut down the invokers.</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    shutdownAndWaitOrCallback(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> convertRabbitAccessException(ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    setNotRunning();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而其他consumer，AsyncMessageProcessingConsumer的mainLoop while死循环，判断条件isActive（）会使用到AbstractMessageListenerContainer的active方法，其他的AsyncMessageProcessingConsumer consumer，就会进入killOrRestart方法的else方法，重启consumer。（参考AsyncMessageProcessingConsumer的run方法）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.<span class="function">AsyncMessageProcessingConsumer</span></span><br><span class="line"><span class="function">  <span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">(BlockingQueueConsumer consumer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> consumerActive;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">    consumerActive = <span class="keyword">this</span>.consumers != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.consumers.contains(consumer);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> consumerActive &amp;&amp; <span class="keyword">this</span>.isActive();<span class="comment">//this.isActive()调用父类AbstractMessageListenerContainer的方法，判断AbstractMessageListenerContainer的active属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上，SimpleMessageListenerContainer的reconnect机制，只是有限次数，和线上日志的表现形式一致。</p>
<h2 id="2-DirectMessageListenerContainer"><a href="#2-DirectMessageListenerContainer" class="headerlink" title="2.DirectMessageListenerContainer"></a>2.DirectMessageListenerContainer</h2><p>DirectMessageListenerContainer消费者consumer核心逻辑在<strong>org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer</strong>类，核心方法是actualStart，其中启动consumer的方法是startConsumers，但是startConsumers不是reconnect机制的重点，reconnect机制的核心代码是startMonitor，startMonitor是启动的后台线程，不断检查consumer状态，异常时consumer reconnect，源码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.<span class="function">DirectMessageListenerContainer</span></span><br><span class="line"><span class="function">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">actualStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.aborted = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">this</span>.hasStopped = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (getPrefetchCount() &lt; <span class="keyword">this</span>.messagesPerAck) &#123;</span><br><span class="line">    setPrefetchCount(<span class="keyword">this</span>.messagesPerAck);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">super</span>.doStart();</span><br><span class="line">  <span class="keyword">final</span> String[] queueNames = getQueueNames();</span><br><span class="line">  checkMissingQueues(queueNames);</span><br><span class="line">  checkConnect();</span><br><span class="line">  <span class="keyword">long</span> idleEventInterval = getIdleEventInterval();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.taskScheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">    afterPropertiesSet();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (idleEventInterval &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.monitorInterval &gt; idleEventInterval) &#123;</span><br><span class="line">    <span class="keyword">this</span>.monitorInterval = idleEventInterval / <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (getFailedDeclarationRetryInterval() &lt; <span class="keyword">this</span>.monitorInterval) &#123;</span><br><span class="line">    <span class="keyword">this</span>.monitorInterval = getFailedDeclarationRetryInterval();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> Map&lt;String, Queue&gt; namesToQueues = getQueueNamesToQueues();</span><br><span class="line">  <span class="keyword">this</span>.lastRestartAttempt = System.currentTimeMillis();</span><br><span class="line">  startMonitor(idleEventInterval, namesToQueues);<span class="comment">//consumer reconnect核心代码</span></span><br><span class="line">  <span class="keyword">if</span> (queueNames.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    doRedeclareElementsIfNecessary();</span><br><span class="line">    getTaskExecutor().execute(() -&gt; &#123; <span class="comment">// NOSONAR never null here</span></span><br><span class="line">      startConsumers(queueNames);<span class="comment">//启动consumer，非reconnenct机制重点</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.started = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.startedLatch.countDown();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.logger.info(<span class="string">&quot;Container initialized for queues: &quot;</span> + Arrays.asList(queueNames));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>startMonitor方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.<span class="function">DirectMessageListenerContainer</span></span><br><span class="line"><span class="function">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startMonitor</span><span class="params">(<span class="keyword">long</span> idleEventInterval, <span class="keyword">final</span> Map&lt;String, Queue&gt; namesToQueues)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.consumerMonitorTask = <span class="keyword">this</span>.taskScheduler.scheduleAtFixedRate(() -&gt; &#123; <span class="comment">//固定间隔运行的后台线程</span></span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    checkIdle(idleEventInterval, now);</span><br><span class="line">    checkConsumers(now); <span class="comment">//检查consumer是否可用，不可用，放入consumersToRestart队列</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.lastRestartAttempt + getFailedDeclarationRetryInterval() &lt; now) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.started) &#123;</span><br><span class="line">          List&lt;SimpleConsumer&gt; restartableConsumers = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.consumersToRestart); <span class="comment">//consumersToRestart需要重连的consumer</span></span><br><span class="line">          <span class="keyword">this</span>.consumersToRestart.clear();</span><br><span class="line">          <span class="keyword">if</span> (restartableConsumers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            doRedeclareElementsIfNecessary();</span><br><span class="line">          &#125;</span><br><span class="line">          Iterator&lt;SimpleConsumer&gt; iterator = restartableConsumers.iterator();</span><br><span class="line">          <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            SimpleConsumer consumer = iterator.next();</span><br><span class="line">            iterator.remove();</span><br><span class="line">            <span class="keyword">if</span> (DirectMessageListenerContainer.<span class="keyword">this</span>.removedQueues.contains(consumer.getQueue())) &#123;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.debug(<span class="string">&quot;Skipping restart of consumer, queue removed &quot;</span> + consumer);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">              <span class="keyword">this</span>.logger.debug(<span class="string">&quot;Attempting to restart consumer &quot;</span> + consumer);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!restartConsumer(namesToQueues, restartableConsumers, consumer)) &#123;<span class="comment">//重连consumer</span></span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.lastRestartAttempt = now;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    processMonitorTask();</span><br><span class="line">  &#125;, Duration.ofMillis(<span class="keyword">this</span>.monitorInterval));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConsumers</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> List&lt;SimpleConsumer&gt; consumersToCancel;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">    consumersToCancel = <span class="keyword">this</span>.consumers.stream()</span><br><span class="line">      .filter(consumer -&gt; &#123;</span><br><span class="line">        <span class="keyword">boolean</span> open = consumer.getChannel().isOpen() &amp;&amp; !consumer.isAckFailed() <span class="comment">//检查consumer是否可用</span></span><br><span class="line">          &amp;&amp; !consumer.targetChanged();</span><br><span class="line">        <span class="keyword">if</span> (open &amp;&amp; <span class="keyword">this</span>.messagesPerAck &gt; <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            consumer.ackIfNecessary(now);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.error(<span class="string">&quot;Exception while sending delayed ack&quot;</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !open;</span><br><span class="line">      &#125;)</span><br><span class="line">      .collect(Collectors.toList());</span><br><span class="line">  &#125;</span><br><span class="line">  consumersToCancel</span><br><span class="line">    .forEach(consumer -&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        RabbitUtils.closeMessageConsumer(consumer.getChannel(),</span><br><span class="line">                                         Collections.singletonList(consumer.getConsumerTag()), isChannelTransacted());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Error closing consumer &quot;</span> + consumer, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer canceled - channel closed &quot;</span> + consumer);</span><br><span class="line">      consumer.cancelConsumer(<span class="string">&quot;Consumer &quot;</span> + consumer + <span class="string">&quot; channel closed&quot;</span>); <span class="comment">//不可用的consumer，调用SimpleConsumer的cancel方法</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SimpleConsumer的cancelConsumer方法，把当前SimpleConsumer调用DirectMessageListenerContainer的addConsumerToRestart方法，添加到consumersToRestart集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer.<span class="function">SimpleConsumer</span></span><br><span class="line"><span class="function">  <span class="keyword">void</span> <span class="title">cancelConsumer</span><span class="params">(<span class="keyword">final</span> String eventMessage)</span> </span>&#123;</span><br><span class="line">  publishConsumerFailedEvent(eventMessage, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">synchronized</span> (DirectMessageListenerContainer.<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">    List&lt;SimpleConsumer&gt; list = DirectMessageListenerContainer.<span class="keyword">this</span>.consumersByQueue.get(<span class="keyword">this</span>.queue);</span><br><span class="line">    <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">      list.remove(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    DirectMessageListenerContainer.<span class="keyword">this</span>.consumers.remove(<span class="keyword">this</span>);</span><br><span class="line">    addConsumerToRestart(<span class="keyword">this</span>);<span class="comment">//调用SimpleConsumer自己，添加到DirectMessageListenerContainer的consumersToRestart</span></span><br><span class="line">  &#125;</span><br><span class="line">  finalizeConsumer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DirectMessageListenerContainer的addConsumerToRestart方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer</span><br><span class="line">private void addConsumerToRestart(SimpleConsumer consumer) &#123;</span><br><span class="line">this.consumersToRestart.add(consumer);</span><br><span class="line">if (this.logger.isTraceEnabled()) &#123;</span><br><span class="line">this.logger.trace(&quot;Consumers to restart now: &quot; + this.consumersToRestart);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上，DirectMessageListenerContainer的reconnect机制，是因为有后台线程保证，只是无限次数，和线上日志的表现形式一致。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><p>DirectMessageListenerContainer的reconnect机制，比SimpleMessageListenerContainer完备。如果rabbitmq server段，闪断的情况，SimpleMessageListenerContainer可以处理，如果时间一长，SimpleMessageListenerContainer的reconnect实现机制，就不能处理，而DirectMessageListenerContainer的实现机制更合理、更完备。</p>
<h1 id="三、修复方案"><a href="#三、修复方案" class="headerlink" title="三、修复方案"></a>三、修复方案</h1><p>本着，最小改动，最小代价修复问题的方针，方案：修改@RabbitListener注解的<strong>containerFactory</strong>。根据javadoc，containerFactory return的是org.springframework.amqp.rabbit.listener.RabbitListenerContainerFactory，RabbitListenerContainerFactory的几种实现如下，</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/fz9c7e.png" alt="image-20231107191734155"></p>
<p>只需要，选择org.springframework.amqp.rabbit.config.DirectRabbitListenerContainerFactory实现就好，springboot其实已经贴心留好了钩子，只需要设置属性<em><strong>spring.rabbitmq.listener=direct</strong></em>即可切换containerFactory为DirectRabbitListenerContainerFactory，不需要更改代码。</p>
<p>另外注意切换containerFactory后，如果使用了@RabbitListener注解的<strong>concurrency</strong>并发度，可能需要适配修改。原因如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Set the concurrency of the listener container for this listener. Overrides the</span></span><br><span class="line"><span class="comment">	 * default set by the listener container factory. Maps to the concurrency setting of</span></span><br><span class="line"><span class="comment">	 * the container type.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;For a</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer</span></span><br><span class="line"><span class="comment">	 * SimpleMessageListenerContainer&#125; if this value is a simple integer, it sets a fixed</span></span><br><span class="line"><span class="comment">	 * number of consumers in the &#123;<span class="doctag">@code</span> concurrentConsumers&#125; property. If it is a string</span></span><br><span class="line"><span class="comment">	 * with the form &#123;<span class="doctag">@code</span> &quot;m-n&quot;&#125;, the &#123;<span class="doctag">@code</span> concurrentConsumers&#125; is set to &#123;<span class="doctag">@code</span> m&#125;</span></span><br><span class="line"><span class="comment">	 * and the &#123;<span class="doctag">@code</span> maxConcurrentConsumers&#125; is set to &#123;<span class="doctag">@code</span> n&#125;.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;For a</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer</span></span><br><span class="line"><span class="comment">	 * DirectMessageListenerContainer&#125; it sets the &#123;<span class="doctag">@code</span> consumersPerQueue&#125; property.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the concurrency.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="function">String <span class="title">concurrency</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>; <span class="comment">//SimpleMessageListenerContainer的concurrency是自适应的，之前生产的设置就是m-n</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/02/rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/02/rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)/" class="post-title-link" itemprop="url">rocketmq源码解析（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-02 22:56:26" itemprop="dateCreated datePublished" datetime="2023-07-02T22:56:26+08:00">2023-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 14:11:17" itemprop="dateModified" datetime="2024-02-27T14:11:17+08:00">2024-02-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、RocketMQ"><a href="#一、RocketMQ" class="headerlink" title="一、RocketMQ"></a>一、RocketMQ</h1><p>摘自<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">官网</a>的简介：</p>
<blockquote>
<p>RocketMQ 5.0: A cloud-native “messaging, eventing, streaming” real-time data processing platform, covering cloud-edge-device collaboration scenarios</p>
</blockquote>
<h1 id="二、从Quick-Start开始阅读和DEBUG源码"><a href="#二、从Quick-Start开始阅读和DEBUG源码" class="headerlink" title="二、从Quick Start开始阅读和DEBUG源码"></a>二、从Quick Start开始阅读和DEBUG源码</h1><p>个人认为，最高效的学习技术的方法，是在实际项目中运用技术，在不断解决问题中理解技术。如果没有实际项目运用，开源项目也是很好的快速提高个人技术水平的切入点。</p>
<p>简单调用开源项目的API，完成简单的DEMO，有用，但是，并不是深入理解开源项目的方式。</p>
<ul>
<li>阅读文档</li>
<li>阅读源码</li>
<li>DEBUG源码</li>
</ul>
<p>三种方式，难易度：阅读文档 &gt; 阅读源码 &gt; DEBUG源码；深入理解：DEBUG源码 &gt; 阅读源码 &gt; 阅读源码 。</p>
<p>下面，我们讲，以<em><strong>个人的理解</strong></em>，不太多的阅读文档和概念，直接从Quick Start开始，简单粗暴的阅读和DEBUG rocketmq的源码。</p>
<h2 id="2-1-IDEA启动Broker"><a href="#2-1-IDEA启动Broker" class="headerlink" title="2.1 IDEA启动Broker"></a>2.1 IDEA启动Broker</h2><p>首先，根据<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quickStart/01quickstart/">Quick Start</a>文档，以<strong>RocketMQ 5.1.3</strong>版本为例</p>
<ul>
<li>下载RocketMQ的源码、编译。</li>
<li>启动NameServer</li>
<li>启动 Broker and Proxy，这里和Qucick Start文档，稍微有点不一样，因为需要DEBUG，我们直接从github上，clone rocketmq的源码，然后启动源码的Broker，不是使用编译好的二进制Broker，方便后续DEBUG源码。</li>
<li>发送和接收消息，可以用tools或者SDK.</li>
</ul>
<p>其中，注意源码启动rocketmq的Broker代码时，使用JDK8，因为rocketmq使用了1.8的sun.misc包下面的Unsafe类。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-022500.jpg" alt="008vOhrAgy1hfizmg30e1j31y00egn0f"></p>
<p>其实官方在github和文档两处也提到了JDK版本的要求，只是我本人的电脑使用的比较高版本的JDK：</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-023653-20240227140148550.jpg" alt="008vOhrAgy1hfj03vlgc8j31g80haac3"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-023756.jpg" alt="008vOhrAgy1hfj05cy5u9j31bq0bgdh0"></p>
<p>如何设置JDK版本，参考下图</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-023846.jpg" alt="008vOhrAgy1hfizrcrpnhj31010u00u6"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-023954.jpg" alt="008vOhrAgy1hfizsam0edj31at0u0whq"></p>
<p>如何找到入口，从哪里入手阅读和DEBUG源码？</p>
<p>我们注意到，<em><strong>Start Broker and Proxy</strong></em>，是这样启动Broker的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## start broker</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nohup sh bin/mqbroker -n localhost:9876 --enable-proxy &amp;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## verify broker</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tail -f ~/logs/rocketmqlogs/proxy.log</span> </span><br><span class="line">The broker[broker-a,192.169.1.2:10911] boot success...</span><br></pre></td></tr></table></figure>

<p>按照shell里面的位置，找到distribution/bin/mqbroker，其中，需要关注的环境变量和参数，是ROCKETMQ_HOME和$enable_proxy，</p>
<p>从以下截图中，可以看到，rocketmq的入口，是org.apache.rocketmq.proxy.ProxyStartup。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024028.jpg" alt="008vOhrAgy1hfj0chkph1j31h70u0q83"></p>
<p>runserver.sh中逻辑，主要是设置Java参数，比如GC，如果只是DEBUG，这些不是必须的。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024053.jpg" alt="008vOhrAgy1hfj1b48wcyj31j40u079x"></p>
<p>使用如下环境变量，就能在IDEA中RUN起来了：</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024113.jpg" alt="008vOhrAgy1hfj188t5vdj31lw0u0dms"></p>
<p>其中，比较迷惑的是，如果按照mqbroker shell中的enable_proxy逻辑，启动参数中，是需要加***-pm local<em><strong>的，这样反而DEBUG的时候，程序会推出，</strong></em>System.exit(0)***，启动不了。这点很迷惑。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024212.jpg" alt="008vOhrAgy1hfj1ejdyvuj31it0u0dnr"></p>
<p>按照<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quickStart/01quickstart#4-send-and-receive-messages-with-tools">Send and Receive Messages with tools</a>的方式，不打断点的方式，成功验证Broker是否成功启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span></span><br><span class="line"> SendResult [sendStatus=SEND_OK, msgId= ...</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span></span><br><span class="line"><span class="meta"> ConsumeMessageThread_%</span><span class="bash">d Receive New Messages: [MessageExt...</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024238.jpg" alt="008vOhrAgy1hfj1ji2xumj32gu06sjyi"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024248.jpg" alt="008vOhrAgy1hfj1l7ej0mj32jc0bok0d"></p>
<h2 id="2-2-DEBUG-Brocker"><a href="#2-2-DEBUG-Brocker" class="headerlink" title="2.2 DEBUG Brocker"></a>2.2 DEBUG Brocker</h2><p> 以下，使用断点调试。</p>
<p>如何找到断点入口，从哪里开始调试代码？</p>
<p>注意：org.apache.rocketmq.example.quickstart.Producer，消息生产者的代码入手：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.example.quickstart.Producer#main</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException </span>&#123;</span><br><span class="line">  DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(PRODUCER_GROUP);</span><br><span class="line">  producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);</span><br><span class="line">  producer.start();</span><br><span class="line">  Message msg = <span class="keyword">new</span> Message(TOPIC <span class="comment">/* Topic */</span>,</span><br><span class="line">                            TAG <span class="comment">/* Tag */</span>,</span><br><span class="line">                            (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">                           );</span><br><span class="line">  SendResult sendResult = producer.send(msg); <span class="comment">//调用的是org.apache.rocketmq.client.producer.DefaultMQProducer发送send方法</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.rocketmq.client.producer.DefaultMQProducer，只是很薄的一层封装，直接调用实现类DefaultMQProducerImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.producer.DefaultMQProducer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  Message msg)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">  msg.setTopic(withNamespace(msg.getTopic()));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.defaultMQProducerImpl.send(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl，是比较核心的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DEFAULT ASYNC -------------------------------------------------------</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">                 SendCallback sendCallback)</span> <span class="keyword">throws</span> MQClientException, RemotingException, InterruptedException </span>&#123;</span><br><span class="line">  send(msg, sendCallback, <span class="keyword">this</span>.defaultMQProducer.getSendMsgTimeout());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> SendCallback sendCallback, <span class="keyword">final</span> <span class="keyword">long</span> timeout)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> MQClientException, RemotingException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">  Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">long</span> costTime = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">      <span class="keyword">if</span> (timeout &gt; costTime) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          sendDefaultImpl(msg, CommunicationMode.ASYNC, sendCallback, timeout - costTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          sendCallback.onException(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sendCallback.onException(</span><br><span class="line">          <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;DEFAULT ASYNC send call timeout&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  executeAsyncMessageSend(runnable, msg, sendCallback, timeout, beginStartTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后的sendDefaultImpl逻辑，调用栈比较深，不是这次的重点。</p>
<p>sendDefaultImpl  =&gt; sendKernelImpl</p>
<p>最终调用的是org.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessage发送，相当于是底层API。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.MQClientAPIImpl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">  <span class="keyword">case</span> ASYNC:</span><br><span class="line">    Message tmpMessage = msg;</span><br><span class="line">    <span class="keyword">boolean</span> messageCloned = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (msgBodyCompressed) &#123;</span><br><span class="line">      <span class="comment">//If msg body was compressed, msgbody should be reset using prevBody.</span></span><br><span class="line">      <span class="comment">//Clone new message using commpressed message body and recover origin massage.</span></span><br><span class="line">      <span class="comment">//Fix bug:https://github.com/apache/rocketmq-externals/issues/66</span></span><br><span class="line">      tmpMessage = MessageAccessor.cloneMessage(msg);</span><br><span class="line">      messageCloned = <span class="keyword">true</span>;</span><br><span class="line">      msg.setBody(prevBody);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (topicWithNamespace) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!messageCloned) &#123;</span><br><span class="line">        tmpMessage = MessageAccessor.cloneMessage(msg);</span><br><span class="line">        messageCloned = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), <span class="keyword">this</span>.defaultMQProducer.getNamespace()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> costTimeAsync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">    <span class="keyword">if</span> (timeout &lt; costTimeAsync) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;sendKernelImpl call timeout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">      brokerAddr,</span><br><span class="line">      brokerName,</span><br><span class="line">      tmpMessage,</span><br><span class="line">      requestHeader,</span><br><span class="line">      timeout - costTimeAsync,</span><br><span class="line">      communicationMode,</span><br><span class="line">      sendCallback,</span><br><span class="line">      topicPublishInfo,</span><br><span class="line">      <span class="keyword">this</span>.mQClientFactory,</span><br><span class="line">      <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(),</span><br><span class="line">      context,</span><br><span class="line">      <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.rocketmq.client.impl.MQClientAPIImpl的sendMessage中，有个需要关注的地方，Producer或者说Client端，最终发送出去的数据结构是：<em><strong>RemotingCommand</strong></em>，这也是我们后续DEBUG  Broker的关键点之一。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.MQClientAPIImpl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SendResult <span class="title">sendMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> String addr,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> String brokerName,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> SendMessageRequestHeader requestHeader,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> CommunicationMode communicationMode,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> SendCallback sendCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> TopicPublishInfo topicPublishInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> MQClientInstance instance,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> <span class="keyword">int</span> retryTimesWhenSendFailed,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> SendMessageContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> DefaultMQProducerImpl producer</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">  RemotingCommand request = <span class="keyword">null</span>; <span class="comment">//第一次出现RemotingCommand</span></span><br><span class="line">  String msgType = msg.getProperty(MessageConst.PROPERTY_MESSAGE_TYPE);</span><br><span class="line">  <span class="keyword">boolean</span> isReply = msgType != <span class="keyword">null</span> &amp;&amp; msgType.equals(MixAll.REPLY_MESSAGE_FLAG);</span><br><span class="line">  <span class="keyword">if</span> (isReply) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sendSmartMsg) &#123;</span><br><span class="line">      SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);</span><br><span class="line">      request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE_V2, requestHeaderV2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE, requestHeader);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sendSmartMsg || msg <span class="keyword">instanceof</span> MessageBatch) &#123;</span><br><span class="line">      SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);</span><br><span class="line">      request = RemotingCommand.createRequestCommand(msg <span class="keyword">instanceof</span> MessageBatch ? RequestCode.SEND_BATCH_MESSAGE : RequestCode.SEND_MESSAGE_V2, requestHeaderV2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      request = RemotingCommand.createRequestCommand(RequestCode.SEND_MESSAGE, requestHeader);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  request.setBody(msg.getBody());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> ONEWAY:</span><br><span class="line">      <span class="keyword">this</span>.remotingClient.invokeOneway(addr, request, timeoutMillis);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">case</span> ASYNC:</span><br><span class="line">      <span class="keyword">final</span> AtomicInteger times = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">      <span class="keyword">long</span> costTimeAsync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">      <span class="keyword">if</span> (timeoutMillis &lt; costTimeAsync) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;sendMessage call timeout&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//调用异步接口发送RemotingCommand</span></span><br><span class="line">      <span class="keyword">this</span>.sendMessageAsync(addr, brokerName, msg, timeoutMillis - costTimeAsync, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, context, producer);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">case</span> SYNC:</span><br><span class="line">      <span class="keyword">long</span> costTimeSync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">      <span class="keyword">if</span> (timeoutMillis &lt; costTimeSync) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;sendMessage call timeout&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.sendMessageSync(addr, brokerName, msg, timeoutMillis - costTimeSync, request);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在sendMessageAsync方法中，发现remotingClient发送的数据，那remotingClient又是什么啦？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.MQClientAPIImpl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessageAsync</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> String addr,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> String brokerName,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> RemotingCommand request,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> SendCallback sendCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> TopicPublishInfo topicPublishInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> MQClientInstance instance,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> <span class="keyword">int</span> retryTimesWhenSendFailed,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> AtomicInteger times,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> SendMessageContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> DefaultMQProducerImpl producer</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.remotingClient.invokeAsync(addr, request, timeoutMillis, <span class="keyword">new</span> InvokeCallback() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ResponseFuture responseFuture)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> cost = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">        RemotingCommand response = responseFuture.getResponseCommand();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == sendCallback &amp;&amp; response != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            SendResult sendResult = MQClientAPIImpl.<span class="keyword">this</span>.processSendResponse(brokerName, msg, response, addr);</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span> &amp;&amp; sendResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">              context.setSendResult(sendResult);</span><br><span class="line">              context.getProducer().executeSendMessageHookAfter(context);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">false</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            SendResult sendResult = MQClientAPIImpl.<span class="keyword">this</span>.processSendResponse(brokerName, msg, response, addr);</span><br><span class="line">            <span class="keyword">assert</span> sendResult != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">              context.setSendResult(sendResult);</span><br><span class="line">              context.getProducer().executeSendMessageHookAfter(context);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              sendCallback.onSuccess(sendResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">false</span>);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">true</span>);</span><br><span class="line">            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, e, context, <span class="keyword">false</span>, producer);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">true</span>);</span><br><span class="line">          <span class="keyword">if</span> (!responseFuture.isSendRequestOK()) &#123;</span><br><span class="line">            MQClientException ex = <span class="keyword">new</span> MQClientException(<span class="string">&quot;send request failed&quot;</span>, responseFuture.getCause());</span><br><span class="line">            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseFuture.isTimeout()) &#123;</span><br><span class="line">            MQClientException ex = <span class="keyword">new</span> MQClientException(<span class="string">&quot;wait response timeout &quot;</span> + responseFuture.getTimeoutMillis() + <span class="string">&quot;ms&quot;</span>,</span><br><span class="line">                                                         responseFuture.getCause());</span><br><span class="line">            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MQClientException ex = <span class="keyword">new</span> MQClientException(<span class="string">&quot;unknow reseaon&quot;</span>, responseFuture.getCause());</span><br><span class="line">            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                            retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="keyword">long</span> cost = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">    producer.updateFaultItem(brokerName, cost, <span class="keyword">true</span>);</span><br><span class="line">    onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                    retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>RemotingClient是接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.remoting.RemotingClient  </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeAsync</span><span class="params">(<span class="keyword">final</span> String addr, <span class="keyword">final</span> RemotingCommand request, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="keyword">final</span> InvokeCallback invokeCallback)</span> <span class="keyword">throws</span> InterruptedException, RemotingConnectException,</span></span><br><span class="line"><span class="function">RemotingTooMuchRequestException, RemotingTimeoutException, RemotingSendRequestException</span>;</span><br></pre></td></tr></table></figure>

<p>而RemotingClient的具体实现类，只有一个：NettyRemotingClient，那就真相了，后续Broker BEBUG的时候，需要找到<em><strong>netty</strong></em>相关的代码，即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.remoting.netty.NettyRemotingClient</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invokeAsync</span><span class="params">(String addr, RemotingCommand request, <span class="keyword">long</span> timeoutMillis, InvokeCallback invokeCallback)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> InterruptedException, RemotingConnectException, RemotingTooMuchRequestException, RemotingTimeoutException,</span></span><br><span class="line"><span class="function">RemotingSendRequestException </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">  <span class="keyword">final</span> Channel channel = <span class="keyword">this</span>.getAndCreateChannel(addr); <span class="comment">//使用netty Channel发送</span></span><br><span class="line">  String channelRemoteAddr = RemotingHelper.parseChannelRemoteAddr(channel);</span><br><span class="line">  <span class="keyword">if</span> (channel != <span class="keyword">null</span> &amp;&amp; channel.isActive()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      doBeforeRpcHooks(channelRemoteAddr, request);</span><br><span class="line">      <span class="keyword">long</span> costTime = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">      <span class="keyword">if</span> (timeoutMillis &lt; costTime) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;invokeAsync call the addr[&quot;</span> + channelRemoteAddr + <span class="string">&quot;] timeout&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.invokeAsyncImpl(channel, request, timeoutMillis - costTime, <span class="keyword">new</span> InvokeCallbackWrapper(invokeCallback, addr));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemotingSendRequestException e) &#123;</span><br><span class="line">      LOGGER.warn(<span class="string">&quot;invokeAsync: send request exception, so close the channel[&#123;&#125;]&quot;</span>, channelRemoteAddr);</span><br><span class="line">      <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingConnectException(addr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在Broker module搜索<em><strong>RemotingCommand</strong></em>和<em><strong>netty</strong></em>关键字的代码，发现引用RemotingCommand的类，有很多Processor，而且都继承接口<em><strong>NettyRequestProcessor</strong></em>，所以，我们都在这些Processor类上，都打上断点。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024314.jpg" alt="008vOhrAgy1hfj38rzypwj319e0u07c7"></p>
<p>然后，再执行生产者，产生消息的shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure>

<p>这是发现，断点进到Broker的<em><strong>NettyRequestProcessor</strong></em>，后续可以在broker中，愉快的DEBUG代码了。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-024326.jpg" alt="008vOhrAgy1hfj3d7r6yhj31gi0u0qai"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/23/SpringBoot3%E5%BF%AB%E9%80%9F%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/SpringBoot3%E5%BF%AB%E9%80%9F%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">SpringBoot3快速体验</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-23 18:45:08" itemprop="dateCreated datePublished" datetime="2022-11-23T18:45:08+08:00">2022-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 11:32:11" itemprop="dateModified" datetime="2024-02-27T11:32:11+08:00">2024-02-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="工程配置"><a href="#工程配置" class="headerlink" title="工程配置"></a>工程配置</h1><h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><ul>
<li>JDK17</li>
<li>Gradle7.5</li>
<li>IntelliJ IDEA 2022</li>
</ul>
<h2 id="工程配置-1"><a href="#工程配置-1" class="headerlink" title="工程配置"></a>工程配置</h2><p>使用gradle创建验证性的工程，因为使用SpringBoot3是3.0.0-RC版本，需要在setting.gradle里面，添加spring的maven仓库。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pluginManagement &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    maven &#123; url <span class="string">&#x27;https://repo.spring.io/milestone&#x27;</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>root的build.gradle中，添加spring的maven仓库</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    maven &#123; url <span class="string">&#x27;https://repo.spring.io/milestone&#x27;</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引入<strong>org.springframework.boot</strong>插件和<strong>org.graalvm.buildtools.native</strong>插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">  id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">  id <span class="string">&#x27;java-library&#x27;</span></span><br><span class="line">  id <span class="string">&#x27;project-report&#x27;</span></span><br><span class="line">  id <span class="string">&#x27;idea&#x27;</span></span><br><span class="line">  id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;3.0.0-RC2&#x27;</span> apply <span class="literal">false</span></span><br><span class="line">  id <span class="string">&#x27;org.graalvm.buildtools.native&#x27;</span> version <span class="string">&#x27;0.9.17&#x27;</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBoot module里面，开启插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.springframework.boot&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.graalvm.buildtools.native&quot;</span></span><br></pre></td></tr></table></figure>

<p>引入SpringBoot3依赖</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">  springBootVersion = <span class="string">&#x27;3.0.0-RC2&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  implementation(platform(<span class="string">&quot;org.springframework.boot:spring-boot-dependencies:$springBootVersion&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务启动类和API接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(Application.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成上述插件和代码后，可以在gradle看到以下tasks。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-033042.jpg" alt="008vxvgGgy1h8f9pkdai6j30ls0oamys"></p>
<p>执行bootBuildImage，会得到一个docker image，SpringBoot3的云原生的容器镜像。日志如下：</p>
<p><strong>大致流程</strong>如下：</p>
<ol>
<li><p>拉取构建build native image的 builder image （docker.io/paketobuildpacks/builder:tiny，docker.io/paketobuildpacks/run:tiny-cnb）</p>
</li>
<li><p>开始构建云原生镜像（Running creator）</p>
<ul>
<li><p>分析（ANALYZING），目标云原生镜像是否存在</p>
</li>
<li><p>检测（DETECTING），检测所需依赖lib的版本（paketo-buildpacks/ca-certificates，paketo-buildpacks/bellsoft-liberica等）</p>
</li>
<li><p>保存（RESTORING），保存所需依赖lib版本</p>
</li>
<li><p>构建（BUILDING），拉取所以依赖lib，设置构建配置（比如 $BP_JVM_TYPE                 JRE                                                          the JVM type - JDK or JRE）</p>
</li>
<li><p><strong>GraalVM虚拟机</strong>，编译代码，构建Natvie Image（GraalVM Native Image）,这是核心步骤，7步，具体每步干啥，可以参考GraalVM官方文档，<a target="_blank" rel="noopener" href="https://www.graalvm.org/22.0/reference-manual/native-image/BuildOutput/">链接</a>。</p>
<ul>
<li>初始化（Initializing），初始化GraalVM虚拟机的各种依赖版本（比如：Version info: ‘GraalVM 22.3.0 Java 17 CE’，Java version info: ‘17.0.5+8-LTS’），设置属性初始值（比如：Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2SmilePresent set to false at build time）</li>
<li>执行分析（Performing analysis），编写的代码和引入的jar包，哪些classes，fields，methods是有使用的，哪些classes、fields、methonds有使用反射，有使用JNI，使用哪些native libraries（耗时步骤：200+s）</li>
<li>构建上下文（Building Universe），包含所有classes，fields，methods，用于最后的创建的Native Image</li>
<li>解析方法（Parsing Methods ），解析使用到的方法</li>
<li>内联方法（Inlining Methods），内联使用到的方法</li>
<li>编译方法（Compiling Methods），GraalVM虚拟机，最终将用到的方法，编译成机器代码（耗时步骤：130+s）</li>
<li>生产镜像（Creating Image），生成Native Image到本机Docker images</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">&gt; Task :springboot3:bootBuildImage</span><br><span class="line">Building image &#x27;docker.io/library/springboot3:1.0.0&#x27;</span><br><span class="line"></span><br><span class="line">&gt; Pulling builder image &#x27;docker.io/paketobuildpacks/builder:tiny&#x27; ..................................................</span><br><span class="line">&gt; Pulled builder image &#x27;paketobuildpacks/builder@sha256:853c60ed091daf2abf5b376f8178a3ccf754b15fe45666b720d278fe48ba8c42&#x27;</span><br><span class="line">&gt; Pulling run image &#x27;docker.io/paketobuildpacks/run:tiny-cnb&#x27; ..................................................</span><br><span class="line">&gt; Pulled run image &#x27;paketobuildpacks/run@sha256:6edd2f36f33b08a4553449b91cd4f4d4bcffd1c8d7677b35790d1b80fa13720c&#x27;</span><br><span class="line">&gt; Executing lifecycle version v0.15.1</span><br><span class="line">&gt; Using build cache volume &#x27;pack-cache-64ae48079398.build&#x27;</span><br><span class="line"></span><br><span class="line">&gt; Running creator</span><br><span class="line">[creator]     ===&gt; ANALYZING</span><br><span class="line">[creator]     Previous image with name &quot;docker.io/library/springboot3:1.0.0&quot; not found</span><br><span class="line">[creator]     ===&gt; DETECTING</span><br><span class="line">[creator]     6 of 14 buildpacks participating</span><br><span class="line">[creator]     paketo-buildpacks/ca-certificates   3.5.0</span><br><span class="line">[creator]     paketo-buildpacks/bellsoft-liberica 9.10.0</span><br><span class="line">[creator]     paketo-buildpacks/syft              1.22.1</span><br><span class="line">[creator]     paketo-buildpacks/executable-jar    6.5.0</span><br><span class="line">[creator]     paketo-buildpacks/spring-boot       5.20.0</span><br><span class="line">[creator]     paketo-buildpacks/native-image      5.6.0</span><br><span class="line">[creator]     ===&gt; RESTORING</span><br><span class="line">[creator]     ===&gt; BUILDING</span><br><span class="line">[creator]     </span><br><span class="line">[creator]     Paketo Buildpack for CA Certificates 3.5.0</span><br><span class="line">[creator]       https://github.com/paketo-buildpacks/ca-certificates</span><br><span class="line">[creator]       Launch Helper: Contributing to layer</span><br><span class="line">[creator]         Creating /layers/paketo-buildpacks_ca-certificates/helper/exec.d/ca-certificates-helper</span><br><span class="line">[creator]     </span><br><span class="line">[creator]     Paketo Buildpack for BellSoft Liberica 9.10.0</span><br><span class="line">[creator]       https://github.com/paketo-buildpacks/bellsoft-liberica</span><br><span class="line">[creator]       Build Configuration:</span><br><span class="line">[creator]         $BP_JVM_JLINK_ARGS           --no-man-pages --no-header-files --strip-debug --compress=1  configure custom link arguments (--output must be omitted)</span><br><span class="line">[creator]         $BP_JVM_JLINK_ENABLED        false                                                        enables running jlink tool to generate custom JRE</span><br><span class="line">[creator]         $BP_JVM_TYPE                 JRE                                                          the JVM type - JDK or JRE</span><br><span class="line">[creator]         $BP_JVM_VERSION              11                                                           the Java version</span><br><span class="line">[creator]       Launch Configuration:</span><br><span class="line">[creator]         $BPL_DEBUG_ENABLED           false                                                        enables Java remote debugging support</span><br><span class="line">[creator]         $BPL_DEBUG_PORT              8000                                                         configure the remote debugging port</span><br><span class="line">[creator]         $BPL_DEBUG_SUSPEND           false                                                        configure whether to suspend execution until a debugger has attached</span><br><span class="line">[creator]         $BPL_HEAP_DUMP_PATH                                                                       write heap dumps on error to this path</span><br><span class="line">[creator]         $BPL_JAVA_NMT_ENABLED        true                                                         enables Java Native Memory Tracking (NMT)</span><br><span class="line">[creator]         $BPL_JAVA_NMT_LEVEL          summary                                                      configure level of NMT, summary or detail</span><br><span class="line">[creator]         $BPL_JFR_ARGS                                                                             configure custom Java Flight Recording (JFR) arguments</span><br><span class="line">[creator]         $BPL_JFR_ENABLED             false                                                        enables Java Flight Recording (JFR)</span><br><span class="line">[creator]         $BPL_JMX_ENABLED             false                                                        enables Java Management Extensions (JMX)</span><br><span class="line">[creator]         $BPL_JMX_PORT                5000                                                         configure the JMX port</span><br><span class="line">[creator]         $BPL_JVM_HEAD_ROOM           0                                                            the headroom in memory calculation</span><br><span class="line">[creator]         $BPL_JVM_LOADED_CLASS_COUNT  35% of classes                                               the number of loaded classes in memory calculation</span><br><span class="line">[creator]         $BPL_JVM_THREAD_COUNT        250                                                          the number of threads in memory calculation</span><br><span class="line">[creator]         $JAVA_TOOL_OPTIONS                                                                        the JVM launch flags</span><br><span class="line">[creator]         Using Java version 17 extracted from MANIFEST.MF</span><br><span class="line">[creator]       BellSoft Liberica NIK 17.0.5: Contributing to layer</span><br><span class="line">[creator]         Downloading from https://download.bell-sw.com/vm/22.3.0/bellsoft-liberica-vm-core-openjdk17.0.5+8-22.3.0+2-linux-amd64.tar.gz</span><br><span class="line">[creator]         Verifying checksum</span><br><span class="line">[creator]         Expanding to /layers/paketo-buildpacks_bellsoft-liberica/native-image-svm</span><br><span class="line">[creator]         Adding 127 container CA certificates to JVM truststore</span><br><span class="line">[creator]         Writing env.build/JAVA_HOME.override</span><br><span class="line">[creator]         Writing env.build/JDK_HOME.override</span><br><span class="line">[creator]     </span><br><span class="line">[creator]     Paketo Buildpack for Syft 1.22.1</span><br><span class="line">[creator]       https://github.com/paketo-buildpacks/syft</span><br><span class="line">[creator]         Downloading from https://github.com/anchore/syft/releases/download/v0.60.3/syft_0.60.3_linux_amd64.tar.gz</span><br><span class="line">[creator]         Verifying checksum</span><br><span class="line">[creator]         Writing env.build/SYFT_CHECK_FOR_APP_UPDATE.default</span><br><span class="line">[creator]     </span><br><span class="line">[creator]     Paketo Buildpack for Executable JAR 6.5.0</span><br><span class="line">[creator]       https://github.com/paketo-buildpacks/executable-jar</span><br><span class="line">[creator]       Class Path: Contributing to layer</span><br><span class="line">[creator]         Writing env.build/CLASSPATH.delim</span><br><span class="line">[creator]         Writing env.build/CLASSPATH.prepend</span><br><span class="line">[creator]     </span><br><span class="line">[creator]     Paketo Buildpack for Spring Boot 5.20.0</span><br><span class="line">[creator]       https://github.com/paketo-buildpacks/spring-boot</span><br><span class="line">[creator]       Build Configuration:</span><br><span class="line">[creator]         $BP_SPRING_CLOUD_BINDINGS_DISABLED   false  whether to contribute Spring Boot cloud bindings support</span><br><span class="line">[creator]       Launch Configuration:</span><br><span class="line">[creator]         $BPL_SPRING_CLOUD_BINDINGS_DISABLED  false  whether to auto-configure Spring Boot environment properties from bindings</span><br><span class="line">[creator]         $BPL_SPRING_CLOUD_BINDINGS_ENABLED   true   Deprecated - whether to auto-configure Spring Boot environment properties from bindings</span><br><span class="line">[creator]       Class Path: Contributing to layer</span><br><span class="line">[creator]         native args file /workspace/META-INF/native-image/argfile</span><br><span class="line">[creator]         Writing env.build/BP_NATIVE_IMAGE_BUILD_ARGUMENTS_FILE.default</span><br><span class="line">[creator]         Writing env.build/CLASSPATH.append</span><br><span class="line">[creator]         Writing env.build/CLASSPATH.delim</span><br><span class="line">[creator]       Image labels:</span><br><span class="line">[creator]         org.springframework.boot.version</span><br><span class="line">[creator]     Warning: BOM table is deprecated in this buildpack api version, though it remains supported for backwards compatibility. Buildpack authors should write BOM information to &lt;layer&gt;.sbom.&lt;ext&gt;, launch.sbom.&lt;ext&gt;, or build.sbom.&lt;ext&gt;.</span><br><span class="line">[creator]     </span><br><span class="line">[creator]     Paketo Buildpack for Native Image 5.6.0</span><br><span class="line">[creator]       https://github.com/paketo-buildpacks/native-image</span><br><span class="line">[creator]       Build Configuration:</span><br><span class="line">[creator]         $BP_BINARY_COMPRESSION_METHOD                                                    Compression mechanism used to reduce binary size. Options: `none` (default), `upx` or `gzexe`</span><br><span class="line">[creator]         $BP_NATIVE_IMAGE                       true                                      enable native image build</span><br><span class="line">[creator]         $BP_NATIVE_IMAGE_BUILD_ARGUMENTS                                                 arguments to pass to the native-image command</span><br><span class="line">[creator]         $BP_NATIVE_IMAGE_BUILD_ARGUMENTS_FILE  /workspace/META-INF/native-image/argfile  a file with arguments to pass to the native-image command</span><br><span class="line">[creator]         $BP_NATIVE_IMAGE_BUILT_ARTIFACT                                                  the built application artifact explicitly, required if building from a JAR</span><br><span class="line">[creator]       Native Image: Contributing to layer</span><br><span class="line">[creator]         Executing native-image -H:+StaticExecutableWithDynamicLibC @/workspace/META-INF/native-image/argfile -H:Name=/layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application -cp /workspace:/workspace/BOOT-INF/classes:/workspace/BOOT-INF/lib/lombok-1.18.24.jar:/workspace/BOOT-INF/lib/guava-27.1-jre.jar:/workspace/BOOT-INF/lib/jackson-datatype-jsr310-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-module-parameter-names-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-core-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-datatype-jdk8-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-databind-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-annotations-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/log4j-to-slf4j-2.19.0.jar:/workspace/BOOT-INF/lib/log4j-api-2.19.0.jar:/workspace/BOOT-INF/lib/spring-webmvc-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-web-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/micrometer-observation-1.10.0.jar:/workspace/BOOT-INF/lib/micrometer-commons-1.10.0.jar:/workspace/BOOT-INF/lib/spring-boot-autoconfigure-3.0.0-RC2.jar:/workspace/BOOT-INF/lib/spring-boot-3.0.0-RC2.jar:/workspace/BOOT-INF/lib/spring-context-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-aop-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-beans-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-expression-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-core-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-jcl-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/jakarta.annotation-api-2.1.1.jar:/workspace/BOOT-INF/lib/logback-classic-1.4.4.jar:/workspace/BOOT-INF/lib/logback-core-1.4.4.jar:/workspace/BOOT-INF/lib/jul-to-slf4j-2.0.3.jar:/workspace/BOOT-INF/lib/slf4j-api-2.0.3.jar:/workspace/BOOT-INF/lib/snakeyaml-1.33.jar:/workspace/BOOT-INF/lib/tomcat-embed-websocket-10.1.1.jar:/workspace/BOOT-INF/lib/tomcat-embed-core-10.1.1.jar:/workspace/BOOT-INF/lib/tomcat-embed-el-10.1.1.jar:/workspace/BOOT-INF/lib/failureaccess-1.0.1.jar:/workspace/BOOT-INF/lib/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar:/workspace/BOOT-INF/lib/jsr305-3.0.2.jar:/workspace/BOOT-INF/lib/checker-qual-2.5.2.jar:/workspace/BOOT-INF/lib/error_prone_annotations-2.2.0.jar:/workspace/BOOT-INF/lib/j2objc-annotations-1.1.jar:/workspace/BOOT-INF/lib/animal-sniffer-annotations-1.17.jar pers.james.practice.springboog3.Application</span><br><span class="line">[creator]     ================================================================================</span><br><span class="line">[creator]     GraalVM Native Image: Generating &#x27;/layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application&#x27; (static executable)...</span><br><span class="line">[creator]     ================================================================================</span><br><span class="line">[creator]     [1/7] Initializing...                                           (11.2s @ 0.22GB)</span><br><span class="line">[creator]      Version info: &#x27;GraalVM 22.3.0 Java 17 CE&#x27;</span><br><span class="line">[creator]      Java version info: &#x27;17.0.5+8-LTS&#x27;</span><br><span class="line">[creator]      C compiler: gcc (linux, x86_64, 7.5.0)</span><br><span class="line">[creator]      Garbage collector: Serial GC</span><br><span class="line">[creator]      1 user-specific feature(s)</span><br><span class="line">[creator]      - org.springframework.aot.nativex.feature.PreComputeFieldFeature</span><br><span class="line">[creator]     The bundle named: org.apache.el.Messages, has not been found. If the bundle is part of a module, verify the bundle name is a fully qualified class name. Otherwise verify the bundle path is accessible in the classpath.</span><br><span class="line">[creator]     Field org.springframework.core.NativeDetector#imageCode set to true at build time</span><br><span class="line">[creator]     Field org.springframework.format.support.DefaultFormattingConversionService#jsr354Present set to false at build time</span><br><span class="line">[creator]     Field org.springframework.core.KotlinDetector#kotlinPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.core.KotlinDetector#kotlinReflectPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#romePresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jaxb2Present set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2Present set to true at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2XmlPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2SmilePresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2CborPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#gsonPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jsonbPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.boot.logging.logback.LogbackLoggingSystem$Factory#PRESENT set to true at build time</span><br><span class="line">[creator]     Field org.springframework.boot.logging.log4j2.Log4J2LoggingSystem$Factory#PRESENT set to false at build time</span><br><span class="line">[creator]     Field org.springframework.boot.logging.java.JavaLoggingSystem$Factory#PRESENT set to true at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.view.InternalResourceViewResolver#jstlPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.context.support.StandardServletEnvironment#jndiPresent set to true at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jaxb2Present set to false at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2Present set to true at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2XmlPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2SmilePresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#gsonPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jsonbPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.context.event.ApplicationListenerMethodAdapter#reactiveStreamsPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.context.support.WebApplicationContextUtils#jsfPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.context.request.RequestContextHolder#jsfPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.boot.autoconfigure.web.format.WebConversionService#JSR_354_PRESENT set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#romePresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#jaxb2Present set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#jackson2Present set to true at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#jackson2XmlPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#jackson2SmilePresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#jackson2CborPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#gsonPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#jsonbPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.client.RestTemplate#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.core.ReactiveAdapterRegistry#reactorPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.core.ReactiveAdapterRegistry#rxjava3Present set to false at build time</span><br><span class="line">[creator]     Field org.springframework.core.ReactiveAdapterRegistry#kotlinCoroutinesPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.core.ReactiveAdapterRegistry#mutinyPresent set to false at build time</span><br><span class="line">[creator]     Field org.springframework.web.servlet.mvc.method.annotation.ReactiveTypeHandler#isContextPropagationPresent will be evaluated at runtime due to this error during build time evaluation: org.slf4j.spi.SLF4JServiceProvider: ch.qos.logback.classic.spi.LogbackServiceProvider not a subtype</span><br><span class="line">[creator]     Field org.springframework.web.servlet.support.RequestContext#jstlPresent set to false at build time</span><br><span class="line">[creator]     [2/7] Performing analysis...  [*********]                      (215.2s @ 1.28GB)</span><br><span class="line">[creator]       15,670 (92.37%) of 16,964 classes reachable</span><br><span class="line">[creator]       25,869 (67.79%) of 38,159 fields reachable</span><br><span class="line">[creator]       75,776 (62.18%) of 121,858 methods reachable</span><br><span class="line">[creator]          788 classes,   166 fields, and 3,521 methods registered for reflection</span><br><span class="line">[creator]           64 classes,    70 fields, and    55 methods registered for JNI access</span><br><span class="line">[creator]            4 native libraries: dl, pthread, rt, z</span><br><span class="line">[creator]     [3/7] Building universe...                                      (58.9s @ 1.26GB)</span><br><span class="line">[creator]     GC warning: 31.1s spent in 10 GCs during the last stage, taking up 52.68% of the time.</span><br><span class="line">[creator]                 Please ensure more than 1.74GB of memory is available for Native Image</span><br><span class="line">[creator]                 to reduce GC overhead and improve image build time.</span><br><span class="line">[creator]     [4/7] Parsing methods...      [*****]                           (27.9s @ 1.10GB)</span><br><span class="line">[creator]     [5/7] Inlining methods...     [***]                             (10.0s @ 1.09GB)</span><br><span class="line">[creator]     [6/7] Compiling methods...    [***********]                    (138.3s @ 1.15GB)</span><br><span class="line">[creator]     [7/7] Creating image...                                         (43.0s @ 1.31GB)</span><br><span class="line">[creator]       33.84MB (45.94%) for code area:    49,725 compilation units</span><br><span class="line">[creator]       37.03MB (50.27%) for image heap:  371,461 objects and 420 resources</span><br><span class="line">[creator]        2.79MB ( 3.79%) for other data</span><br><span class="line">[creator]       73.65MB in total</span><br><span class="line">[creator]     --------------------------------------------------------------------------------</span><br><span class="line">[creator]     Top 10 packages in code area:           Top 10 object types in image heap:</span><br><span class="line">[creator]        1.63MB sun.security.ssl                 7.45MB byte[] for code metadata</span><br><span class="line">[creator]        1.06MB java.util                        6.03MB byte[] for embedded resources</span><br><span class="line">[creator]      827.16KB java.lang.invoke                 3.74MB java.lang.Class</span><br><span class="line">[creator]      718.01KB com.sun.crypto.provider          3.50MB java.lang.String</span><br><span class="line">[creator]      541.01KB org.apache.catalina.core         3.11MB byte[] for general heap data</span><br><span class="line">[creator]      499.54KB org.apache.tomcat.util.net       2.86MB byte[] for java.lang.String</span><br><span class="line">[creator]      490.49KB org.apache.coyote.http2          1.32MB c.o.s.c.h.DynamicHubCompanion</span><br><span class="line">[creator]      472.92KB java.lang                      835.87KB byte[] for reflection metadata</span><br><span class="line">[creator]      470.23KB c.s.o.a.xerces.internal.impl   679.55KB java.lang.String[]</span><br><span class="line">[creator]      461.63KB sun.security.x509              607.22KB java.util.HashMap$Node</span><br><span class="line">[creator]       26.41MB for 658 more packages            6.10MB for 3120 more object types</span><br><span class="line">[creator]     --------------------------------------------------------------------------------</span><br><span class="line">[creator]       164.1s (29.2% of total time) in 257 GCs | Peak RSS: 1.74GB | CPU load: 1.44</span><br><span class="line">[creator]     --------------------------------------------------------------------------------</span><br><span class="line">[creator]     Produced artifacts:</span><br><span class="line">[creator]      /layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application (executable)</span><br><span class="line">[creator]      /layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application.build_artifacts.txt (txt)</span><br><span class="line">[creator]     ================================================================================</span><br><span class="line">[creator]     Finished generating &#x27;/layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application&#x27; in 9m 20s.</span><br><span class="line">[creator]       Removing bytecode</span><br><span class="line">[creator]       Process types:</span><br><span class="line">[creator]         native-image: /workspace/pers.james.practice.springboog3.Application (direct)</span><br><span class="line">[creator]         task:         /workspace/pers.james.practice.springboog3.Application (direct)</span><br><span class="line">[creator]         web:          /workspace/pers.james.practice.springboog3.Application (direct)</span><br><span class="line">[creator]     ===&gt; EXPORTING</span><br><span class="line">[creator]     Adding layer &#x27;paketo-buildpacks/ca-certificates:helper&#x27;</span><br><span class="line">[creator]     Adding layer &#x27;launch.sbom&#x27;</span><br><span class="line">[creator]     Adding 1/1 app layer(s)</span><br><span class="line">[creator]     Adding layer &#x27;launcher&#x27;</span><br><span class="line">[creator]     Adding layer &#x27;config&#x27;</span><br><span class="line">[creator]     Adding layer &#x27;process-types&#x27;</span><br><span class="line">[creator]     Adding label &#x27;io.buildpacks.lifecycle.metadata&#x27;</span><br><span class="line">[creator]     Adding label &#x27;io.buildpacks.build.metadata&#x27;</span><br><span class="line">[creator]     Adding label &#x27;io.buildpacks.project.metadata&#x27;</span><br><span class="line">[creator]     Adding label &#x27;org.springframework.boot.version&#x27;</span><br><span class="line">[creator]     Setting default process type &#x27;web&#x27;</span><br><span class="line">[creator]     Saving docker.io/library/springboot3:1.0.0...</span><br><span class="line">[creator]     *** Images (12137cda1f20):</span><br><span class="line">[creator]           docker.io/library/springboot3:1.0.0</span><br><span class="line">[creator]     Adding cache layer &#x27;paketo-buildpacks/bellsoft-liberica:native-image-svm&#x27;</span><br><span class="line">[creator]     Adding cache layer &#x27;paketo-buildpacks/syft:syft&#x27;</span><br><span class="line">[creator]     Adding cache layer &#x27;paketo-buildpacks/native-image:native-image&#x27;</span><br><span class="line">[creator]     Adding cache layer &#x27;cache.sbom&#x27;</span><br><span class="line"></span><br><span class="line">Successfully built image &#x27;docker.io/library/springboot3:1.0.0&#x27;</span><br><span class="line"></span><br><span class="line">Persisted dependency lock state for project &#x27;:springboot3&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整个任务执行，比较耗时，11min。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-033112.jpg" alt="008vxvgGgy1h8f9u94ab5j30y40243yz"></p>
<p>然后在本机上，可以看到一个docker images</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-033129.jpg" alt="008vxvgGgy1h8f9y5lyhfj31e2036js3"></p>
<p>启动docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -p 8080:8080 docker.io/library/springboot3:1.0.0</span><br></pre></td></tr></table></figure>

<p>SpringBoot启动日志，启动速度非常快</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">.   ____          _            __ _ _</span><br><span class="line">/\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line">\\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">&#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line">=========|_|==============|___/=/_/_/_/</span><br><span class="line">:: Spring Boot ::            (v3.0.0-RC2)</span><br><span class="line"></span><br><span class="line">2022-11-23T10:16:08.247Z  INFO 1 --- [           main] p.j.practice.springboog3.Application     : Starting AOT-processed Application using Java 17.0.5 with PID 1 (/workspace/pers.james.practice.springboog3.Application started by cnb in /workspace)</span><br><span class="line">2022-11-23T10:16:08.247Z  INFO 1 --- [           main] p.j.practice.springboog3.Application     : No active profile set, falling back to 1 default profile: &quot;default&quot;</span><br><span class="line">2022-11-23T10:16:08.260Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2022-11-23T10:16:08.261Z  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2022-11-23T10:16:08.261Z  INFO 1 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.1]</span><br><span class="line">2022-11-23T10:16:08.265Z  INFO 1 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2022-11-23T10:16:08.265Z  INFO 1 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 18 ms</span><br><span class="line">2022-11-23T10:16:08.295Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#x27;&#x27;</span><br><span class="line">2022-11-23T10:16:08.296Z  INFO 1 --- [           main] p.j.practice.springboog3.Application     : Started Application in 0.058 seconds (process running for 0.07)</span><br></pre></td></tr></table></figure>

<p>系统占用内存，也非常低，使用docker stats观察docker占用内存。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-033143.jpg" alt="008vxvgGgy1h8fa24m6avj318w03eq3h"></p>
<p>访问API接口，正常</p>
<p>后台日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2022-11-23T10:16:37.488Z  INFO 1 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet &#x27;dispatcherServlet&#x27;</span><br><span class="line">2022-11-23T10:16:37.488Z  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet &#x27;dispatcherServlet&#x27;</span><br><span class="line">2022-11-23T10:16:37.488Z  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 0 ms</span><br></pre></td></tr></table></figure>

<p>另外build目录下，也会产生AOT(ahead-of-time)提前编译，    相关目录和编译中间结果</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-033308.jpg" alt="008vxvgGgy1h8g6book3lj30su172gro"></p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-033251.jpg" alt="008vxvgGgy1h8g6f76710j30u00wpad7"></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/3.0.0-RC2/reference/htmlsingle/#native-image.developing-your-first-application.buildpacks.gradle">SpringBoot官网-GraalVM Native Image Support Gradle</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/3.0.0-RC2/gradle-plugin/reference/htmlsingle/#aot">SpringBoot官网-gradle-plugin</a></p>
<p><a target="_blank" rel="noopener" href="https://www.graalvm.org/22.0/reference-manual/native-image/BuildOutput/">GraalVM-Build-Output</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">SOFAJRaft元信息Meta存储分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-19 17:03:51" itemprop="dateCreated datePublished" datetime="2022-09-19T17:03:51+08:00">2022-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 11:37:07" itemprop="dateModified" datetime="2024-02-27T11:37:07+08:00">2024-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Meta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">Meta存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、SOFAJRaft元信息"><a href="#一、SOFAJRaft元信息" class="headerlink" title="一、SOFAJRaft元信息"></a>一、SOFAJRaft元信息</h1><p>引用SOFARaft，关于Meta元信息存储定义如下：</p>
<blockquote>
<p>Meta 存储，元信息存储，记录 raft 实现的内部状态，比如当前 term,、投票给哪个节点等信息。</p>
</blockquote>
<p>Meta信息核心接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.RaftMetaStorage</span><br></pre></td></tr></table></figure>

<p>RaftMetaStorage主要方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.RaftMetaStorage</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RaftMetaStorage</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span>&lt;<span class="title">RaftMetaStorageOptions</span>&gt;, <span class="title">Storage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set current term.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">setTerm</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get current term.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">getTerm</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="function">PeerId <span class="title">getVotedFor</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set term and voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">setTermAndVotedFor</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> PeerId peerId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RaftMetaStorage只有一个实现类：LocalRaftMetaStorage，从名字可以看出来，具体实现，是以本地存储为主。即以本地文件的形式完成Meta信息的存储。</p>
<p>LocalRaftMetaStorage的主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalRaftMetaStorage</span> <span class="keyword">implements</span> <span class="title">RaftMetaStorage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String        path; <span class="comment">//本地文件存储路径</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span>                term; <span class="comment">//选举任期</span></span><br><span class="line">  <span class="keyword">private</span> PeerId              votedFor  = PeerId.emptyPeer(); <span class="comment">//选举投票给谁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LocalRaftMetaStorage的主要方法，主要分为Set，Get两类:</p>
<p>其中Set类，保存term和voteFor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span> </span>&#123;</span><br><span class="line">  checkState();</span><br><span class="line">  <span class="keyword">this</span>.votedFor = peerId;</span><br><span class="line">  <span class="keyword">return</span> save();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span> </span>&#123;</span><br><span class="line">  checkState();</span><br><span class="line">  <span class="keyword">this</span>.votedFor = peerId;</span><br><span class="line">  <span class="keyword">return</span> save();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存主要逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> start = Utils.monotonicMs();</span><br><span class="line">  <span class="keyword">final</span> StablePBMeta meta = StablePBMeta.newBuilder() <span class="comment">//存储格式是Protobuf文件格式内容</span></span><br><span class="line">    .setTerm(<span class="keyword">this</span>.term) </span><br><span class="line">    .setVotedfor(<span class="keyword">this</span>.votedFor.toString()) </span><br><span class="line">    .build();</span><br><span class="line">  <span class="keyword">final</span> ProtoBufFile pbFile = newPbFile();<span class="comment">//Protobuf文件</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!pbFile.save(meta, <span class="keyword">this</span>.raftOptions.isSyncMeta())) &#123;<span class="comment">//写入文件</span></span><br><span class="line">      reportIOError();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to save raft meta&quot;</span>, e);</span><br><span class="line">    reportIOError();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> cost = Utils.monotonicMs() - start;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeMetrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.nodeMetrics.recordLatency(<span class="string">&quot;save-raft-meta&quot;</span>, cost);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;Save raft meta, path=&#123;&#125;, term=&#123;&#125;, votedFor=&#123;&#125;, cost time=&#123;&#125; ms&quot;</span>, <span class="keyword">this</span>.path, <span class="keyword">this</span>.term,</span><br><span class="line">             <span class="keyword">this</span>.votedFor, cost);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>StablePBMeta是实现了protobuf的数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.entity.LocalStorageOutter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StablePBMeta</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span>   term_;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> java.lang.Object votedfor_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存protobuf文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.io.ProtoBufFile</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> <span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// Write message into temp file</span></span><br><span class="line">  <span class="keyword">final</span> File file = <span class="keyword">new</span> File(<span class="keyword">this</span>.path + <span class="string">&quot;.tmp&quot;</span>);<span class="comment">//先保存tmp文件</span></span><br><span class="line">  <span class="keyword">try</span> (<span class="keyword">final</span> FileOutputStream fOut = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">       <span class="keyword">final</span> BufferedOutputStream output = <span class="keyword">new</span> BufferedOutputStream(fOut)) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] lenBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// name len + name</span></span><br><span class="line">    <span class="keyword">final</span> String fullName = msg.getDescriptorForType().getFullName();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> nameLen = fullName.length();</span><br><span class="line">    Bits.putInt(lenBytes, <span class="number">0</span>, nameLen);</span><br><span class="line">    output.write(lenBytes);</span><br><span class="line">    output.write(fullName.getBytes());</span><br><span class="line">    <span class="comment">// msg len + msg</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> msgLen = msg.getSerializedSize();</span><br><span class="line">    Bits.putInt(lenBytes, <span class="number">0</span>, msgLen);</span><br><span class="line">    output.write(lenBytes);</span><br><span class="line">    msg.writeTo(output);</span><br><span class="line">    output.flush();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sync) &#123; <span class="comment">//同步刷盘</span></span><br><span class="line">    Utils.fsync(file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Utils.atomicMoveFile(file, <span class="keyword">new</span> File(<span class="keyword">this</span>.path), sync); <span class="comment">//tmp文件 -&gt; 正式文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中Get类，读取term和voteFor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTerm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  checkState();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.term; <span class="comment">//直接读取属性，初始化的时候，有load方法，从磁盘文件读取。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PeerId <span class="title">getVotedFor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  checkState();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.votedFor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> RaftMetaStorageOptions opts)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.isInited) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Raft meta storage is already inited.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.node = opts.getNode();</span><br><span class="line">  <span class="keyword">this</span>.nodeMetrics = <span class="keyword">this</span>.node.getNodeMetrics();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    FileUtils.forceMkdir(<span class="keyword">new</span> File(<span class="keyword">this</span>.path));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to mkdir &#123;&#125;&quot;</span>, <span class="keyword">this</span>.path, e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (load()) &#123;<span class="comment">//从磁盘文件读取</span></span><br><span class="line">    <span class="keyword">this</span>.isInited = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ProtoBufFile pbFile = newPbFile();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> StablePBMeta meta = pbFile.load();<span class="comment">//从Protobuf文件读取</span></span><br><span class="line">    <span class="keyword">if</span> (meta != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.term = meta.getTerm();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.votedFor.parse(meta.getVotedfor());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> FileNotFoundException e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to load raft meta storage&quot;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="二、SOFAJRaft元信息使用"><a href="#二、SOFAJRaft元信息使用" class="headerlink" title="二、SOFAJRaft元信息使用"></a>二、SOFAJRaft元信息使用</h1><p>SOFAJRaft元信息的使用，主要发生在选举的过程中，具体代码在Node的实现类NodeImpl.java里面。</p>
<p>场景1：比如开始选举时，把选票投给自己的时候</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">electSelf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> oldTerm;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Node &#123;&#125; start vote and grant vote self, term=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.conf.contains(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Node &#123;&#125; can&#x27;t do electSelf as it is not in &#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.conf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_FOLLOWER) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot;Node &#123;&#125; stop election timer, term=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">      <span class="keyword">this</span>.electionTimer.stop();</span><br><span class="line">    &#125;</span><br><span class="line">    resetLeaderId(PeerId.emptyPeer(), <span class="keyword">new</span> Status(RaftError.ERAFTTIMEDOUT,</span><br><span class="line">                                                 <span class="string">&quot;A follower&#x27;s leader_id is reset to NULL as it begins to request_vote.&quot;</span>));</span><br><span class="line">    <span class="keyword">this</span>.state = State.STATE_CANDIDATE;</span><br><span class="line">    <span class="keyword">this</span>.currTerm++;</span><br><span class="line">    <span class="keyword">this</span>.votedId = <span class="keyword">this</span>.serverId.copy();</span><br><span class="line">    LOG.debug(<span class="string">&quot;Node &#123;&#125; start vote timer, term=&#123;&#125; .&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">    <span class="keyword">this</span>.voteTimer.start();</span><br><span class="line">    <span class="keyword">this</span>.voteCtx.init(<span class="keyword">this</span>.conf.getConf(), <span class="keyword">this</span>.conf.isStable() ? <span class="keyword">null</span> : <span class="keyword">this</span>.conf.getOldConf());</span><br><span class="line">    oldTerm = <span class="keyword">this</span>.currTerm;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// vote need defense ABA after unlock&amp;writeLock</span></span><br><span class="line">    <span class="keyword">if</span> (oldTerm != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Node &#123;&#125; raise term &#123;&#125; when getLastLogId.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : <span class="keyword">this</span>.conf.listPeers()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (peer.equals(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.rpcService.connect(peer.getEndpoint())) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Node &#123;&#125; channel init failed, address=&#123;&#125;.&quot;</span>, getNodeId(), peer.getEndpoint());</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> OnRequestVoteRpcDone done = <span class="keyword">new</span> OnRequestVoteRpcDone(peer, <span class="keyword">this</span>.currTerm, <span class="keyword">this</span>);</span><br><span class="line">      done.request = RequestVoteRequest.newBuilder() <span class="comment">//</span></span><br><span class="line">        .setPreVote(<span class="keyword">false</span>) <span class="comment">// It&#x27;s not a pre-vote request.</span></span><br><span class="line">        .setGroupId(<span class="keyword">this</span>.groupId) <span class="comment">//</span></span><br><span class="line">        .setServerId(<span class="keyword">this</span>.serverId.toString()) <span class="comment">//</span></span><br><span class="line">        .setPeerId(peer.toString()) <span class="comment">//</span></span><br><span class="line">        .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">        .setLastLogIndex(lastLogId.getIndex()) <span class="comment">//</span></span><br><span class="line">        .setLastLogTerm(lastLogId.getTerm()) <span class="comment">//</span></span><br><span class="line">        .build();</span><br><span class="line">      <span class="keyword">this</span>.rpcService.requestVote(peer.getEndpoint(), done.request, done);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(<span class="keyword">this</span>.currTerm, <span class="keyword">this</span>.serverId); <span class="comment">//term和serverId都是Node自身的属性</span></span><br><span class="line">    <span class="keyword">this</span>.voteCtx.grant(<span class="keyword">this</span>.serverId);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.voteCtx.isGranted()) &#123;</span><br><span class="line">      becomeLeader();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景2：降级，收到更高的任期的时候</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stepDown</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> <span class="keyword">boolean</span> wakeupCandidate, <span class="keyword">final</span> Status status)</span> </span>&#123;</span><br><span class="line">  LOG.debug(<span class="string">&quot;Node &#123;&#125; stepDown, term=&#123;&#125;, newTerm=&#123;&#125;, wakeupCandidate=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm, term,</span><br><span class="line">            wakeupCandidate);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_CANDIDATE) &#123;</span><br><span class="line">    stopVoteTimer();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state.compareTo(State.STATE_TRANSFERRING) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    stopStepDownTimer();</span><br><span class="line">    <span class="keyword">this</span>.ballotBox.clearPendingTasks();</span><br><span class="line">    <span class="comment">// signal fsm leader stop immediately</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_LEADER) &#123;</span><br><span class="line">      onLeaderStop(status);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// reset leader_id</span></span><br><span class="line">  resetLeaderId(PeerId.emptyPeer(), status);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// soft state in memory</span></span><br><span class="line">  <span class="keyword">this</span>.state = State.STATE_FOLLOWER;</span><br><span class="line">  <span class="keyword">this</span>.confCtx.reset();</span><br><span class="line">  updateLastLeaderTimestamp(Utils.monotonicMs());</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.snapshotExecutor.interruptDownloadingSnapshots(term);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// meta state</span></span><br><span class="line">  <span class="keyword">if</span> (term &gt; <span class="keyword">this</span>.currTerm)  <span class="comment">//收到更高的term</span></span><br><span class="line">    <span class="keyword">this</span>.currTerm = term;</span><br><span class="line">  <span class="keyword">this</span>.votedId = PeerId.emptyPeer();</span><br><span class="line">  <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(term, <span class="keyword">this</span>.votedId);<span class="comment">//只更新term</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (wakeupCandidate) &#123;</span><br><span class="line">  <span class="keyword">this</span>.wakingCandidate = <span class="keyword">this</span>.replicatorGroup.stopAllAndFindTheNextCandidate(<span class="keyword">this</span>.conf);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.wakingCandidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Replicator.sendTimeoutNowAndStop(<span class="keyword">this</span>.wakingCandidate, <span class="keyword">this</span>.options.getElectionTimeoutMs());</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.replicatorGroup.stopAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.stopTransferArg != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.transferTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.transferTimer.cancel(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// There is at most one StopTransferTimer at the same term, it&#x27;s safe to</span></span><br><span class="line">  <span class="comment">// mark stopTransferArg to NULL</span></span><br><span class="line">  <span class="keyword">this</span>.stopTransferArg = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Learner node will not trigger the election timer.</span></span><br><span class="line"><span class="keyword">if</span> (!isLearner()) &#123;</span><br><span class="line">  <span class="keyword">this</span>.electionTimer.restart();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;Node &#123;&#125; is a learner, election timer is not started.&quot;</span>, <span class="keyword">this</span>.nodeId);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景3：收到其他候选人的选票时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">handleRequestVoteRequest</span><span class="params">(<span class="keyword">final</span> RequestVoteRequest request)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Node &#123;&#125; is not in active state, currTerm=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">      <span class="keyword">return</span> RpcFactoryHelper <span class="comment">//</span></span><br><span class="line">        .responseFactory() <span class="comment">//</span></span><br><span class="line">        .newResponse(RequestVoteResponse.getDefaultInstance(), RaftError.EINVAL,</span><br><span class="line">                     <span class="string">&quot;Node %s is not in active state, state %s.&quot;</span>, getNodeId(), <span class="keyword">this</span>.state.name());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> PeerId candidateId = <span class="keyword">new</span> PeerId();</span><br><span class="line">    <span class="keyword">if</span> (!candidateId.parse(request.getServerId())) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Node &#123;&#125; received RequestVoteRequest from &#123;&#125; serverId bad format.&quot;</span>, getNodeId(),</span><br><span class="line">               request.getServerId());</span><br><span class="line">      <span class="keyword">return</span> RpcFactoryHelper <span class="comment">//</span></span><br><span class="line">        .responseFactory() <span class="comment">//</span></span><br><span class="line">        .newResponse(RequestVoteResponse.getDefaultInstance(), RaftError.EINVAL,</span><br><span class="line">                     <span class="string">&quot;Parse candidateId failed: %s.&quot;</span>, request.getServerId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// noinspection ConstantConditions</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="comment">// check term</span></span><br><span class="line">      <span class="keyword">if</span> (request.getTerm() &gt;= <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Node &#123;&#125; received RequestVoteRequest from &#123;&#125;, term=&#123;&#125;, currTerm=&#123;&#125;.&quot;</span>, getNodeId(),</span><br><span class="line">                 request.getServerId(), request.getTerm(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">        <span class="comment">// increase current term, change state to follower</span></span><br><span class="line">        <span class="keyword">if</span> (request.getTerm() &gt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">          stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EHIGHERTERMRESPONSE,</span><br><span class="line">                                                        <span class="string">&quot;Raft node receives higher term RequestVoteRequest.&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ignore older term</span></span><br><span class="line">        LOG.info(<span class="string">&quot;Node &#123;&#125; ignore RequestVoteRequest from &#123;&#125;, term=&#123;&#125;, currTerm=&#123;&#125;.&quot;</span>, getNodeId(),</span><br><span class="line">                 request.getServerId(), request.getTerm(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      doUnlock = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">      doUnlock = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">      <span class="comment">// vote need ABA check after unlock&amp;writeLock</span></span><br><span class="line">      <span class="keyword">if</span> (request.getTerm() != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Node &#123;&#125; raise term &#123;&#125; when get lastLogId.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> logIsOk = <span class="keyword">new</span> LogId(request.getLastLogIndex(), request.getLastLogTerm())</span><br><span class="line">        .compareTo(lastLogId) &gt;= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logIsOk &amp;&amp; (<span class="keyword">this</span>.votedId == <span class="keyword">null</span> || <span class="keyword">this</span>.votedId.isEmpty())) &#123;</span><br><span class="line">        stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EVOTEFORCANDIDATE,</span><br><span class="line">                                                      <span class="string">&quot;Raft node votes for some candidate, step down to restart election_timer.&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.votedId = candidateId.copy();</span><br><span class="line">        <span class="keyword">this</span>.metaStorage.setVotedFor(candidateId); <span class="comment">//更新候选人信息</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RequestVoteResponse.newBuilder() <span class="comment">//</span></span><br><span class="line">      .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">      .setGranted(request.getTerm() == <span class="keyword">this</span>.currTerm &amp;&amp; candidateId.equals(<span class="keyword">this</span>.votedId)) <span class="comment">//</span></span><br><span class="line">      .build();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">      <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/" class="post-title-link" itemprop="url">SOFAJRaft日志存储分析（三）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-18 15:49:53" itemprop="dateCreated datePublished" datetime="2022-08-18T15:49:53+08:00">2022-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 11:40:32" itemprop="dateModified" datetime="2024-02-27T11:40:32+08:00">2024-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">日志存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="LogStorage其他实现分析"><a href="#LogStorage其他实现分析" class="headerlink" title="LogStorage其他实现分析"></a>LogStorage其他实现分析</h1><p>上篇<a target="_blank" rel="noopener" href="https://barryzhanhao.github.io/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/">SOFAJRaft日志存储分析（二）</a>中，着重分析了LogStorage的默认实现RocksDBLogStorage，还剩其他实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.impl.BDBLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.HybridLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.LogitLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span><br></pre></td></tr></table></figure>

<h2 id="BDBLogStorage"><a href="#BDBLogStorage" class="headerlink" title="BDBLogStorage"></a>BDBLogStorage</h2><p>BDBLogStorage和RocksDBLogStorage很类似，底层存储都依赖嵌入K-V数据库，BDBLogStorage使用的是oracle的<a target="_blank" rel="noopener" href="https://github.com/berkeleydb">berkeley-db</a>, <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/Berkeley_DB">维基定义</a></p>
<blockquote>
<p><strong>Berkeley DB</strong>（BDB）是一个高效的嵌入式<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%94%AE-%E5%80%BC%E6%95%B0%E6%8D%AE%E5%BA%93">键-值数据库</a>编程库，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%E8%AF%AD%E8%A8%80">C语言</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%2B%2B">C++</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Java">Java</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Perl">Perl</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Python">Python</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Tcl">Tcl</a>以及其他很多语言都有其对应的API。Berkeley DB可以保存任意类型的键/值对（Key/Value Pair），而且可以为一个键保存多个数据。Berkeley DB支持让数千的并发线程同时操作数据库，支持最大256TB的数据，广泛用于各种操作系统，其中包括大多数<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix-like">类Unix</a>操作系统、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Microsoft_Windows">Windows</a>操作系统以及<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%9E%E6%97%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">实时操作系统</a>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BDBLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span>, <span class="title">Describer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG                   = LoggerFactory.getLogger(BDBLogStorage.class);</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> String         DEFAULT_DATABASE_NAME = <span class="string">&quot;jraft-log&quot;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> String         CONF_DATABASE_NAME    = <span class="string">&quot;jraft-conf&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String              groupId;</span><br><span class="line">  <span class="keyword">private</span> Database            defaultTable; <span class="comment">//实际底层存储berkeley-db，com.sleepycat.je.Database</span></span><br><span class="line">  <span class="keyword">private</span> Database            confTable;</span><br><span class="line">  <span class="keyword">private</span> Environment         environment;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String        homePath; <span class="comment">//berkeley-db的目录</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span>             opened                = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> LogEntryEncoder     logEntryEncoder;</span><br><span class="line">  <span class="keyword">private</span> LogEntryDecoder     logEntryDecoder;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock readWriteLock         = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock          readLock              = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock          writeLock             = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span>       sync;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span>       firstLogIndex         = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>    hasLoadFirstLogIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法"><a href="#getEntry读取方法" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DatabaseEntry logEntry = <span class="keyword">new</span> DatabaseEntry();</span><br><span class="line">    OperationStatus operationStatus = <span class="keyword">this</span>.defaultTable.get(<span class="keyword">null</span>, getKeyDatabaseEntry(index), logEntry,</span><br><span class="line">                                                            LockMode.DEFAULT); <span class="comment">//调用berkeley-db的get方法</span></span><br><span class="line">    <span class="keyword">if</span> (isSuccessOperation(operationStatus)) &#123;</span><br><span class="line">      <span class="keyword">return</span> toLogEntry(logEntry);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DatabaseException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125;.&quot;</span>, index, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法"><a href="#appendEntry写入方法" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage   </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  Transaction txn = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    checkState();</span><br><span class="line">    DatabaseEntry key = getKeyDatabaseEntry(entry.getId().getIndex());</span><br><span class="line">    DatabaseEntry value = toDatabaseEntry(entry);</span><br><span class="line">    txn = beginTransaction();</span><br><span class="line">    <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">      <span class="keyword">this</span>.confTable.put(txn, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.defaultTable.put(txn, key, value); <span class="comment">//调用berkeley-db的put方法</span></span><br><span class="line">    txn.commit();</span><br><span class="line">    syncIfNeed();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DatabaseException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to append entry &#123;&#125;.&quot;</span>, entry, e);</span><br><span class="line">    <span class="keyword">if</span> (txn != <span class="keyword">null</span>) &#123;</span><br><span class="line">      txn.abort();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RocksDBSegmentLogStorage"><a href="#RocksDBSegmentLogStorage" class="headerlink" title="RocksDBSegmentLogStorage"></a>RocksDBSegmentLogStorage</h2><p>RocksDBSegmentLogStorage继承默认实现RocksDBLogStorage，在RocksDB的存储能力上，加入文件Segment功能(和LogManager的Segment不是一个概念)，<strong>是为了解决大数据Value写入的问题</strong>。</p>
<p>RocksDBSegmentLogStorage的主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocksDBSegmentLogStorage</span> <span class="keyword">extends</span> <span class="title">RocksDBLogStorage</span> </span>&#123; <span class="comment">//继承 RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>                   valueSizeThreshold; <span class="comment">//Value大小阀值，大于该值，使用Segment文件存储，小于的使用RocksDB直接存储</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                segmentsPath; <span class="comment">//Segment文件存放路径</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CheckpointFile        checkpointFile;</span><br><span class="line">  <span class="comment">// used  or using segments.</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;SegmentFile&gt;           segments; <span class="comment">//Segment文件列表</span></span><br><span class="line">  <span class="comment">// pre-allocated and blank segments.</span></span><br><span class="line">  <span class="keyword">private</span> ArrayDeque&lt;AllocatedResult&gt; blankSegments; <span class="comment">//预分配Segments</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                  allocateLock             = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Condition             fullCond                 = <span class="keyword">this</span>.allocateLock.newCondition();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Condition             emptyCond                = <span class="keyword">this</span>.allocateLock.newCondition();</span><br><span class="line">  <span class="comment">// segment file sequence.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong            nextFileSequence         = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock         readWriteLock            = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                  writeLock                = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                  readLock                 = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> ScheduledExecutorService    checkpointExecutor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AbortFile             abortFile;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor    writeExecutor; <span class="comment">//Segments异步写入线程池</span></span><br><span class="line">  <span class="keyword">private</span> Thread                      segmentAllocator; <span class="comment">//Segment预分配器</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>                   maxSegmentFileSize;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                         preAllocateSegmentCount  = PRE_ALLOCATE_SEGMENT_COUNT; <span class="comment">//Segment预分数量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                         keepInMemorySegmentCount = MEM_SEGMENT_COUNT;<span class="comment">//Segment内存保留数量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                         checkpointIntervalMs     = DEFAULT_CHECKPOINT_INTERVAL_MS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SegmentFile是带缓存的固定格式的文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A fixed size file. The content format is:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   magic bytes       first log index    reserved</span></span><br><span class="line"><span class="comment"> *   [0x20 0x20]      [... 8 bytes...]   [8 bytes]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   [record, record, ...]</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Every record format is:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   Magic bytes     data length   data</span></span><br><span class="line"><span class="comment"> *   [0x57, 0x8A]    [4 bytes]     [bytes]</span></span><br><span class="line"><span class="comment"> *&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentFile</span> <span class="keyword">implements</span> <span class="title">Lifecycle</span>&lt;<span class="title">SegmentFileOptions</span>&gt; </span>&#123;</span><br><span class="line">  * Magic bytes <span class="keyword">for</span> data buffer.</span><br><span class="line">    */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[]       RECORD_MAGIC_BYTES      = <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; (<span class="keyword">byte</span>) <span class="number">0x57</span>, (<span class="keyword">byte</span>) <span class="number">0x8A</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>          RECORD_MAGIC_BYTES_SIZE = RECORD_MAGIC_BYTES.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SegmentHeader      header;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The file last log index(inclusive)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span>            lastLogIndex            = Long.MAX_VALUE;</span><br><span class="line">  <span class="comment">// File size</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                      size;</span><br><span class="line">  <span class="comment">// File path</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String             path; <span class="comment">//文件path</span></span><br><span class="line">  <span class="comment">// mmap byte buffer.</span></span><br><span class="line">  <span class="keyword">private</span> MappedByteBuffer         buffer; <span class="comment">//缓存</span></span><br><span class="line">  <span class="comment">// Wrote position.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span>             wrotePos; <span class="comment">//游标</span></span><br><span class="line">  <span class="comment">// Committed position</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span>             committedPos;<span class="comment">//游标</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock      readWriteLock           = <span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock               writeLock               = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock               readLock                = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor writeExecutor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>         swappedOut;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>         readOnly;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span>                     swappedOutTimestamp     = -<span class="number">1L</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String             filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-1"><a href="#appendEntry写入方法-1" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><p>RocksDBSegmentLogStorage继承默认实现RocksDBLogStorage，appendEntry写入方法还是调用的父类RocksDBLogStorage的appendEntry写入方法，只是父类RocksDBLogStorage预留了一些hook钩子方法，RocksDBSegmentLogStorage通过实现这些钩子方法，扩展功能。</p>
<p>RocksDBLogStorage父类，appendEntry写入方法的扩展点，父类中，扩展点，均没实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">    <span class="keyword">return</span> executeBatch(batch -&gt; addConfBatch(entry, batch));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.db == <span class="keyword">null</span>) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;DB not initialized or destroyed in data path: &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> WriteContext writeCtx = newWriteContext(); <span class="comment">//扩展点 写入上下文WriteContext</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] valueBytes = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] newValueBytes = onDataAppend(logIndex, valueBytes, writeCtx); <span class="comment">//扩展点onDataAppend</span></span><br><span class="line">      writeCtx.startJob(); <span class="comment">//扩展点，写入上下文WriteContext生命周期</span></span><br><span class="line">      <span class="keyword">this</span>.db.put(<span class="keyword">this</span>.defaultHandle, <span class="keyword">this</span>.writeOptions, getKeyBytes(logIndex), newValueBytes);</span><br><span class="line">      writeCtx.joinAll();<span class="comment">//扩展点，写入上下文WriteContext生命周期</span></span><br><span class="line">      <span class="keyword">if</span> (newValueBytes != valueBytes) &#123;</span><br><span class="line">        doSync();<span class="comment">// //扩展点，Segment文件刷盘</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Fail to append entry.&quot;</span>, e);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">      Thread.currentThread().interrupt();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以复写protected </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> WriteContext <span class="title">newWriteContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> EmptyWriteContext.INSTANCE; <span class="comment">//空实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据写入，前置方法，可以复写protected </span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataAppend(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value,</span><br><span class="line">                              <span class="keyword">final</span> WriteContext ctx) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">  ctx.finishJob();</span><br><span class="line">  <span class="keyword">return</span> value; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  onSync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//空方法，可以复写protected </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>WriteContext写入上下文，实现写入任务化，异步化，和生命周期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A write context</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WriteContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Start a sub job.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Finish a sub job</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">finishJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Adds a callback that will be invoked after all sub jobs finish.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">addFinishHook</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Set an exception to context.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e exception</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Wait for all sub jobs finish.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">joinAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>子类RocksDBSegmentLogStorage扩展点，实现方式：</p>
<p>首先是BarrierWriteContext，支持多个Job写入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//类似CyclicBarrier </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BarrierWriteContext</span> <span class="keyword">implements</span> <span class="title">WriteContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CountDownEvent    events = <span class="keyword">new</span> CountDownEvent();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> Exception      e;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;Runnable&gt; hooks;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.events.incrementAndGet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addFinishHook</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hooks == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.hooks = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.hooks.add(r);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.events.countDown();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.e = e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">joinAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.events.await();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hooks != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (Runnable r : <span class="keyword">this</span>.hooks) &#123;</span><br><span class="line">        r.run();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.e != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Fail to apppend entries&quot;</span>, <span class="keyword">this</span>.e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//await和notify</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>             state    = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock      lock     = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Condition busyCond = <span class="keyword">this</span>.lock.newCondition();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> Object attachment;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getAttachment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.attachment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttachment</span><span class="params">(<span class="keyword">final</span> Object attachment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.attachment = attachment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> ++<span class="keyword">this</span>.state;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (--<span class="keyword">this</span>.state == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.busyCond.signalAll();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">this</span>.state &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.busyCond.await();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>扩展方法：onDataAppend</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataAppend(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value, <span class="keyword">final</span> WriteContext ctx) <span class="keyword">throws</span> IOException,                                                                                                InterruptedException &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> waitToWroteBytes = SegmentFile.getWriteBytes(value);</span><br><span class="line">  SegmentFile lastSegmentFile = getLastSegmentFile(logIndex, waitToWroteBytes, <span class="keyword">true</span>, ctx);<span class="comment">//获取Semgent文件</span></span><br><span class="line">  <span class="keyword">if</span> (lastSegmentFile.reachesFileEndBy(waitToWroteBytes)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Too large value size: &quot;</span> + value.length + <span class="string">&quot;, maxSegmentFileSize=&quot;</span></span><br><span class="line">                          + <span class="keyword">this</span>.maxSegmentFileSize);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value.length &lt; <span class="keyword">this</span>.valueSizeThreshold) &#123; <span class="comment">//小value，直接写入Rocksdb</span></span><br><span class="line">    <span class="comment">// Small value will be stored in rocksdb directly.</span></span><br><span class="line">    lastSegmentFile.setLastLogIndex(logIndex);</span><br><span class="line">    ctx.finishJob();<span class="comment">//调用WriteContext上下文的生命周期方法</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// Large value is stored in segment file and returns an encoded location info that will be stored in rocksdb.</span></span><br><span class="line">  <span class="comment">//大Value</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> pos = lastSegmentFile.write(logIndex, value, ctx);<span class="comment">//写入Segment，不是同步写入，后台线程异步写入</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex = lastSegmentFile.getFirstLogIndex();</span><br><span class="line">  <span class="keyword">return</span> encodeLocationMetadata(firstLogIndex, pos); <span class="comment">//返回metadata，不是实际存储的value，实际的value在Segment文件里面</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SegmentFile <span class="title">getLastSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">int</span> waitToWroteSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="keyword">final</span> <span class="keyword">boolean</span> createIfNecessary, <span class="keyword">final</span> WriteContext ctx)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">InterruptedException </span>&#123;</span><br><span class="line">  SegmentFile lastFile = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> segmentCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.segments.isEmpty()) &#123; <span class="comment">//存在Segment文件</span></span><br><span class="line">        segmentCount = <span class="keyword">this</span>.segments.size();</span><br><span class="line">        <span class="keyword">final</span> SegmentFile currLastFile = getLastSegmentWithoutLock();</span><br><span class="line">        <span class="keyword">if</span> (waitToWroteSize &lt;= <span class="number">0</span> || !currLastFile.reachesFileEndBy(waitToWroteSize)) &#123;</span><br><span class="line">          lastFile = currLastFile;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lastFile == <span class="keyword">null</span> &amp;&amp; createIfNecessary) &#123;</span><br><span class="line">      lastFile = createNewSegmentFile(logIndex, segmentCount, ctx); <span class="comment">//不存在，创建</span></span><br><span class="line">      <span class="keyword">if</span> (lastFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> lastFile;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Try again</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lastFile;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SegmentFile <span class="title">createNewSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">int</span> oldSegmentCount,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="keyword">final</span> WriteContext ctx)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">  SegmentFile segmentFile = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// CAS by segments count.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.segments.size() != oldSegmentCount) &#123;</span><br><span class="line">      <span class="keyword">return</span> segmentFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.segments.isEmpty()) &#123; </span><br><span class="line">      <span class="comment">// Sync current last file and correct it&#x27;s lastLogIndex.</span></span><br><span class="line">      <span class="keyword">final</span> SegmentFile currLastFile = getLastSegmentWithoutLock();</span><br><span class="line">      currLastFile.setLastLogIndex(logIndex - <span class="number">1</span>);</span><br><span class="line">      ctx.startJob();</span><br><span class="line">      <span class="comment">// Attach a finish hook to set last segment file to be read-only.</span></span><br><span class="line">      ctx.addFinishHook(() -&gt; currLastFile.setReadOnly(<span class="keyword">true</span>));</span><br><span class="line">      <span class="comment">// Run sync in parallel</span></span><br><span class="line">      <span class="keyword">this</span>.writeExecutor.execute(() -&gt; &#123; <span class="comment">//异步写入，线程池</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          currLastFile.sync(isSync());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">          ctx.setError(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          ctx.finishJob();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    segmentFile = allocateSegmentFile(logIndex);<span class="comment">//从预分配Semgent读取</span></span><br><span class="line">    <span class="keyword">return</span> segmentFile;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SegmentFile <span class="title">allocateSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.allocateLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>.blankSegments.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emptyCond.await();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> AllocatedResult result = <span class="keyword">this</span>.blankSegments.pollFirst();<span class="comment">//预分配队列</span></span><br><span class="line">    <span class="keyword">if</span> (result.ie != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> result.ie;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.fullCond.signal();</span><br><span class="line">    result.segmentFile.setFirstLogIndex(index);</span><br><span class="line">    <span class="keyword">this</span>.segments.add(result.segmentFile);</span><br><span class="line">    <span class="keyword">return</span> result.segmentFile;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.allocateLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>lastSegmentFile.write，Segment的写方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> WriteContext ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> pos = -<span class="number">1</span>;</span><br><span class="line">  MappedByteBuffer buf = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> (<span class="keyword">this</span>.wrotePos == <span class="keyword">this</span>.buffer.position());</span><br><span class="line">    buf = <span class="keyword">this</span>.buffer;</span><br><span class="line">    pos = <span class="keyword">this</span>.wrotePos;</span><br><span class="line">    <span class="keyword">this</span>.wrotePos += RECORD_MAGIC_BYTES_SIZE + RECORD_DATA_LENGTH_SIZE + data.length;</span><br><span class="line">    <span class="keyword">this</span>.buffer.position(<span class="keyword">this</span>.wrotePos);</span><br><span class="line">    <span class="comment">// Update log index.</span></span><br><span class="line">    <span class="keyword">if</span> (isBlank() || pos == HEADER_SIZE) &#123;</span><br><span class="line">      <span class="keyword">this</span>.header.firstLogIndex = logIndex;</span><br><span class="line">      <span class="comment">// we don&#x27;t need to call fsync header here, the new header will be flushed with this wrote.</span></span><br><span class="line">      saveHeader(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.lastLogIndex = logIndex;</span><br><span class="line">    <span class="keyword">return</span> pos;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> wroteIndex = pos;</span><br><span class="line">    <span class="keyword">final</span> MappedByteBuffer buffer = buf;</span><br><span class="line">    <span class="keyword">this</span>.writeExecutor.execute(() -&gt; &#123; <span class="comment">//线程，异步写入</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        put(buffer, wroteIndex, RECORD_MAGIC_BYTES); <span class="comment">//写入 魔法数字</span></span><br><span class="line">        putInt(buffer, wroteIndex + RECORD_MAGIC_BYTES_SIZE, data.length); <span class="comment">//写入头信息</span></span><br><span class="line">        put(buffer, wroteIndex + RECORD_MAGIC_BYTES_SIZE + RECORD_DATA_LENGTH_SIZE, data);<span class="comment">//写入数据data</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">        ctx.setError(e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ctx.finishJob();<span class="comment">//调用声明写上下文周期方法</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>encodeLocationMetadata方法，生产的metadata信息，才是写入的RocksDB的Value数据，返回父类，会触发newValueBytes != valueBytes条件，会调用刷盘doSync()方法，可能会引起刷盘（需要isSync=true）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line">* <span class="function">Encode segment file <span class="title">firstLogIndex</span><span class="params">(fileName)</span> and position to a <span class="keyword">byte</span> array in the format of:</span></span><br><span class="line"><span class="function">* &lt;ul&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; magic <span class="title">bytes</span><span class="params">(<span class="number">2</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; <span class="title">reserved</span> <span class="params">(<span class="number">2</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; <span class="title">firstLogIndex</span><span class="params">(<span class="number">8</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; wrote <span class="title">position</span><span class="params">(<span class="number">4</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  * &lt;/ul&gt;</span></span><br><span class="line"><span class="function">  * @param firstLogIndex the first log index</span></span><br><span class="line"><span class="function">  * @param pos           the wrote position</span></span><br><span class="line"><span class="function">  * @return segment info</span></span><br><span class="line"><span class="function">  */</span></span><br><span class="line"><span class="function">  <span class="keyword">private</span> <span class="keyword">byte</span>[] <span class="title">encodeLocationMetadata</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex, <span class="keyword">final</span> <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] newData = <span class="keyword">new</span> <span class="keyword">byte</span>[LOCATION_METADATA_SIZE];</span><br><span class="line">  System.arraycopy(SegmentFile.RECORD_MAGIC_BYTES, <span class="number">0</span>, newData, <span class="number">0</span>, SegmentFile.RECORD_MAGIC_BYTES_SIZE);</span><br><span class="line">  <span class="comment">// 2 bytes reserved</span></span><br><span class="line">  Bits.putLong(newData, SegmentFile.RECORD_MAGIC_BYTES_SIZE + <span class="number">2</span>, firstLogIndex);</span><br><span class="line">  Bits.putInt(newData, SegmentFile.RECORD_MAGIC_BYTES_SIZE + <span class="number">2</span> + <span class="number">8</span>, pos);</span><br><span class="line">  <span class="keyword">return</span> newData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//覆盖父类的onSync方法</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> SegmentFile lastSegmentFile = getLastSegmentFileForRead();</span><br><span class="line">  <span class="keyword">if</span> (lastSegmentFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">    lastSegmentFile.sync(isSync());<span class="comment">//调用Segment文件的sync方法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Segment文件的sync方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Forces any changes made to this segment file&#x27;s content to be written to the</span></span><br><span class="line"><span class="comment">       * storage device containing the mapped file.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  MappedByteBuffer buf = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.committedPos &gt;= <span class="keyword">this</span>.wrotePos) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.committedPos = <span class="keyword">this</span>.wrotePos;</span><br><span class="line">    buf = <span class="keyword">this</span>.buffer;</span><br><span class="line">    LOG.debug(<span class="string">&quot;Commit segment file &#123;&#125; at pos &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path, <span class="keyword">this</span>.committedPos);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sync) &#123;</span><br><span class="line">    fsync(buf);<span class="comment">//刷盘</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fsync</span><span class="params">(<span class="keyword">final</span> MappedByteBuffer buffer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (buffer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">long</span> startMs = Utils.monotonicMs();</span><br><span class="line">    buffer.force(); <span class="comment">//MappedByteBuffer的flush方法</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> cost = Utils.monotonicMs() - startMs;</span><br><span class="line">    <span class="keyword">if</span> (cost &gt;= FSYNC_COST_MS_THRESHOLD) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Call fsync on file &#123;&#125;  cost &#123;&#125; ms.&quot;</span>, <span class="keyword">this</span>.path, cost);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，后台Segment分配线程，加快分配逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSegmentAllocator</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// Warmup</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.blankSegments.isEmpty()) &#123;</span><br><span class="line">    doAllocateSegment0();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Start the thread.</span></span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator = <span class="keyword">new</span> Thread(<span class="keyword">this</span>::doAllocateSegment);</span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator.setName(<span class="string">&quot;SegmentAllocator&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAllocateSegment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;SegmentAllocator is started.&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">    doAllocateSegmentInLock();</span><br><span class="line">    doSwapOutSegments(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">&quot;SegmentAllocator exit.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntrys写入方法-多个Entrys"><a href="#appendEntrys写入方法-多个Entrys" class="headerlink" title="appendEntrys写入方法(多个Entrys)"></a>appendEntrys写入方法(多个Entrys)</h3><p>RocksDBLogStorage父类，多个Entrys，WriteContext的notify方法就可以串起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entries == <span class="keyword">null</span> || entries.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> entriesCount = entries.size();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> ret = executeBatch(batch -&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> WriteContext writeCtx = newWriteContext();<span class="comment">//初始化上下文</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entriesCount; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> LogEntry entry = entries.get(i);</span><br><span class="line">      <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">        addConfBatch(entry, batch);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        writeCtx.startJob(); <span class="comment">//开起任务，任务数+1</span></span><br><span class="line">        addDataBatch(entry, batch, writeCtx);<span class="comment">//写入上下文传递</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    writeCtx.joinAll(); <span class="comment">//等待所有job完成</span></span><br><span class="line">    doSync(); <span class="comment">//刷一个Segment到磁盘</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">    <span class="keyword">return</span> entriesCount;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-1"><a href="#getEntry读取方法-1" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><p>同写入方法，RocksDBSegmentLogStorage读取方法，通过扩展父类RocksDBLogStorage的扩展方法，实现Segment文件的读取。</p>
<p>父类的读取扩展方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getEntryFromDB(index);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125; in data path: &#123;&#125;.&quot;</span>, index, <span class="keyword">this</span>.path, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnlyForTest</span></span><br><span class="line"><span class="function">LogEntry <span class="title">getEntryFromDB</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> IOException, RocksDBException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes = getKeyBytes(index);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] bs = onDataGet(index, getValueFromRocksDB(keyBytes));<span class="comment">//扩展方法OnDataGet</span></span><br><span class="line">  <span class="keyword">if</span> (bs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> LogEntry entry = <span class="keyword">this</span>.logEntryDecoder.decode(bs);</span><br><span class="line">    <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> entry;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Bad log entry format for index=&#123;&#125;, the log data is: &#123;&#125;.&quot;</span>, index, BytesUtil.toHex(bs));</span><br><span class="line">      <span class="comment">// invalid data remove? TODO</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//直接放回，可以复写protected</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataGet(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RocksDBSegmentLogStorage的onDataGet方法，才是关键</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataGet(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value) <span class="keyword">throws</span> IOException &#123;<span class="comment">//这里的Value是从RockDB读取的值</span></span><br><span class="line">  <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length != LOCATION_METADATA_SIZE) &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; offset &lt; SegmentFile.RECORD_MAGIC_BYTES_SIZE; offset++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value[offset] != SegmentFile.RECORD_MAGIC_BYTES[offset]) &#123;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// skip reserved</span></span><br><span class="line">  offset += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex = Bits.getLong(value, offset); <span class="comment">//根据特定格式查找index</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> pos = Bits.getInt(value, offset + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">final</span> SegmentFile file = binarySearchFileByFirstLogIndex(firstLogIndex);<span class="comment">//二分法查找Segment文件</span></span><br><span class="line">  <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> file.read(logIndex, pos);<span class="comment">//从Segment文件读取</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LogitLogStorage"><a href="#LogitLogStorage" class="headerlink" title="LogitLogStorage"></a>LogitLogStorage</h2><p>LogitLogStorage，是Java代码，实现的File文件存储。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A logStorage implemented by java</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogitLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger           LOG                    = LoggerFactory.getLogger(LogitLogStorage.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           INDEX_STORE_PATH       = <span class="string">&quot;LogIndex&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           SEGMENT_STORE_PATH     = <span class="string">&quot;LogSegment&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           CONF_STORE_PATH        = <span class="string">&quot;LogConf&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           FIRST_INDEX_CHECKPOINT = <span class="string">&quot;FirstLogIndexCheckpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FirstLogIndexCheckpoint firstLogIndexCheckpoint;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock           readWriteLock          = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                    readLock               = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                    writeLock              = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> StoreOptions            storeOptions;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                  indexStorePath; <span class="comment">//索引目录</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                  segmentStorePath; <span class="comment">//segment文件目录</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                  confStorePath;</span><br><span class="line">  <span class="keyword">private</span> String                        groupId;</span><br><span class="line">  <span class="keyword">private</span> ConfigurationManager          configurationManager;</span><br><span class="line">  <span class="keyword">private</span> LogEntryEncoder               logEntryEncoder;</span><br><span class="line">  <span class="keyword">private</span> LogEntryDecoder               logEntryDecoder;</span><br><span class="line">  <span class="keyword">private</span> SegmentLogDB                  segmentLogDB; <span class="comment">//Segment文件数据库，继承AbstractDB</span></span><br><span class="line">  <span class="keyword">private</span> IndexDB                       indexDB; <span class="comment">//索引文件数据库，继承AbstractDB</span></span><br><span class="line">  <span class="keyword">private</span> ConfDB                        confDB;</span><br><span class="line">  <span class="keyword">private</span> LogStoreFactory               logStoreFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件数据库，都继承AbstractDB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.SegmentLogDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB that stores logEntry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentLogDB</span> <span class="keyword">extends</span> <span class="title">AbstractDB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SegmentLogDB</span><span class="params">(<span class="keyword">final</span> String storePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(storePath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FileType <span class="title">getDBFileType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> FileType.FILE_SEGMENT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDBFileSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.storeOptions.getSegmentFileSize();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.IndexDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB that stores index entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexDB</span> <span class="keyword">extends</span> <span class="title">AbstractDB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">IndexDB</span><span class="params">(<span class="keyword">final</span> String storePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(storePath);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.AbstractDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB parent class that invokes fileManager and anager</span></span><br><span class="line"><span class="comment"> * and wrappers uniform functions such as recover() etc..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDB</span> <span class="keyword">implements</span> <span class="title">Lifecycle</span>&lt;<span class="title">LogStoreFactory</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger      LOG                     = LoggerFactory.getLogger(AbstractDB.class);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String      FLUSH_STATUS_CHECKPOINT = <span class="string">&quot;FlushStatusCheckpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String      ABORT_FILE              = <span class="string">&quot;Abort&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> String           storePath;</span><br><span class="line">  <span class="keyword">protected</span> FileManager            fileManager; <span class="comment">//文件管理器</span></span><br><span class="line">  <span class="keyword">protected</span> ServiceManager         serviceManager;</span><br><span class="line">  <span class="keyword">protected</span> LogStoreFactory        logStoreFactory;</span><br><span class="line">  <span class="keyword">protected</span> StoreOptions           storeOptions;</span><br><span class="line">  <span class="keyword">protected</span> AbortFile              abortFile;</span><br><span class="line">  <span class="keyword">protected</span> FlushStatusCheckpoint  flushStatusCheckpoint;</span><br><span class="line">  <span class="keyword">private</span> ScheduledExecutorService checkpointExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-2"><a href="#getEntry读取方法-2" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; getFirstLogIndex() || index &gt; getLastLogIndex()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> IndexEntry indexEntry = <span class="keyword">this</span>.indexDB.lookupIndex(index);<span class="comment">//先查索引</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> phyPosition = indexEntry.getPosition();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span> logType = indexEntry.getLogType();</span><br><span class="line">    <span class="keyword">if</span> (phyPosition != -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">byte</span>[] logBytes;</span><br><span class="line">      <span class="keyword">if</span> (logType == IndexType.IndexSegment.getType()) &#123;</span><br><span class="line">        logBytes = <span class="keyword">this</span>.segmentLogDB.lookupLog(index, phyPosition);<span class="comment">//再从Segment数据库读取</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logBytes = <span class="keyword">this</span>.confDB.lookupLog(index, phyPosition);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.logEntryDecoder.decode(logBytes);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-2"><a href="#appendEntry写入方法-2" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] logData = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">    <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">      <span class="keyword">return</span> doAppendEntry(logIndex, logData, <span class="keyword">this</span>.confDB, IndexType.IndexConf, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> doAppendEntry(logIndex, logData, <span class="keyword">this</span>.segmentLogDB, IndexType.IndexSegment, <span class="keyword">true</span>);<span class="comment">//具体逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">doAppendEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> AbstractDB logDB,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">final</span> IndexType indexType, <span class="keyword">final</span> <span class="keyword">boolean</span> isWaitingFlush)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (logDB == <span class="keyword">null</span> || <span class="keyword">this</span>.indexDB == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append log async , get position infos</span></span><br><span class="line">    <span class="keyword">final</span> Pair&lt;Integer, Long&gt; logPair = logDB.appendLogAsync(logIndex, data); </span><br><span class="line">    <span class="keyword">if</span> (logPair.getFirst() &lt; <span class="number">0</span> || logPair.getSecond() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Pair&lt;Integer, Long&gt; indexPair = <span class="keyword">this</span>.indexDB</span><br><span class="line">      .appendIndexAsync(logIndex, logPair.getFirst(), indexType); <span class="comment">//写入索引文件数据库</span></span><br><span class="line">    <span class="keyword">if</span> (indexPair.getFirst() &lt; <span class="number">0</span> || indexPair.getSecond() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save first log index</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.firstLogIndexCheckpoint.isInit()) &#123;</span><br><span class="line">      saveFirstLogIndex(logIndex); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isWaitingFlush) &#123;</span><br><span class="line">      <span class="keyword">return</span> waitForFlush(logDB, logPair.getSecond(), indexPair.getSecond());<span class="comment">//写入Segment文件数据库</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitForFlush</span><span class="params">(<span class="keyword">final</span> AbstractDB logDB, <span class="keyword">final</span> <span class="keyword">long</span> exceptedLogPosition,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">final</span> <span class="keyword">long</span> exceptedIndexPosition)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> maxFlushTimes = <span class="keyword">this</span>.storeOptions.getMaxFlushTimes();</span><br><span class="line">  <span class="comment">// We should flush log db first, because even If the power fails after flushing the log db</span></span><br><span class="line">  <span class="comment">// we can restore the index db based on the log db.</span></span><br><span class="line">  <span class="keyword">if</span> (!logDB.waitForFlush(exceptedLogPosition, maxFlushTimes)) &#123; <span class="comment">//写入Segment文件数据库</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.indexDB.waitForFlush(exceptedIndexPosition, maxFlushTimes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="HybridLogStorage"><a href="#HybridLogStorage" class="headerlink" title="HybridLogStorage"></a>HybridLogStorage</h2><p>HybridLogStorage是混合日志存储，有新旧两种实现，可以扩展LogStorage的能力，比如更换LogStorage的具体实现。</p>
<blockquote>
<p>HybridLogStorage is used to be compatible with new and old logStorage</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HybridLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span> </span>&#123;</span><br><span class="line">  <span class="comment">//日志检查点</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String                 STATUS_CHECKPOINT_PATH = <span class="string">&quot;HybridStatusCheckpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> HybridStorageStatusCheckpoint statusCheckpoint;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>                    isOldStorageExist; <span class="comment">//判断是否存在旧LogStorage</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LogStorage                    oldLogStorage; <span class="comment">//旧LogStorage</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LogStorage                    newLogStorage; <span class="comment">//新LogStorage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The index which separates the oldStorage and newStorage</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span>                                thresholdIndex; <span class="comment">//使用新旧LogStorage的分隔Log Index，即阀值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-3"><a href="#getEntry读取方法-3" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index &gt;= <span class="keyword">this</span>.thresholdIndex) &#123; <span class="comment">//大于阀值，从newLogStorage读取</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.newLogStorage.getEntry(index);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isOldStorageExist()) &#123; <span class="comment">//小于阀值，且存在oldLogStorage，从oldLogStorage读取</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.oldLogStorage.getEntry(index);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-3"><a href="#appendEntry写入方法-3" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.newLogStorage.appendEntry(entry); <span class="comment">//写入，都写入newLogStorage</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何确定thresholdIndex"><a href="#如何确定thresholdIndex" class="headerlink" title="如何确定thresholdIndex"></a>如何确定thresholdIndex</h3><p>使用old或者new LogStorage的关键，是thresholdIndex，如何确定thresholdIndex？在init方法，检查点HybridStorageStatusCheckpoint statusCheckpoint，确认存在oldLogStorage，oldLogStorage的lastLogIndex+1，即为thresholdIndex</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> LogStorageOptions opts)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.statusCheckpoint.load(); <span class="comment">//日志检查点 Checkpoint#load方法</span></span><br><span class="line">    <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">this</span>.statusCheckpoint.isOldStorageExist;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isOldStorageExist) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.oldLogStorage != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.oldLogStorage.init(opts)) &#123;</span><br><span class="line">          LOG.warn(<span class="string">&quot;Init old log storage failed when startup hybridLogStorage&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> lastLogIndex = <span class="keyword">this</span>.oldLogStorage.getLastLogIndex();</span><br><span class="line">        <span class="keyword">if</span> (lastLogIndex == <span class="number">0</span>) &#123;</span><br><span class="line">          shutdownOldLogStorage();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastLogIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// Still exists logs in oldLogStorage, need to wait snapshot</span></span><br><span class="line">          <span class="keyword">this</span>.thresholdIndex = lastLogIndex + <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">true</span>;</span><br><span class="line">          LOG.info(</span><br><span class="line">            <span class="string">&quot;Still exists logs in oldLogStorage, lastIndex: &#123;&#125;,  need to wait snapshot to truncate logs&quot;</span>,</span><br><span class="line">            lastLogIndex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">false</span>;</span><br><span class="line">        saveStatusCheckpoint();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.newLogStorage.init(opts)) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Init new log storage failed when startup hybridLogStorage&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Error happen when when load hybrid status checkpoint&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//日志检查点 Checkpoint#load方法</span></span><br><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.file.assit.Checkpoint</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Checkpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Checkpoint</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.path = path;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Encode metadata</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span>[] encode();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Decode file data</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] bs)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile file = <span class="keyword">new</span> ProtoBufFile(<span class="keyword">this</span>.path);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] data = <span class="keyword">this</span>.encode();</span><br><span class="line">    <span class="keyword">final</span> LocalFileMeta meta = LocalFileMeta.newBuilder() </span><br><span class="line">      .setUserMeta(ZeroByteStringHelper.wrap(data)) </span><br><span class="line">      .build();</span><br><span class="line">    <span class="keyword">return</span> file.save(meta, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile file = <span class="keyword">new</span> ProtoBufFile(<span class="keyword">this</span>.path); <span class="comment">//文件存储</span></span><br><span class="line">    <span class="keyword">final</span> LocalFileMeta meta = file.load();</span><br><span class="line">    <span class="keyword">if</span> (meta != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] data = meta.getUserMeta().toByteArray();</span><br><span class="line">      decode(data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HybridStorageStatusCheckpoint#decode</span></span><br><span class="line"><span class="comment">// com.alipay.sofa.jraft.storage.file.assit.HybridStorageStatusCheckpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HybridStorageStatusCheckpoint</span> <span class="keyword">extends</span> <span class="title">Checkpoint</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">boolean</span> isOldStorageExist = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HybridStorageStatusCheckpoint</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(path);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span>[] encode() &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">short</span> val = (<span class="keyword">short</span>) (<span class="keyword">this</span>.isOldStorageExist ? <span class="number">1</span> : <span class="number">0</span>); <span class="comment">//是否存在oldLogStorage的标志位</span></span><br><span class="line">    Bits.putShort(bs, <span class="number">0</span>, val);</span><br><span class="line">    <span class="keyword">return</span> bs;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] bs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bs.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">short</span> val = Bits.getShort(bs, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.isOldStorageExist = val == <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HybridLogStorage的局限性"><a href="#HybridLogStorage的局限性" class="headerlink" title="HybridLogStorage的局限性"></a>HybridLogStorage的局限性</h3><p>HybridLogStorage看着很美好，但是目前HybridLogStorage有其局限性，构造函数里面，限制了newLogStorage的实现，只能是Java实现的LogitLogStorage。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HybridLogStorage</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> StoreOptions storeOptions, <span class="keyword">final</span> LogStorage oldStorage)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> String newLogStoragePath = Paths.get(path, storeOptions.getStoragePath()).toString();</span><br><span class="line">  <span class="keyword">this</span>.newLogStorage = <span class="keyword">new</span> LogitLogStorage(newLogStoragePath, storeOptions);<span class="comment">//没办法修改newLogStorage的实现</span></span><br><span class="line">  <span class="keyword">this</span>.oldLogStorage = oldStorage;</span><br><span class="line">  <span class="keyword">final</span> String statusCheckpointPath = Paths.get(path, STATUS_CHECKPOINT_PATH).toString();</span><br><span class="line">  <span class="keyword">this</span>.statusCheckpoint = <span class="keyword">new</span> HybridStorageStatusCheckpoint(statusCheckpointPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">SOFAJRaft日志存储分析（二）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-02 17:08:23" itemprop="dateCreated datePublished" datetime="2022-08-02T17:08:23+08:00">2022-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 11:43:14" itemprop="dateModified" datetime="2024-02-27T11:43:14+08:00">2024-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">日志存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="LogStorage分析"><a href="#LogStorage分析" class="headerlink" title="LogStorage分析"></a>LogStorage分析</h1><p>LogStorage 是日志存储实现，默认实现基于 RocksDB 存储，通过 LogStorage 接口扩展自定义日志存储实现。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.LogStorage </span><br></pre></td></tr></table></figure>

<p>LogStorage 日志存储实现，核心 API 接口包括：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LogStorage</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span>&lt;<span class="title">LogStorageOptions</span>&gt;, <span class="title">Storage</span> </span>&#123;</span><br><span class="line">  <span class="comment">//返回日志里的首/末个日志索引；</span></span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">getFirstLogIndex</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">getLastLogIndex</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//按照日志索引获取 Log Entry 及其任期；</span></span><br><span class="line">  <span class="function">LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">getTerm</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//把单个/批量 Log Entry 添加到日志存储；</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//从 Log 存储头部/末尾删除日志；</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">truncatePrefix</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> firstIndexKept)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">truncateSuffix</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> lastIndexKept)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//删除所有现有日志，重置下任日志索引。</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">reset</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> nextLogIndex)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中LogStorage，有五个实现，Rocks的两个实现是默认实现，其余三个是jraft-extension包提供的额外实现。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034208.jpg" alt="e6c9d24egy1h4sn708bdaj218o0b6ad6"></p>
<p>而，具体使用哪种实现，是通过SPI的方式，以BDBLogStorage为例。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034221.jpg" alt="e6c9d24egy1h4sncopqjbj21xi0sijwa"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI(priority = 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BDBLogStorageJRaftServiceFactory</span> <span class="keyword">extends</span> <span class="title">DefaultJRaftServiceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> LogStorage <span class="title">createLogStorage</span><span class="params">(String uri, RaftOptions raftOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BDBLogStorage(uri, raftOptions);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RocksDBLogStorage"><a href="#RocksDBLogStorage" class="headerlink" title="RocksDBLogStorage"></a>RocksDBLogStorage</h1><p>RocksDBLogStorage是LogStorage的默认实现，DefaultJRaftServiceFactory返回的是RocksDBLogStorage。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJRaftServiceFactory</span> <span class="keyword">implements</span> <span class="title">JRaftServiceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> LogStorage <span class="title">createLogStorage</span><span class="params">(<span class="keyword">final</span> String uri, <span class="keyword">final</span> RaftOptions raftOptions)</span> </span>&#123;</span><br><span class="line">    Requires.requireTrue(StringUtils.isNotBlank(uri), <span class="string">&quot;Blank log storage uri.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RocksDBLogStorage(uri, raftOptions);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RocksDBLogStorage主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String                    path; <span class="comment">//DB存储数据路径</span></span><br><span class="line"><span class="keyword">private</span> RocksDB                         db; <span class="comment">//实际存储RocksDB</span></span><br><span class="line"><span class="keyword">private</span> ColumnFamilyHandle              defaultHandle; <span class="comment">//ColumnFamilyHandle 完成RocksDB的读写</span></span><br><span class="line"><span class="keyword">private</span> ColumnFamilyHandle              confHandle; <span class="comment">//ColumnFamily是K/V的逻辑分区</span></span><br></pre></td></tr></table></figure>

<h2 id="getEntry读取方法"><a href="#getEntry读取方法" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h2><p>getEntry读取方法，最终是调用RocksDB的get方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getEntryFromDB(index); <span class="comment">//从DB读取</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125; in data path: &#123;&#125;.&quot;</span>, index, <span class="keyword">this</span>.path, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnlyForTest</span></span><br><span class="line"><span class="function">LogEntry <span class="title">getEntryFromDB</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> IOException, RocksDBException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes = getKeyBytes(index); <span class="comment">// Key，Value都是字节流</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] bs = onDataGet(index, getValueFromRocksDB(keyBytes));</span><br><span class="line">  <span class="keyword">if</span> (bs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> LogEntry entry = <span class="keyword">this</span>.logEntryDecoder.decode(bs);</span><br><span class="line">    <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> entry;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Bad log entry format for index=&#123;&#125;, the log data is: &#123;&#125;.&quot;</span>, index, BytesUtil.toHex(bs));</span><br><span class="line">      <span class="comment">// invalid data remove? TODO</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] getValueFromRocksDB(<span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes) <span class="keyword">throws</span> RocksDBException &#123;</span><br><span class="line">  checkState();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.db.get(<span class="keyword">this</span>.defaultHandle, keyBytes); </span><br><span class="line">  <span class="comment">//调用 org.rocksdb.RocksDB#get(org.rocksdb.ColumnFamilyHandle, byte[])</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="appendEntry写入方法"><a href="#appendEntry写入方法" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h2><p>appendEntry写入方法，最终是调用RocksDB的put方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">    <span class="keyword">return</span> executeBatch(batch -&gt; addConfBatch(entry, batch));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.db == <span class="keyword">null</span>) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;DB not initialized or destroyed in data path: &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> WriteContext writeCtx = newWriteContext();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] valueBytes = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] newValueBytes = onDataAppend(logIndex, valueBytes, writeCtx);</span><br><span class="line">      writeCtx.startJob();</span><br><span class="line">      <span class="keyword">this</span>.db.put(<span class="keyword">this</span>.defaultHandle, <span class="keyword">this</span>.writeOptions, getKeyBytes(logIndex), newValueBytes);</span><br><span class="line">      <span class="comment">//调用 org.rocksdb.RocksDB#put(org.rocksdb.ColumnFamilyHandle, org.rocksdb.WriteOptions, byte[], byte[])</span></span><br><span class="line">      writeCtx.joinAll();</span><br><span class="line">      <span class="keyword">if</span> (newValueBytes != valueBytes) &#123;</span><br><span class="line">        doSync();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Fail to append entry.&quot;</span>, e);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">      Thread.currentThread().interrupt();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RocksDB"><a href="#RocksDB" class="headerlink" title="RocksDB"></a>RocksDB</h1><p>RocksDBLogStorage底层是依托于<a target="_blank" rel="noopener" href="http://rocksdb.org/">rocksdb</a>，<a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb">github-rocksdb</a>完成存储。</p>
<blockquote>
<p>RocksDB is an <strong>embeddable</strong>  <strong>persistent</strong> <strong>key-value</strong> store for fast storage.</p>
</blockquote>
<blockquote>
<p>The RocksDB library provides a persistent key value store. <strong>Keys and values are arbitrary byte arrays</strong>. The keys are ordered within the key value store according to a user-specified comparator function.</p>
</blockquote>
<blockquote>
<p>This code is a library that forms the core building block for a fast key-value server, especially suited for storing data on flash drives. <strong>It has a Log-Structured-Merge-Database (LSM) design with flexible tradeoffs between Write-Amplification-Factor (WAF), Read-Amplification-Factor (RAF) and Space-Amplification-Factor (SAF).</strong> It has multi-threaded compactions, making it especially suitable for storing multiple terabytes of data in a single database.</p>
</blockquote>
<p>翻译一下，RocksDB 是基于 LSM-Tree 数据结构使用 C++ 编写的嵌入式 KV 存储引擎，其键值均允许使用二进制流。</p>
<p>RocksDB被广泛用于其他开源中间件。其中，Pulsar 使用 BookKeeper 作为存储层，BookKeeper 底层使用到了 RocksDB 来保存 Entry (BookKeeper 中的数据存储单元) 对应的位置索引。主流开源的 pika/kvrocks，以及云厂商的持久型 KV 存储服务，底层都是基于 RocksDB。还有大名鼎鼎的 TiDB，其存储引擎也是 RocksDB。</p>
<h1 id="LSM"><a href="#LSM" class="headerlink" title="LSM"></a>LSM</h1><h2 id="LSM定义"><a href="#LSM定义" class="headerlink" title="LSM定义"></a>LSM定义</h2><p>LSM的论文：<a target="_blank" rel="noopener" href="http://paperhub.s3.amazonaws.com/18e91eb4db2114a06ea614f0384f2784.pdf">The Log-Structured Merge-Tree (LSM Tree)</a> – O’Neil et al. ’96.</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree">维基LSM定义</a>，其中，比较有意思的描述：</p>
<blockquote>
<p>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_science">computer science</a>, the <strong>log-structured merge-tree</strong> (also known as <strong>LSM tree</strong>, or <strong>LSMT</strong>[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-1">1]</a>) is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_structure">data structure</a> with performance characteristics that make it attractive for providing <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Database_index">indexed</a> access to files with high insert volume, such as <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Transaction_log">transactional log data</a>. LSM trees, like other <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Search_tree">search trees</a>, maintain key-value pairs. LSM trees maintain data in two or more separate structures, each of which is optimized for its respective underlying storage medium; data is synchronized between the two structures efficiently, in batches.</p>
<p>One simple version of the LSM tree is a two-level LSM tree.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-2">2]</a> As described by <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Patrick_O'Neil">Patrick O’Neil</a>, a two-level LSM tree comprises two <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Tree_(data_structure)">tree-like</a> structures, called C0 and C1. C0 is smaller and entirely resident in memory, whereas C1 is resident on disk. New records are inserted into the memory-resident C0 component. If the insertion causes the C0 component to exceed a certain size threshold, a contiguous segment of entries is removed from C0 and merged into C1 on disk. The performance characteristics of LSM trees stem from the fact that each component is tuned to the characteristics of its underlying storage medium, and that data is efficiently migrated across media in rolling batches, using an algorithm reminiscent of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Merge_sort">merge sort</a>.</p>
<p>In order to keep down the cost of queries, the system must avoid a situation where there are too many runs.</p>
<p>LSM trees are used in data stores such as <a target="_blank" rel="noopener" href="https://asterixdb.apache.org/">Apache AsterixDB</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bigtable">Bigtable</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/HBase">HBase</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/LevelDB">LevelDB</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Apache_Accumulo">Apache Accumulo</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SQLite4">SQLite4</a>,[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-6">6]</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Tarantool">Tarantool</a>,[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-7">7]</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/RocksDB">RocksDB</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/WiredTiger">WiredTiger</a>,[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-8">8]</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Apache_Cassandra">Apache Cassandra</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/InfluxDB">InfluxDB</a>[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-9">9]</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Scylla_(database)">ScyllaDB</a>.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034241.jpg" alt="e6c9d24egy1h4spclmcqdj212r0jgtaf"></p>
<p>LSM 树是一个复杂的算法设计，源自 Google 的 Bigtable 论文 （引入了术语 SSTable 和 memtable ）。基于 LSM 树算法设计实现的存储引擎，称之为 LSM 存储引擎。在 LevelDB、RocksDB、Cassandra、HBase 都基于 LSM 树算法实现了对应的存储引擎。</p>
<h2 id="LSM原理"><a href="#LSM原理" class="headerlink" title="LSM原理"></a>LSM原理</h2><h3 id="如何理解LSM？"><a href="#如何理解LSM？" class="headerlink" title="如何理解LSM？"></a>如何理解LSM？</h3><p>LSM解决的是高写负载的场景，通过顺序写入（sequential writes）优化数据写入。LSM tree持久化使用的是**Sorted Strings Table (SSTable)*<em>的数据结构。SSTables中key/value队，都是有序的，以key排序。其中key/value对，是以</em>segments*组织的。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034302.jpg" alt="e6c9d24egy1h4uj0jm861j20zu0jktbd"></p>
<h3 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h3><p>LSM 是顺序写入。当数据写入时，首先写入内存中的树结构（memtable），其底层数据结构通常是某种形式的排序树，如<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree">红黑树</a>。写入时，数据将添加到此红黑树中。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034316.jpg" alt="e6c9d24egy1h4uj73qdyej20cq0f4dgv"></p>
<p>当内存中的红黑树达到预定义的大小，它将会一段segment按排序顺序刷到（flush）磁盘。通过数据结构的排序性，内存和硬盘两个层次，保证了顺序写入特性，即无论以任何顺序插入，最后刷新到硬盘都是有序的。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034342.jpg" alt="e6c9d24egy1h4ujcwusetj21le0q2aez"></p>
<h3 id="数据读取"><a href="#数据读取" class="headerlink" title="数据读取"></a>数据读取</h3><p>如何在SSTable中找到一个值呢？一种简单的方法是扫描扫描segments分段，即从最新的部分开始，然后回到最老的部分，直到找到要寻找的目标。但是这种简答的方法是低效的，另外的简单的优化是保持内存中的稀疏索引（sparse index）。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034353.jpg" alt="e6c9d24egy1h4ujhloeguj211y0cg0uy"></p>
<p>使用稀疏索引快速查找所需Key前后的值的偏移量。例如，查找key <code>dollar</code>。稀疏索引执行二进制搜索，key <code>dollar</code>介于 <code>dog</code> and <code>downgrade</code>之间。现在，只需要从偏移量17208扫描到19504，就可以找到该值（或确定该值缺失）。</p>
<p>稀疏索引，可以很好提高查询效率，但是如何查找不存在的记录呢？因为以上的算法，只是针对某个分段。为了确定不存在，仍然会在所有段文件上循环查找。这是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bloom_filter">布隆过滤器bloom-filter</a>可以帮助解决问题。布隆过滤器是一种节省空间的数据结构，可以检查数据中是否存在值。在写入bloom过滤器时向其添加条目，并在读取开始时进行检查，以便有效地检查数据是否存在。</p>
<p>数据压缩</p>
<p>随着时间的推移，分段文件会积累。分段文件需要定期清理和维护，以防止分段文件数量失控。其过程称为压缩的过程。压缩是一个后台过程，不断地将旧分段组合到新分段的过程。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034413.jpg" alt="e6c9d24egy1h4uju3q33oj21d40oen28"></p>
<p>上图的示例中，segment1和segment2都有key <code>dog</code>的值。新分段segment4包含写入的最新值（84），即segment2的值转入segment4。很容易理解，根据时序性，新值覆盖原则。</p>
<h3 id="数据删除"><a href="#数据删除" class="headerlink" title="数据删除"></a>数据删除</h3><p>分段文件被视为不可变（immutable），如何从SSTable中删除数据？删除数据实际上遵循与写入数据完全相同的逻辑。删除数据时，会写入一个Key/Value键值对，但是Value是称为墓碑（<strong>tombstone</strong>）的特殊标记。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034429.jpg" alt="e6c9d24egy1h4uk1pj2rkj20y00cggng"></p>
<p>如上图所示，key <code>dog</code>在segment1的有value52，segment2有墓碑标记的key。这表明，当查询key <code>dog</code>时，会返回不存在的响应。这意味着删除操作实际上会占用磁盘空间，最终，压缩后，<code>dog</code>键值对才不存在于磁盘上。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>数据写入存储在内存树（memtable）中。优化措施，还将更新其他数据结构（bloom过滤器和稀疏索引）。</p>
</li>
<li><p>当内存树（memtable）变得太大时，数据将按排序顺序刷新到磁盘。内存和硬盘使用相同的数据结构（SSTable）。</p>
</li>
<li><p>查询优化，当读取数据时，首先检查bloom过滤器。如果bloom过滤器指示不存在，直接返回不存在。如果bloom过滤器指示该值存在，则从分段文件中查找。</p>
</li>
<li><p>对片段文件，通过稀疏索引提高效率。</p>
</li>
<li><p>数据删除，是延迟删除，通过写入带有特殊标记的Key/Value键值对来实现，真正删除，是发生在压缩时。</p>
</li>
</ul>
<h1 id="RocksDB中的LSM"><a href="#RocksDB中的LSM" class="headerlink" title="RocksDB中的LSM"></a>RocksDB中的LSM</h1><p>首先引用下，官网的顶层设计架构图，图中的一些概念，和LSM的概念是吻合的。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034438.jpg" alt="e6c9d24egy1h4v59lb4gij219j0u042b"></p>
<p>接下来，简单分析下读取数据Get的源码。</p>
<p>首先rocksdb封装了SuperVersion的结构体，包含当前版本号、内存中的 MemTable 和 Immutable MemTable、SST 文件信息等。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// column_family.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// holds references to memtable, all immutable memtables and version</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SuperVersion</span> &#123;</span></span><br><span class="line">  <span class="comment">// Accessing members of this class is not thread-safe and requires external</span></span><br><span class="line">  <span class="comment">// synchronization (ie db mutex held or on write thread).</span></span><br><span class="line">  ColumnFamilyData* cfd;</span><br><span class="line">  MemTable* mem; <span class="comment">//内存中的 MemTable</span></span><br><span class="line">  MemTableListVersion* imm; <span class="comment">//内存中的 Immutable MemTable，是集合</span></span><br><span class="line">  Version* current; <span class="comment">//SST文件，硬盘IO</span></span><br><span class="line">  MutableCFOptions mutable_cf_options;</span><br><span class="line">  <span class="comment">// Version number of the current SuperVersion</span></span><br><span class="line">  <span class="keyword">uint64_t</span> version_number; <span class="comment">//版本号</span></span><br><span class="line">  WriteStallCondition write_stall_condition;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Rocksdb 的 Get 接口 DBImpl::Get 其实现主要靠 DBImpl::GetImpl 函数调用。</p>
<p>DBImpl::GetImpl</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// db_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">DBImpl::GetImpl</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; read_options, <span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                       GetImplOptions&amp; get_impl_options)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(get_impl_options.value != <span class="literal">nullptr</span> ||</span><br><span class="line">         get_impl_options.merge_operands != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span>(get_impl_options.column_family);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read_options.timestamp) &#123;</span><br><span class="line">    <span class="keyword">const</span> Status s = <span class="built_in">FailIfTsMismatchCf</span>(get_impl_options.column_family,</span><br><span class="line">                                        *(read_options.timestamp),</span><br><span class="line">                                        <span class="comment">/*ts_for_read=*/</span><span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> Status s = <span class="built_in">FailIfCfHasTs</span>(get_impl_options.column_family);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Acquire SuperVersion</span></span><br><span class="line">  SuperVersion* sv = <span class="built_in">GetAndRefSuperVersion</span>(cfd);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//略</span></span><br><span class="line">  <span class="keyword">if</span> (!skip_memtable) &#123;</span><br><span class="line">    <span class="comment">// Get value associated with key</span></span><br><span class="line">    <span class="keyword">if</span> (get_impl_options.get_value) &#123;</span><br><span class="line">      <span class="comment">// ① 从内存的MemTable读取</span></span><br><span class="line">      <span class="keyword">if</span> (sv-&gt;mem-&gt;<span class="built_in">Get</span>(lkey, get_impl_options.value-&gt;<span class="built_in">GetSelf</span>(), timestamp, &amp;s,</span><br><span class="line">                       &amp;merge_context, &amp;max_covering_tombstone_seq,</span><br><span class="line">                       read_options, get_impl_options.callback,</span><br><span class="line">                       get_impl_options.is_blob_index)) &#123;</span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        get_impl_options.value-&gt;<span class="built_in">PinSelf</span>();</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((s.<span class="built_in">ok</span>() || s.<span class="built_in">IsMergeInProgress</span>()) &amp;&amp;</span><br><span class="line">                 sv-&gt;imm-&gt;<span class="built_in">Get</span>(lkey, get_impl_options.value-&gt;<span class="built_in">GetSelf</span>(),</span><br><span class="line">                              timestamp, &amp;s, &amp;merge_context,</span><br><span class="line">                              &amp;max_covering_tombstone_seq, read_options,</span><br><span class="line">                              get_impl_options.callback,</span><br><span class="line">                              get_impl_options.is_blob_index)) &#123; <span class="comment">// ② 从 内存中的 Immutable MemTable读取</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        get_impl_options.value-&gt;<span class="built_in">PinSelf</span>();</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Get Merge Operands associated with key, Merge Operands should not be</span></span><br><span class="line">      <span class="comment">// merged and raw values should be returned to the user.</span></span><br><span class="line">      <span class="keyword">if</span> (sv-&gt;mem-&gt;<span class="built_in">Get</span>(lkey, <span class="comment">/*value*/</span> <span class="literal">nullptr</span>, <span class="comment">/*timestamp=*/</span><span class="literal">nullptr</span>, &amp;s,</span><br><span class="line">                       &amp;merge_context, &amp;max_covering_tombstone_seq,</span><br><span class="line">                       read_options, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">false</span>)) &#123;  <span class="comment">// ① 从内存的MemTable读取</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((s.<span class="built_in">ok</span>() || s.<span class="built_in">IsMergeInProgress</span>()) &amp;&amp;</span><br><span class="line">                 sv-&gt;imm-&gt;<span class="built_in">GetMergeOperands</span>(lkey, &amp;s, &amp;merge_context,</span><br><span class="line">                                           &amp;max_covering_tombstone_seq,</span><br><span class="line">                                           read_options)) &#123; <span class="comment">// ② 从 内存中的 Immutable MemTable读取</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!done &amp;&amp; !s.<span class="built_in">ok</span>() &amp;&amp; !s.<span class="built_in">IsMergeInProgress</span>()) &#123;</span><br><span class="line">      <span class="built_in">ReturnAndCleanupSuperVersion</span>(cfd, sv);</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT</span>(<span class="string">&quot;DBImpl::GetImpl:PostMemTableGet:0&quot;</span>);</span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT</span>(<span class="string">&quot;DBImpl::GetImpl:PostMemTableGet:1&quot;</span>);</span><br><span class="line">  PinnedIteratorsManager pinned_iters_mgr;</span><br><span class="line">  <span class="keyword">if</span> (!done) &#123; <span class="comment">//均没读取数据</span></span><br><span class="line">    <span class="built_in">PERF_TIMER_GUARD</span>(get_from_output_files_time);</span><br><span class="line">    <span class="comment">// ③ 从SST文件读取</span></span><br><span class="line">    sv-&gt;current-&gt;<span class="built_in">Get</span>(</span><br><span class="line">      read_options, lkey, get_impl_options.value, timestamp, &amp;s,</span><br><span class="line">      &amp;merge_context, &amp;max_covering_tombstone_seq, &amp;pinned_iters_mgr,</span><br><span class="line">      get_impl_options.get_value ? get_impl_options.value_found : <span class="literal">nullptr</span>,</span><br><span class="line">      <span class="literal">nullptr</span>, <span class="literal">nullptr</span>,</span><br><span class="line">      get_impl_options.get_value ? get_impl_options.callback : <span class="literal">nullptr</span>,</span><br><span class="line">      get_impl_options.get_value ? get_impl_options.is_blob_index : <span class="literal">nullptr</span>,</span><br><span class="line">      get_impl_options.get_value);</span><br><span class="line">    <span class="built_in">RecordTick</span>(stats_, MEMTABLE_MISS);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//略</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读取顺序：MemTable -&gt; MemTableListVersion -&gt; Version</p>
<p>MemTable::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memtable.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MemTable::Get</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; key, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                   std::string* timestamp, Status* s,</span></span></span><br><span class="line"><span class="params"><span class="function">                   MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                   SequenceNumber* max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                   SequenceNumber* seq, <span class="keyword">const</span> ReadOptions&amp; read_opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                   ReadCallback* callback, <span class="keyword">bool</span>* is_blob_index, <span class="keyword">bool</span> do_merge)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The sequence number is updated synchronously in version_set.h</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">    <span class="comment">// Avoiding recording stats for speed.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">PERF_TIMER_GUARD</span>(get_from_memtable_time);</span><br><span class="line"></span><br><span class="line">  <span class="function">std::unique_ptr&lt;FragmentedRangeTombstoneIterator&gt; <span class="title">range_del_iter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    NewRangeTombstoneIterator(read_opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                              GetInternalKeySeqno(key.internal_key())))</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (range_del_iter != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *max_covering_tombstone_seq =</span><br><span class="line">      std::<span class="built_in">max</span>(*max_covering_tombstone_seq,</span><br><span class="line">               range_del_iter-&gt;<span class="built_in">MaxCoveringTombstoneSeqnum</span>(key.<span class="built_in">user_key</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> found_final_value = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> merge_in_progress = s-&gt;<span class="built_in">IsMergeInProgress</span>();</span><br><span class="line">  <span class="keyword">bool</span> may_contain = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">size_t</span> ts_sz = <span class="built_in">GetInternalKeyComparator</span>().<span class="built_in">user_comparator</span>()-&gt;<span class="built_in">timestamp_size</span>();</span><br><span class="line">  Slice user_key_without_ts = <span class="built_in">StripTimestampFromUserKey</span>(key.<span class="built_in">user_key</span>(), ts_sz);</span><br><span class="line">  <span class="keyword">bool</span> bloom_checked = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (bloom_filter_) &#123; <span class="comment">//布隆过滤器</span></span><br><span class="line">    <span class="comment">// when both memtable_whole_key_filtering and prefix_extractor_ are set,</span></span><br><span class="line">    <span class="comment">// only do whole key filtering for Get() to save CPU</span></span><br><span class="line">    <span class="keyword">if</span> (moptions_.memtable_whole_key_filtering) &#123;</span><br><span class="line">      may_contain = bloom_filter_-&gt;<span class="built_in">MayContain</span>(user_key_without_ts);</span><br><span class="line">      bloom_checked = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">assert</span>(prefix_extractor_);</span><br><span class="line">      <span class="keyword">if</span> (prefix_extractor_-&gt;<span class="built_in">InDomain</span>(user_key_without_ts)) &#123;</span><br><span class="line">        may_contain = bloom_filter_-&gt;<span class="built_in">MayContain</span>(</span><br><span class="line">          prefix_extractor_-&gt;<span class="built_in">Transform</span>(user_key_without_ts));</span><br><span class="line">        bloom_checked = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bloom_filter_ &amp;&amp; !may_contain) &#123;</span><br><span class="line">    <span class="comment">// iter is null if prefix bloom says the key does not exist</span></span><br><span class="line">    <span class="built_in">PERF_COUNTER_ADD</span>(bloom_memtable_miss_count, <span class="number">1</span>);</span><br><span class="line">    *seq = kMaxSequenceNumber;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (bloom_checked) &#123;</span><br><span class="line">      <span class="built_in">PERF_COUNTER_ADD</span>(bloom_memtable_hit_count, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">GetFromTable</span>(key, *max_covering_tombstone_seq, do_merge, callback,</span><br><span class="line">                 is_blob_index, value, timestamp, s, merge_context, seq,</span><br><span class="line">                 &amp;found_final_value, &amp;merge_in_progress); <span class="comment">//真正查找</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// No change to value, since we have not yet found a Put/Delete</span></span><br><span class="line">  <span class="keyword">if</span> (!found_final_value &amp;&amp; merge_in_progress) &#123;</span><br><span class="line">    *s = Status::<span class="built_in">MergeInProgress</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">PERF_COUNTER_ADD</span>(get_from_memtable_count, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> found_final_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MemTable::GetFromTable</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                            SequenceNumber max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span> do_merge, ReadCallback* callback,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span>* is_blob_index, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                            std::string* timestamp, Status* s,</span></span></span><br><span class="line"><span class="params"><span class="function">                            MergeContext* merge_context, SequenceNumber* seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span>* found_final_value, <span class="keyword">bool</span>* merge_in_progress)</span> </span>&#123;</span><br><span class="line">  Saver saver;</span><br><span class="line">  saver.status = s;</span><br><span class="line">  saver.found_final_value = found_final_value;</span><br><span class="line">  saver.merge_in_progress = merge_in_progress;</span><br><span class="line">  saver.key = &amp;key;</span><br><span class="line">  saver.value = value;</span><br><span class="line">  saver.timestamp = timestamp;</span><br><span class="line">  saver.seq = kMaxSequenceNumber;</span><br><span class="line">  saver.mem = <span class="keyword">this</span>;</span><br><span class="line">  saver.merge_context = merge_context;</span><br><span class="line">  saver.max_covering_tombstone_seq = max_covering_tombstone_seq;</span><br><span class="line">  saver.merge_operator = moptions_.merge_operator;</span><br><span class="line">  saver.logger = moptions_.info_log;</span><br><span class="line">  saver.inplace_update_support = moptions_.inplace_update_support;</span><br><span class="line">  saver.statistics = moptions_.statistics;</span><br><span class="line">  saver.clock = clock_;</span><br><span class="line">  saver.callback_ = callback;</span><br><span class="line">  saver.is_blob_index = is_blob_index;</span><br><span class="line">  saver.do_merge = do_merge;</span><br><span class="line">  saver.allow_data_in_errors = moptions_.allow_data_in_errors;</span><br><span class="line">  table_-&gt;<span class="built_in">Get</span>(key, &amp;saver, SaveValue); <span class="comment">//查找方法</span></span><br><span class="line">  *seq = saver.seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MemTableRep::Get</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; k, <span class="keyword">void</span>* callback_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">bool</span> (*callback_func)(<span class="keyword">void</span>* arg, <span class="keyword">const</span> <span class="keyword">char</span>* entry))</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> iter = <span class="built_in">GetDynamicPrefixIterator</span>(); <span class="comment">//使用skiplist跳表查找</span></span><br><span class="line">  <span class="keyword">for</span> (iter-&gt;<span class="built_in">Seek</span>(k.<span class="built_in">internal_key</span>(), k.<span class="built_in">memtable_key</span>().<span class="built_in">data</span>());</span><br><span class="line">       iter-&gt;<span class="built_in">Valid</span>() &amp;&amp; <span class="built_in">callback_func</span>(callback_args, iter-&gt;<span class="built_in">key</span>());</span><br><span class="line">       iter-&gt;<span class="built_in">Next</span>()) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// skiplistrep.cc </span></span><br><span class="line"><span class="function">MemTableRep::Iterator* <span class="title">GetIterator</span><span class="params">(Arena* arena = <span class="literal">nullptr</span>)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (lookahead_ &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">void</span> *mem =</span><br><span class="line">      arena ? arena-&gt;<span class="built_in">AllocateAligned</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::LookaheadIterator))</span><br><span class="line">      : <span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::LookaheadIterator));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in"><span class="keyword">new</span></span> (mem) SkipListRep::<span class="built_in">LookaheadIterator</span>(*<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> *mem =</span><br><span class="line">      arena ? arena-&gt;<span class="built_in">AllocateAligned</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::Iterator))</span><br><span class="line">      : <span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::Iterator));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in"><span class="keyword">new</span></span> (mem) SkipListRep::<span class="built_in">Iterator</span>(&amp;skip_list_);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MemTableListVersion::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memtable_list.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Search all the memtables starting from the most recent one.</span></span><br><span class="line"><span class="comment">// Return the most recent value found, if any.</span></span><br><span class="line"><span class="comment">// Operands stores the list of merge operations to apply, so far.</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MemTableListVersion::Get</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; key, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                              std::string* timestamp, Status* s,</span></span></span><br><span class="line"><span class="params"><span class="function">                              MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                              SequenceNumber* max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                              SequenceNumber* seq, <span class="keyword">const</span> ReadOptions&amp; read_opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ReadCallback* callback, <span class="keyword">bool</span>* is_blob_index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">GetFromList</span>(&amp;memlist_, key, value, timestamp, s, merge_context,</span><br><span class="line">                     max_covering_tombstone_seq, seq, read_opts, callback,</span><br><span class="line">                     is_blob_index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MemTableListVersion::GetFromList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  std::list&lt;MemTable*&gt;* list, <span class="keyword">const</span> LookupKey&amp; key, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::string* timestamp, Status* s, MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">  SequenceNumber* max_covering_tombstone_seq, SequenceNumber* seq,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> ReadOptions&amp; read_opts, ReadCallback* callback, <span class="keyword">bool</span>* is_blob_index)</span> </span>&#123;</span><br><span class="line">  *seq = kMaxSequenceNumber;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; memtable : *list) &#123;</span><br><span class="line">    SequenceNumber current_seq = kMaxSequenceNumber;</span><br><span class="line">    <span class="comment">//调用memtable的Get方法</span></span><br><span class="line">    <span class="keyword">bool</span> done = memtable-&gt;<span class="built_in">Get</span>(key, value, timestamp, s, merge_context,</span><br><span class="line">                              max_covering_tombstone_seq, &amp;current_seq,</span><br><span class="line">                              read_opts, callback, is_blob_index);</span><br><span class="line">    <span class="keyword">if</span> (*seq == kMaxSequenceNumber) &#123;</span><br><span class="line">      <span class="comment">// Store the most recent sequence number of any operation on this key.</span></span><br><span class="line">      <span class="comment">// Since we only care about the most recent change, we only need to</span></span><br><span class="line">      <span class="comment">// return the first operation found when searching memtables in</span></span><br><span class="line">      <span class="comment">// reverse-chronological order.</span></span><br><span class="line">      <span class="comment">// current_seq would be equal to kMaxSequenceNumber if the value was to be</span></span><br><span class="line">      <span class="comment">// skipped. This allows seq to be assigned again when the next value is</span></span><br><span class="line">      <span class="comment">// read.</span></span><br><span class="line">      *seq = current_seq;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">      <span class="built_in">assert</span>(*seq != kMaxSequenceNumber || s-&gt;<span class="built_in">IsNotFound</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!done &amp;&amp; !s-&gt;<span class="built_in">ok</span>() &amp;&amp; !s-&gt;<span class="built_in">IsMergeInProgress</span>() &amp;&amp; !s-&gt;<span class="built_in">IsNotFound</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MemTableListVersion 用链表的形式保存了所有 Immutable memtable 的结构，查找时，按时间序依次查找于每一个 memtable，如果任何一个 memtable 查找到结果则立即返回，即返回最新的返回值。具体 memtable 查找见上述 MemTable::Get 接口。</p>
<p>Version::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// version_set.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Version::Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; read_options, <span class="keyword">const</span> LookupKey&amp; k,</span></span></span><br><span class="line"><span class="params"><span class="function">                  PinnableSlice* value, std::string* timestamp, Status* status,</span></span></span><br><span class="line"><span class="params"><span class="function">                  MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                  SequenceNumber* max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                  PinnedIteratorsManager* pinned_iters_mgr, <span class="keyword">bool</span>* value_found,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">bool</span>* key_exists, SequenceNumber* seq, ReadCallback* callback,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">bool</span>* is_blob, <span class="keyword">bool</span> do_merge)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//fd文件描述符</span></span><br><span class="line">  <span class="function">FilePicker <span class="title">fp</span><span class="params">(user_key, ikey, &amp;storage_info_.level_files_brief_,</span></span></span><br><span class="line"><span class="params"><span class="function">                storage_info_.num_non_empty_levels_,</span></span></span><br><span class="line"><span class="params"><span class="function">                &amp;storage_info_.file_indexer_, user_comparator(),</span></span></span><br><span class="line"><span class="params"><span class="function">                internal_comparator())</span></span>;</span><br><span class="line">  FdWithKeyRange* f = fp.<span class="built_in">GetNextFile</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (f != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    *status = table_cache_-&gt;<span class="built_in">Get</span>(</span><br><span class="line">      read_options, *<span class="built_in">internal_comparator</span>(), *f-&gt;file_metadata, ikey,</span><br><span class="line">      &amp;get_context, mutable_cf_options_.prefix_extractor,</span><br><span class="line">      cfd_-&gt;<span class="built_in">internal_stats</span>()-&gt;<span class="built_in">GetFileReadHist</span>(fp.<span class="built_in">GetHitFileLevel</span>()),</span><br><span class="line">      <span class="built_in">IsFilterSkipped</span>(<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(fp.<span class="built_in">GetHitFileLevel</span>()),</span><br><span class="line">                      fp.<span class="built_in">IsHitFileLastInLevel</span>()),</span><br><span class="line">      fp.<span class="built_in">GetHitFileLevel</span>(), max_file_size_for_l0_meta_pin_);</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    f = fp.<span class="built_in">GetNextFile</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>GetNextFile 函数会遍历所有的 level，然后再遍历每个 level 的所有的文件，这里会对 level 0 的文件做一个特殊处理，这是因为只有 level 0 的 SST 的 range 不是有序的，因此我们每次查找需要查找所有的文件，也就是会一个个的遍历；而在非 level 0，我们只需要按照二分查找来得到对应的文件即可，如果二分查找不存在，那么我就需要进入下一个 level 进行查找。</p>
<p>调用 TableCache::Get 遍历单个 SST 文件，如果查找到结果立即返回。</p>
<p>TableCache::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// table_cache.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">TableCache::Get</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> ReadOptions&amp; options,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> InternalKeyComparator&amp; internal_comparator,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> FileMetaData&amp; file_meta, <span class="keyword">const</span> Slice&amp; k, GetContext* get_context,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> std::shared_ptr&lt;<span class="keyword">const</span> SliceTransform&gt;&amp; prefix_extractor,</span></span></span><br><span class="line"><span class="params"><span class="function">  HistogramImpl* file_read_hist, <span class="keyword">bool</span> skip_filters, <span class="keyword">int</span> level,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">size_t</span> max_file_size_for_l0_meta_pin)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span>&amp; fd = file_meta.fd;</span><br><span class="line">  std::string* row_cache_entry = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">bool</span> done = <span class="literal">false</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> ROCKSDB_LITE</span></span><br><span class="line">  IterKey row_cache_key;</span><br><span class="line">  std::string row_cache_entry_buffer;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check row cache if enabled. Since row cache does not currently store</span></span><br><span class="line">  <span class="comment">// sequence numbers, we cannot use it if we need to fetch the sequence.</span></span><br><span class="line">  <span class="keyword">if</span> (ioptions_.row_cache &amp;&amp; !get_context-&gt;<span class="built_in">NeedToReadSequence</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> user_key = <span class="built_in">ExtractUserKey</span>(k);</span><br><span class="line">    <span class="built_in">CreateRowCacheKeyPrefix</span>(options, fd, k, get_context, row_cache_key);</span><br><span class="line">    done = <span class="built_in">GetFromRowCache</span>(user_key, row_cache_key, row_cache_key.<span class="built_in">Size</span>(),</span><br><span class="line">                           get_context);</span><br><span class="line">    <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">      row_cache_entry = &amp;row_cache_entry_buffer;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// ROCKSDB_LITE</span></span></span><br><span class="line">  Status s;</span><br><span class="line">  TableReader* t = fd.table_reader;</span><br><span class="line">  Cache::Handle* handle = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">    <span class="built_in">assert</span>(s.<span class="built_in">ok</span>());</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="comment">//先从缓存中读取</span></span><br><span class="line">      s = <span class="built_in">FindTable</span>(options, file_options_, internal_comparator, fd, &amp;handle,</span><br><span class="line">                    prefix_extractor,</span><br><span class="line">                    options.read_tier == kBlockCacheTier <span class="comment">/* no_io */</span>,</span><br><span class="line">                    <span class="literal">true</span> <span class="comment">/* record_read_stats */</span>, file_read_hist, skip_filters,</span><br><span class="line">                    level, <span class="literal">true</span> <span class="comment">/* prefetch_index_and_filter_in_cache */</span>,</span><br><span class="line">                    max_file_size_for_l0_meta_pin, file_meta.temperature);</span><br><span class="line">      <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        t = <span class="built_in">GetTableReaderFromHandle</span>(handle);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SequenceNumber* max_covering_tombstone_seq =</span><br><span class="line">      get_context-&gt;<span class="built_in">max_covering_tombstone_seq</span>();</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">ok</span>() &amp;&amp; max_covering_tombstone_seq != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">        !options.ignore_range_deletions) &#123;</span><br><span class="line">      <span class="function">std::unique_ptr&lt;FragmentedRangeTombstoneIterator&gt; <span class="title">range_del_iter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        t-&gt;NewRangeTombstoneIterator(options))</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (range_del_iter != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        *max_covering_tombstone_seq = std::<span class="built_in">max</span>(</span><br><span class="line">          *max_covering_tombstone_seq,</span><br><span class="line">          range_del_iter-&gt;<span class="built_in">MaxCoveringTombstoneSeqnum</span>(<span class="built_in">ExtractUserKey</span>(k)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      get_context-&gt;<span class="built_in">SetReplayLog</span>(row_cache_entry);  <span class="comment">// nullptr if no cache.</span></span><br><span class="line">      s = t-&gt;<span class="built_in">Get</span>(options, k, get_context, prefix_extractor.<span class="built_in">get</span>(), skip_filters); <span class="comment">//从BlockBasedTable读取，即单个sst文件</span></span><br><span class="line">      get_context-&gt;<span class="built_in">SetReplayLog</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.read_tier == kBlockCacheTier &amp;&amp; s.<span class="built_in">IsIncomplete</span>()) &#123;</span><br><span class="line">      <span class="comment">// Couldn&#x27;t find Table in cache but treat as kFound if no_io set</span></span><br><span class="line">      get_context-&gt;<span class="built_in">MarkKeyMayExist</span>();</span><br><span class="line">      s = Status::<span class="built_in">OK</span>();</span><br><span class="line">      done = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifndef</span> ROCKSDB_LITE</span></span><br><span class="line">  <span class="comment">// Put the replay log in row cache only if something was found.</span></span><br><span class="line">  <span class="keyword">if</span> (!done &amp;&amp; s.<span class="built_in">ok</span>() &amp;&amp; row_cache_entry &amp;&amp; !row_cache_entry-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> charge = row_cache_entry-&gt;<span class="built_in">capacity</span>() + <span class="built_in"><span class="keyword">sizeof</span></span>(std::string);</span><br><span class="line">    <span class="keyword">void</span>* row_ptr = <span class="keyword">new</span> std::<span class="built_in">string</span>(std::<span class="built_in">move</span>(*row_cache_entry));</span><br><span class="line">    <span class="comment">// If row cache is full, it&#x27;s OK to continue.</span></span><br><span class="line">    ioptions_.row_cache</span><br><span class="line">      -&gt;<span class="built_in">Insert</span>(row_cache_key.<span class="built_in">GetUserKey</span>(), row_ptr, charge,</span><br><span class="line">               &amp;DeleteEntry&lt;std::string&gt;)</span><br><span class="line">      .<span class="built_in">PermitUncheckedError</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// ROCKSDB_LITE</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">ReleaseHandle</span>(handle);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">TableCache::FindTable</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> ReadOptions&amp; ro, <span class="keyword">const</span> FileOptions&amp; file_options,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> InternalKeyComparator&amp; internal_comparator, <span class="keyword">const</span> FileDescriptor&amp; fd,</span></span></span><br><span class="line"><span class="params"><span class="function">  Cache::Handle** handle,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> std::shared_ptr&lt;<span class="keyword">const</span> SliceTransform&gt;&amp; prefix_extractor,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> <span class="keyword">bool</span> no_io, <span class="keyword">bool</span> record_read_stats, HistogramImpl* file_read_hist,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">bool</span> skip_filters, <span class="keyword">int</span> level, <span class="keyword">bool</span> prefetch_index_and_filter_in_cache,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">size_t</span> max_file_size_for_l0_meta_pin, Temperature file_temperature)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">PERF_TIMER_GUARD_WITH_CLOCK</span>(find_table_nanos, ioptions_.clock);</span><br><span class="line">  <span class="keyword">uint64_t</span> number = fd.<span class="built_in">GetNumber</span>();</span><br><span class="line">  Slice key = <span class="built_in">GetSliceForFileNumber</span>(&amp;number);</span><br><span class="line">  *handle = cache_-&gt;<span class="built_in">Lookup</span>(key); <span class="comment">//从缓存中读取</span></span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT_CALLBACK</span>(<span class="string">&quot;TableCache::FindTable:0&quot;</span>,</span><br><span class="line">                           <span class="keyword">const_cast</span>&lt;<span class="keyword">bool</span>*&gt;(&amp;no_io));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (*handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (no_io) &#123;</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">Incomplete</span>(<span class="string">&quot;Table not found in table_cache, no_io is set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">MutexLock <span class="title">load_lock</span><span class="params">(loader_mutex_.get(key))</span></span>;</span><br><span class="line">    <span class="comment">// We check the cache again under loading mutex</span></span><br><span class="line">    *handle = cache_-&gt;<span class="built_in">Lookup</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (*handle != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;TableReader&gt; table_reader;</span><br><span class="line">    <span class="comment">//真实读取，从磁盘读取</span></span><br><span class="line">    Status s = <span class="built_in">GetTableReader</span>(</span><br><span class="line">      ro, file_options, internal_comparator, fd, <span class="literal">false</span> <span class="comment">/* sequential mode */</span>,</span><br><span class="line">      record_read_stats, file_read_hist, &amp;table_reader, prefix_extractor,</span><br><span class="line">      skip_filters, level, prefetch_index_and_filter_in_cache,</span><br><span class="line">      max_file_size_for_l0_meta_pin, file_temperature);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="built_in">assert</span>(table_reader == <span class="literal">nullptr</span>);</span><br><span class="line">      <span class="built_in">RecordTick</span>(ioptions_.stats, NO_FILE_ERRORS);</span><br><span class="line">      <span class="comment">// We do not cache error results so that if the error is transient,</span></span><br><span class="line">      <span class="comment">// or somebody repairs the file, we recover automatically.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//插入缓存</span></span><br><span class="line">      s = cache_-&gt;<span class="built_in">Insert</span>(key, table_reader.<span class="built_in">get</span>(), <span class="number">1</span>, &amp;DeleteEntry&lt;TableReader&gt;,</span><br><span class="line">                         handle);</span><br><span class="line">      <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="comment">// Release ownership of table reader.</span></span><br><span class="line">        table_reader.<span class="built_in">release</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BlockBasedTable::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// block_based_table_reader.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">BlockBasedTable::Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; read_options, <span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                            GetContext* get_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">const</span> SliceTransform* prefix_extractor,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span> skip_filters)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> may_match = <span class="built_in">FullFilterKeyMayMatch</span>(</span><br><span class="line">    filter, key, no_io, prefix_extractor, get_context, &amp;lookup_context,</span><br><span class="line">    read_options.rate_limiter_priority); <span class="comment">//数据块Index，稀疏索引查找</span></span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT</span>(<span class="string">&quot;BlockBasedTable::Get:AfterFilterMatch&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!may_match) &#123;</span><br><span class="line">    <span class="built_in">RecordTick</span>(rep_-&gt;ioptions.stats, BLOOM_FILTER_USEFUL);</span><br><span class="line">    <span class="built_in">PERF_COUNTER_BY_LEVEL_ADD</span>(bloom_filter_useful, <span class="number">1</span>, rep_-&gt;level); </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">//命中</span></span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">    <span class="comment">//遍历，循环查找</span></span><br><span class="line">    <span class="keyword">for</span> (iiter-&gt;<span class="built_in">Seek</span>(key); iiter-&gt;<span class="built_in">Valid</span>() &amp;&amp; !done; iiter-&gt;<span class="built_in">Next</span>()) &#123;</span><br><span class="line">      IndexValue v = iiter-&gt;<span class="built_in">value</span>();</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">      NewDataBlockIterator&lt;DataBlockIter&gt;(</span><br><span class="line">        read_options, v.handle, &amp;biter, BlockType::kData, get_context,</span><br><span class="line">        &amp;lookup_data_block_context, <span class="comment">/*prefetch_buffer=*/</span><span class="literal">nullptr</span>,</span><br><span class="line">        <span class="comment">/*for_compaction=*/</span><span class="literal">false</span>, <span class="comment">/*async_read=*/</span><span class="literal">false</span>, tmp_status);</span><br><span class="line">      <span class="comment">//no_io，命中内存</span></span><br><span class="line">      <span class="keyword">if</span> (no_io &amp;&amp; biter.<span class="built_in">status</span>().<span class="built_in">IsIncomplete</span>()) &#123;</span><br><span class="line">        <span class="comment">// couldn&#x27;t get block from block_cache</span></span><br><span class="line">        <span class="comment">// Update Saver.state to Found because we are only looking for</span></span><br><span class="line">        <span class="comment">// whether we can guarantee the key is not there when &quot;no_io&quot; is set</span></span><br><span class="line">        get_context-&gt;<span class="built_in">MarkKeyMayExist</span>();</span><br><span class="line">        s = biter.<span class="built_in">status</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!biter.<span class="built_in">status</span>().<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        s = biter.<span class="built_in">status</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">bool</span> may_exist = biter.<span class="built_in">SeekForGet</span>(key);</span><br><span class="line">      <span class="comment">// If user-specified timestamp is supported, we cannot end the search</span></span><br><span class="line">      <span class="comment">// just because hash index lookup indicates the key+ts does not exist.</span></span><br><span class="line">      <span class="keyword">if</span> (!may_exist &amp;&amp; ts_sz == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// HashSeek cannot find the key this block and the the iter is not</span></span><br><span class="line">        <span class="comment">// the end of the block, i.e. cannot be in the following blocks</span></span><br><span class="line">        <span class="comment">// either. In this case, the seek_key cannot be found, so we break</span></span><br><span class="line">        <span class="comment">// from the top level for-loop.</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Call the *saver function on each entry/block until it returns false</span></span><br><span class="line">        <span class="keyword">for</span> (; biter.<span class="built_in">Valid</span>(); biter.<span class="built_in">Next</span>()) &#123;</span><br><span class="line">          ParsedInternalKey parsed_key;</span><br><span class="line">          Status pik_status = <span class="built_in">ParseInternalKey</span>(</span><br><span class="line">            biter.<span class="built_in">key</span>(), &amp;parsed_key, <span class="literal">false</span> <span class="comment">/* log_err_key */</span>);  <span class="comment">// TODO</span></span><br><span class="line">          <span class="keyword">if</span> (!pik_status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">            s = pik_status;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//从硬盘的SST文件读取</span></span><br><span class="line">          <span class="keyword">if</span> (!get_context-&gt;<span class="built_in">SaveValue</span>(</span><br><span class="line">            parsed_key, biter.<span class="built_in">value</span>(), &amp;matched,</span><br><span class="line">            biter.<span class="built_in">IsValuePinned</span>() ? &amp;biter : <span class="literal">nullptr</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (get_context-&gt;<span class="built_in">State</span>() == GetContext::GetState::kFound) &#123;</span><br><span class="line">              does_referenced_key_exist = <span class="literal">true</span>;</span><br><span class="line">              referenced_data_size = biter.<span class="built_in">key</span>().<span class="built_in">size</span>() + biter.<span class="built_in">value</span>().<span class="built_in">size</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            done = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        s = biter.<span class="built_in">status</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>BlockBasedTable是 RocksDB中默认的 SST table的格式。 </p>
<p><strong>File format</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;beginning_of_file&gt;</span><br><span class="line">[data block 1]</span><br><span class="line">[data block 2]</span><br><span class="line">...</span><br><span class="line">[data block N]</span><br><span class="line">[meta block 1: filter block]                  (see section: &quot;filter&quot; Meta Block)</span><br><span class="line">[meta block 2: index block]</span><br><span class="line">[meta block 3: compression dictionary block]  (see section: &quot;compression dictionary&quot; Meta Block)</span><br><span class="line">[meta block 4: range deletion block]          (see section: &quot;range deletion&quot; Meta Block)</span><br><span class="line">[meta block 5: stats block]                   (see section: &quot;properties&quot; Meta Block)</span><br><span class="line">...</span><br><span class="line">[meta block K: future extended block]  (we may add more meta blocks in the future)</span><br><span class="line">[metaindex block]</span><br><span class="line">[Footer]                               (fixed size; starts at file_size - sizeof(Footer))</span><br><span class="line">&lt;end_of_file&gt;</span><br></pre></td></tr></table></figure>

<p>总结</p>
<p>Rocksdb 的Get 读取数据会不可避免的带来读放大（Read Amplification)。Rocksdb 的读操作需要从新到旧（从上到下）一层一层查找，直到找到想要的数据。这个过程可能需要不止一次 I/O。从level0 开始，潜在的可能会造成I/O，对于level1及以下的层级，最差情况每一层都定位到一个sst 文件，进行一次潜在I/O。这样会造成大量的读放大。所幸，引进了bloom filter减少了可能的读盘次数。另外，引入缓存优化措施，Rocksdb在各个阶段，实现了不同的缓存。</p>
<p><img src="https://raw.githubusercontent.com/barryzhanhao/imgs/main/2023-07-03-034514.jpg" alt="e6c9d24egy1h4v74kceuxj20t40xzmze"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.sofastack.tech/blog/sofa-jraft-algorithm-storage-module-deep-dive/">https://www.sofastack.tech/blog/sofa-jraft-algorithm-storage-module-deep-dive/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/426053729">https://zhuanlan.zhihu.com/p/426053729</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/">https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree">https://en.wikipedia.org/wiki/Log-structured_merge-tree</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/">https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/</a></p>
<p><a target="_blank" rel="noopener" href="https://yetanotherdevblog.com/lsm/">https://yetanotherdevblog.com/lsm/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.iggiewang.cn/2021/01/17/Rocksdb-Get/">https://www.iggiewang.cn/2021/01/17/Rocksdb-Get/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zhan Hao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhan Hao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
