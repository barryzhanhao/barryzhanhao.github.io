<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="LogStorage其他实现分析上篇SOFAJRaft日志存储分析（二）中，着重分析了LogStorage的默认实现RocksDBLogStorage，还剩其他实现： 1234com.alipay.sofa.jraft.storage.impl.BDBLogStoragecom.alipay.sofa.jraft.storage.HybridLogStoragecom.alipay.sofa.jr">
<meta property="og:type" content="article">
<meta property="og:title" content="SOFAJRaft日志存储分析（三）">
<meta property="og:url" content="http://example.com/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/index.html">
<meta property="og:site_name" content="Zhan Hao&#39;s Blogs">
<meta property="og:description" content="LogStorage其他实现分析上篇SOFAJRaft日志存储分析（二）中，着重分析了LogStorage的默认实现RocksDBLogStorage，还剩其他实现： 1234com.alipay.sofa.jraft.storage.impl.BDBLogStoragecom.alipay.sofa.jraft.storage.HybridLogStoragecom.alipay.sofa.jr">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-08-18T07:49:53.000Z">
<meta property="article:modified_time" content="2024-02-27T03:40:32.949Z">
<meta property="article:author" content="Zhan Hao">
<meta property="article:tag" content="SOFAJRaft">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>SOFAJRaft日志存储分析（三） | Zhan Hao's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zhan Hao's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SOFAJRaft日志存储分析（三）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-18 15:49:53" itemprop="dateCreated datePublished" datetime="2022-08-18T15:49:53+08:00">2022-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 11:40:32" itemprop="dateModified" datetime="2024-02-27T11:40:32+08:00">2024-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">日志存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="LogStorage其他实现分析"><a href="#LogStorage其他实现分析" class="headerlink" title="LogStorage其他实现分析"></a>LogStorage其他实现分析</h1><p>上篇<a target="_blank" rel="noopener" href="https://barryzhanhao.github.io/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/">SOFAJRaft日志存储分析（二）</a>中，着重分析了LogStorage的默认实现RocksDBLogStorage，还剩其他实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.impl.BDBLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.HybridLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.LogitLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span><br></pre></td></tr></table></figure>

<h2 id="BDBLogStorage"><a href="#BDBLogStorage" class="headerlink" title="BDBLogStorage"></a>BDBLogStorage</h2><p>BDBLogStorage和RocksDBLogStorage很类似，底层存储都依赖嵌入K-V数据库，BDBLogStorage使用的是oracle的<a target="_blank" rel="noopener" href="https://github.com/berkeleydb">berkeley-db</a>, <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/Berkeley_DB">维基定义</a></p>
<blockquote>
<p><strong>Berkeley DB</strong>（BDB）是一个高效的嵌入式<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%94%AE-%E5%80%BC%E6%95%B0%E6%8D%AE%E5%BA%93">键-值数据库</a>编程库，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%E8%AF%AD%E8%A8%80">C语言</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%2B%2B">C++</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Java">Java</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Perl">Perl</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Python">Python</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Tcl">Tcl</a>以及其他很多语言都有其对应的API。Berkeley DB可以保存任意类型的键/值对（Key/Value Pair），而且可以为一个键保存多个数据。Berkeley DB支持让数千的并发线程同时操作数据库，支持最大256TB的数据，广泛用于各种操作系统，其中包括大多数<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix-like">类Unix</a>操作系统、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Microsoft_Windows">Windows</a>操作系统以及<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%9E%E6%97%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">实时操作系统</a>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BDBLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span>, <span class="title">Describer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG                   = LoggerFactory.getLogger(BDBLogStorage.class);</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> String         DEFAULT_DATABASE_NAME = <span class="string">&quot;jraft-log&quot;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> String         CONF_DATABASE_NAME    = <span class="string">&quot;jraft-conf&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String              groupId;</span><br><span class="line">  <span class="keyword">private</span> Database            defaultTable; <span class="comment">//实际底层存储berkeley-db，com.sleepycat.je.Database</span></span><br><span class="line">  <span class="keyword">private</span> Database            confTable;</span><br><span class="line">  <span class="keyword">private</span> Environment         environment;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String        homePath; <span class="comment">//berkeley-db的目录</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span>             opened                = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> LogEntryEncoder     logEntryEncoder;</span><br><span class="line">  <span class="keyword">private</span> LogEntryDecoder     logEntryDecoder;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock readWriteLock         = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock          readLock              = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock          writeLock             = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span>       sync;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span>       firstLogIndex         = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>    hasLoadFirstLogIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法"><a href="#getEntry读取方法" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DatabaseEntry logEntry = <span class="keyword">new</span> DatabaseEntry();</span><br><span class="line">    OperationStatus operationStatus = <span class="keyword">this</span>.defaultTable.get(<span class="keyword">null</span>, getKeyDatabaseEntry(index), logEntry,</span><br><span class="line">                                                            LockMode.DEFAULT); <span class="comment">//调用berkeley-db的get方法</span></span><br><span class="line">    <span class="keyword">if</span> (isSuccessOperation(operationStatus)) &#123;</span><br><span class="line">      <span class="keyword">return</span> toLogEntry(logEntry);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DatabaseException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125;.&quot;</span>, index, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法"><a href="#appendEntry写入方法" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage   </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  Transaction txn = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    checkState();</span><br><span class="line">    DatabaseEntry key = getKeyDatabaseEntry(entry.getId().getIndex());</span><br><span class="line">    DatabaseEntry value = toDatabaseEntry(entry);</span><br><span class="line">    txn = beginTransaction();</span><br><span class="line">    <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">      <span class="keyword">this</span>.confTable.put(txn, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.defaultTable.put(txn, key, value); <span class="comment">//调用berkeley-db的put方法</span></span><br><span class="line">    txn.commit();</span><br><span class="line">    syncIfNeed();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DatabaseException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to append entry &#123;&#125;.&quot;</span>, entry, e);</span><br><span class="line">    <span class="keyword">if</span> (txn != <span class="keyword">null</span>) &#123;</span><br><span class="line">      txn.abort();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RocksDBSegmentLogStorage"><a href="#RocksDBSegmentLogStorage" class="headerlink" title="RocksDBSegmentLogStorage"></a>RocksDBSegmentLogStorage</h2><p>RocksDBSegmentLogStorage继承默认实现RocksDBLogStorage，在RocksDB的存储能力上，加入文件Segment功能(和LogManager的Segment不是一个概念)，<strong>是为了解决大数据Value写入的问题</strong>。</p>
<p>RocksDBSegmentLogStorage的主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocksDBSegmentLogStorage</span> <span class="keyword">extends</span> <span class="title">RocksDBLogStorage</span> </span>&#123; <span class="comment">//继承 RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>                   valueSizeThreshold; <span class="comment">//Value大小阀值，大于该值，使用Segment文件存储，小于的使用RocksDB直接存储</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                segmentsPath; <span class="comment">//Segment文件存放路径</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CheckpointFile        checkpointFile;</span><br><span class="line">  <span class="comment">// used  or using segments.</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;SegmentFile&gt;           segments; <span class="comment">//Segment文件列表</span></span><br><span class="line">  <span class="comment">// pre-allocated and blank segments.</span></span><br><span class="line">  <span class="keyword">private</span> ArrayDeque&lt;AllocatedResult&gt; blankSegments; <span class="comment">//预分配Segments</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                  allocateLock             = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Condition             fullCond                 = <span class="keyword">this</span>.allocateLock.newCondition();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Condition             emptyCond                = <span class="keyword">this</span>.allocateLock.newCondition();</span><br><span class="line">  <span class="comment">// segment file sequence.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong            nextFileSequence         = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock         readWriteLock            = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                  writeLock                = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                  readLock                 = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> ScheduledExecutorService    checkpointExecutor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AbortFile             abortFile;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor    writeExecutor; <span class="comment">//Segments异步写入线程池</span></span><br><span class="line">  <span class="keyword">private</span> Thread                      segmentAllocator; <span class="comment">//Segment预分配器</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>                   maxSegmentFileSize;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                         preAllocateSegmentCount  = PRE_ALLOCATE_SEGMENT_COUNT; <span class="comment">//Segment预分数量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                         keepInMemorySegmentCount = MEM_SEGMENT_COUNT;<span class="comment">//Segment内存保留数量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                         checkpointIntervalMs     = DEFAULT_CHECKPOINT_INTERVAL_MS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SegmentFile是带缓存的固定格式的文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A fixed size file. The content format is:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   magic bytes       first log index    reserved</span></span><br><span class="line"><span class="comment"> *   [0x20 0x20]      [... 8 bytes...]   [8 bytes]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   [record, record, ...]</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Every record format is:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   Magic bytes     data length   data</span></span><br><span class="line"><span class="comment"> *   [0x57, 0x8A]    [4 bytes]     [bytes]</span></span><br><span class="line"><span class="comment"> *&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentFile</span> <span class="keyword">implements</span> <span class="title">Lifecycle</span>&lt;<span class="title">SegmentFileOptions</span>&gt; </span>&#123;</span><br><span class="line">  * Magic bytes <span class="keyword">for</span> data buffer.</span><br><span class="line">    */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[]       RECORD_MAGIC_BYTES      = <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; (<span class="keyword">byte</span>) <span class="number">0x57</span>, (<span class="keyword">byte</span>) <span class="number">0x8A</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>          RECORD_MAGIC_BYTES_SIZE = RECORD_MAGIC_BYTES.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SegmentHeader      header;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The file last log index(inclusive)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span>            lastLogIndex            = Long.MAX_VALUE;</span><br><span class="line">  <span class="comment">// File size</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>                      size;</span><br><span class="line">  <span class="comment">// File path</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String             path; <span class="comment">//文件path</span></span><br><span class="line">  <span class="comment">// mmap byte buffer.</span></span><br><span class="line">  <span class="keyword">private</span> MappedByteBuffer         buffer; <span class="comment">//缓存</span></span><br><span class="line">  <span class="comment">// Wrote position.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span>             wrotePos; <span class="comment">//游标</span></span><br><span class="line">  <span class="comment">// Committed position</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span>             committedPos;<span class="comment">//游标</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock      readWriteLock           = <span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock               writeLock               = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock               readLock                = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor writeExecutor;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>         swappedOut;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>         readOnly;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span>                     swappedOutTimestamp     = -<span class="number">1L</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String             filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-1"><a href="#appendEntry写入方法-1" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><p>RocksDBSegmentLogStorage继承默认实现RocksDBLogStorage，appendEntry写入方法还是调用的父类RocksDBLogStorage的appendEntry写入方法，只是父类RocksDBLogStorage预留了一些hook钩子方法，RocksDBSegmentLogStorage通过实现这些钩子方法，扩展功能。</p>
<p>RocksDBLogStorage父类，appendEntry写入方法的扩展点，父类中，扩展点，均没实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">    <span class="keyword">return</span> executeBatch(batch -&gt; addConfBatch(entry, batch));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.db == <span class="keyword">null</span>) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;DB not initialized or destroyed in data path: &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> WriteContext writeCtx = newWriteContext(); <span class="comment">//扩展点 写入上下文WriteContext</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] valueBytes = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] newValueBytes = onDataAppend(logIndex, valueBytes, writeCtx); <span class="comment">//扩展点onDataAppend</span></span><br><span class="line">      writeCtx.startJob(); <span class="comment">//扩展点，写入上下文WriteContext生命周期</span></span><br><span class="line">      <span class="keyword">this</span>.db.put(<span class="keyword">this</span>.defaultHandle, <span class="keyword">this</span>.writeOptions, getKeyBytes(logIndex), newValueBytes);</span><br><span class="line">      writeCtx.joinAll();<span class="comment">//扩展点，写入上下文WriteContext生命周期</span></span><br><span class="line">      <span class="keyword">if</span> (newValueBytes != valueBytes) &#123;</span><br><span class="line">        doSync();<span class="comment">// //扩展点，Segment文件刷盘</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Fail to append entry.&quot;</span>, e);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">      Thread.currentThread().interrupt();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以复写protected </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> WriteContext <span class="title">newWriteContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> EmptyWriteContext.INSTANCE; <span class="comment">//空实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据写入，前置方法，可以复写protected </span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataAppend(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value,</span><br><span class="line">                              <span class="keyword">final</span> WriteContext ctx) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">  ctx.finishJob();</span><br><span class="line">  <span class="keyword">return</span> value; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  onSync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//空方法，可以复写protected </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>WriteContext写入上下文，实现写入任务化，异步化，和生命周期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A write context</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WriteContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Start a sub job.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Finish a sub job</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">finishJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Adds a callback that will be invoked after all sub jobs finish.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">addFinishHook</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Set an exception to context.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e exception</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Wait for all sub jobs finish.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">joinAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>子类RocksDBSegmentLogStorage扩展点，实现方式：</p>
<p>首先是BarrierWriteContext，支持多个Job写入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//类似CyclicBarrier </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BarrierWriteContext</span> <span class="keyword">implements</span> <span class="title">WriteContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CountDownEvent    events = <span class="keyword">new</span> CountDownEvent();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> Exception      e;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;Runnable&gt; hooks;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.events.incrementAndGet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addFinishHook</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hooks == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.hooks = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.hooks.add(r);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.events.countDown();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.e = e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">joinAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.events.await();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hooks != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (Runnable r : <span class="keyword">this</span>.hooks) &#123;</span><br><span class="line">        r.run();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.e != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Fail to apppend entries&quot;</span>, <span class="keyword">this</span>.e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//await和notify</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span>             state    = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock      lock     = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Condition busyCond = <span class="keyword">this</span>.lock.newCondition();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> Object attachment;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getAttachment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.attachment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttachment</span><span class="params">(<span class="keyword">final</span> Object attachment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.attachment = attachment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> ++<span class="keyword">this</span>.state;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (--<span class="keyword">this</span>.state == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.busyCond.signalAll();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">this</span>.state &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.busyCond.await();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>扩展方法：onDataAppend</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataAppend(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value, <span class="keyword">final</span> WriteContext ctx) <span class="keyword">throws</span> IOException,                                                                                                InterruptedException &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> waitToWroteBytes = SegmentFile.getWriteBytes(value);</span><br><span class="line">  SegmentFile lastSegmentFile = getLastSegmentFile(logIndex, waitToWroteBytes, <span class="keyword">true</span>, ctx);<span class="comment">//获取Semgent文件</span></span><br><span class="line">  <span class="keyword">if</span> (lastSegmentFile.reachesFileEndBy(waitToWroteBytes)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Too large value size: &quot;</span> + value.length + <span class="string">&quot;, maxSegmentFileSize=&quot;</span></span><br><span class="line">                          + <span class="keyword">this</span>.maxSegmentFileSize);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value.length &lt; <span class="keyword">this</span>.valueSizeThreshold) &#123; <span class="comment">//小value，直接写入Rocksdb</span></span><br><span class="line">    <span class="comment">// Small value will be stored in rocksdb directly.</span></span><br><span class="line">    lastSegmentFile.setLastLogIndex(logIndex);</span><br><span class="line">    ctx.finishJob();<span class="comment">//调用WriteContext上下文的生命周期方法</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// Large value is stored in segment file and returns an encoded location info that will be stored in rocksdb.</span></span><br><span class="line">  <span class="comment">//大Value</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> pos = lastSegmentFile.write(logIndex, value, ctx);<span class="comment">//写入Segment，不是同步写入，后台线程异步写入</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex = lastSegmentFile.getFirstLogIndex();</span><br><span class="line">  <span class="keyword">return</span> encodeLocationMetadata(firstLogIndex, pos); <span class="comment">//返回metadata，不是实际存储的value，实际的value在Segment文件里面</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SegmentFile <span class="title">getLastSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">int</span> waitToWroteSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="keyword">final</span> <span class="keyword">boolean</span> createIfNecessary, <span class="keyword">final</span> WriteContext ctx)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">InterruptedException </span>&#123;</span><br><span class="line">  SegmentFile lastFile = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> segmentCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.segments.isEmpty()) &#123; <span class="comment">//存在Segment文件</span></span><br><span class="line">        segmentCount = <span class="keyword">this</span>.segments.size();</span><br><span class="line">        <span class="keyword">final</span> SegmentFile currLastFile = getLastSegmentWithoutLock();</span><br><span class="line">        <span class="keyword">if</span> (waitToWroteSize &lt;= <span class="number">0</span> || !currLastFile.reachesFileEndBy(waitToWroteSize)) &#123;</span><br><span class="line">          lastFile = currLastFile;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lastFile == <span class="keyword">null</span> &amp;&amp; createIfNecessary) &#123;</span><br><span class="line">      lastFile = createNewSegmentFile(logIndex, segmentCount, ctx); <span class="comment">//不存在，创建</span></span><br><span class="line">      <span class="keyword">if</span> (lastFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> lastFile;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Try again</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lastFile;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SegmentFile <span class="title">createNewSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">int</span> oldSegmentCount,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="keyword">final</span> WriteContext ctx)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">  SegmentFile segmentFile = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// CAS by segments count.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.segments.size() != oldSegmentCount) &#123;</span><br><span class="line">      <span class="keyword">return</span> segmentFile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.segments.isEmpty()) &#123; </span><br><span class="line">      <span class="comment">// Sync current last file and correct it&#x27;s lastLogIndex.</span></span><br><span class="line">      <span class="keyword">final</span> SegmentFile currLastFile = getLastSegmentWithoutLock();</span><br><span class="line">      currLastFile.setLastLogIndex(logIndex - <span class="number">1</span>);</span><br><span class="line">      ctx.startJob();</span><br><span class="line">      <span class="comment">// Attach a finish hook to set last segment file to be read-only.</span></span><br><span class="line">      ctx.addFinishHook(() -&gt; currLastFile.setReadOnly(<span class="keyword">true</span>));</span><br><span class="line">      <span class="comment">// Run sync in parallel</span></span><br><span class="line">      <span class="keyword">this</span>.writeExecutor.execute(() -&gt; &#123; <span class="comment">//异步写入，线程池</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          currLastFile.sync(isSync());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">          ctx.setError(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          ctx.finishJob();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    segmentFile = allocateSegmentFile(logIndex);<span class="comment">//从预分配Semgent读取</span></span><br><span class="line">    <span class="keyword">return</span> segmentFile;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SegmentFile <span class="title">allocateSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.allocateLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>.blankSegments.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emptyCond.await();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> AllocatedResult result = <span class="keyword">this</span>.blankSegments.pollFirst();<span class="comment">//预分配队列</span></span><br><span class="line">    <span class="keyword">if</span> (result.ie != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> result.ie;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.fullCond.signal();</span><br><span class="line">    result.segmentFile.setFirstLogIndex(index);</span><br><span class="line">    <span class="keyword">this</span>.segments.add(result.segmentFile);</span><br><span class="line">    <span class="keyword">return</span> result.segmentFile;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.allocateLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>lastSegmentFile.write，Segment的写方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> WriteContext ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> pos = -<span class="number">1</span>;</span><br><span class="line">  MappedByteBuffer buf = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> (<span class="keyword">this</span>.wrotePos == <span class="keyword">this</span>.buffer.position());</span><br><span class="line">    buf = <span class="keyword">this</span>.buffer;</span><br><span class="line">    pos = <span class="keyword">this</span>.wrotePos;</span><br><span class="line">    <span class="keyword">this</span>.wrotePos += RECORD_MAGIC_BYTES_SIZE + RECORD_DATA_LENGTH_SIZE + data.length;</span><br><span class="line">    <span class="keyword">this</span>.buffer.position(<span class="keyword">this</span>.wrotePos);</span><br><span class="line">    <span class="comment">// Update log index.</span></span><br><span class="line">    <span class="keyword">if</span> (isBlank() || pos == HEADER_SIZE) &#123;</span><br><span class="line">      <span class="keyword">this</span>.header.firstLogIndex = logIndex;</span><br><span class="line">      <span class="comment">// we don&#x27;t need to call fsync header here, the new header will be flushed with this wrote.</span></span><br><span class="line">      saveHeader(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.lastLogIndex = logIndex;</span><br><span class="line">    <span class="keyword">return</span> pos;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> wroteIndex = pos;</span><br><span class="line">    <span class="keyword">final</span> MappedByteBuffer buffer = buf;</span><br><span class="line">    <span class="keyword">this</span>.writeExecutor.execute(() -&gt; &#123; <span class="comment">//线程，异步写入</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        put(buffer, wroteIndex, RECORD_MAGIC_BYTES); <span class="comment">//写入 魔法数字</span></span><br><span class="line">        putInt(buffer, wroteIndex + RECORD_MAGIC_BYTES_SIZE, data.length); <span class="comment">//写入头信息</span></span><br><span class="line">        put(buffer, wroteIndex + RECORD_MAGIC_BYTES_SIZE + RECORD_DATA_LENGTH_SIZE, data);<span class="comment">//写入数据data</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">        ctx.setError(e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ctx.finishJob();<span class="comment">//调用声明写上下文周期方法</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>encodeLocationMetadata方法，生产的metadata信息，才是写入的RocksDB的Value数据，返回父类，会触发newValueBytes != valueBytes条件，会调用刷盘doSync()方法，可能会引起刷盘（需要isSync=true）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line">* <span class="function">Encode segment file <span class="title">firstLogIndex</span><span class="params">(fileName)</span> and position to a <span class="keyword">byte</span> array in the format of:</span></span><br><span class="line"><span class="function">* &lt;ul&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; magic <span class="title">bytes</span><span class="params">(<span class="number">2</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; <span class="title">reserved</span> <span class="params">(<span class="number">2</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; <span class="title">firstLogIndex</span><span class="params">(<span class="number">8</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  *  &lt;li&gt; wrote <span class="title">position</span><span class="params">(<span class="number">4</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function">  * &lt;/ul&gt;</span></span><br><span class="line"><span class="function">  * @param firstLogIndex the first log index</span></span><br><span class="line"><span class="function">  * @param pos           the wrote position</span></span><br><span class="line"><span class="function">  * @return segment info</span></span><br><span class="line"><span class="function">  */</span></span><br><span class="line"><span class="function">  <span class="keyword">private</span> <span class="keyword">byte</span>[] <span class="title">encodeLocationMetadata</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex, <span class="keyword">final</span> <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] newData = <span class="keyword">new</span> <span class="keyword">byte</span>[LOCATION_METADATA_SIZE];</span><br><span class="line">  System.arraycopy(SegmentFile.RECORD_MAGIC_BYTES, <span class="number">0</span>, newData, <span class="number">0</span>, SegmentFile.RECORD_MAGIC_BYTES_SIZE);</span><br><span class="line">  <span class="comment">// 2 bytes reserved</span></span><br><span class="line">  Bits.putLong(newData, SegmentFile.RECORD_MAGIC_BYTES_SIZE + <span class="number">2</span>, firstLogIndex);</span><br><span class="line">  Bits.putInt(newData, SegmentFile.RECORD_MAGIC_BYTES_SIZE + <span class="number">2</span> + <span class="number">8</span>, pos);</span><br><span class="line">  <span class="keyword">return</span> newData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//覆盖父类的onSync方法</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> SegmentFile lastSegmentFile = getLastSegmentFileForRead();</span><br><span class="line">  <span class="keyword">if</span> (lastSegmentFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">    lastSegmentFile.sync(isSync());<span class="comment">//调用Segment文件的sync方法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Segment文件的sync方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Forces any changes made to this segment file&#x27;s content to be written to the</span></span><br><span class="line"><span class="comment">       * storage device containing the mapped file.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  MappedByteBuffer buf = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.committedPos &gt;= <span class="keyword">this</span>.wrotePos) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.committedPos = <span class="keyword">this</span>.wrotePos;</span><br><span class="line">    buf = <span class="keyword">this</span>.buffer;</span><br><span class="line">    LOG.debug(<span class="string">&quot;Commit segment file &#123;&#125; at pos &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path, <span class="keyword">this</span>.committedPos);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sync) &#123;</span><br><span class="line">    fsync(buf);<span class="comment">//刷盘</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fsync</span><span class="params">(<span class="keyword">final</span> MappedByteBuffer buffer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (buffer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">long</span> startMs = Utils.monotonicMs();</span><br><span class="line">    buffer.force(); <span class="comment">//MappedByteBuffer的flush方法</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> cost = Utils.monotonicMs() - startMs;</span><br><span class="line">    <span class="keyword">if</span> (cost &gt;= FSYNC_COST_MS_THRESHOLD) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Call fsync on file &#123;&#125;  cost &#123;&#125; ms.&quot;</span>, <span class="keyword">this</span>.path, cost);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，后台Segment分配线程，加快分配逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSegmentAllocator</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// Warmup</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.blankSegments.isEmpty()) &#123;</span><br><span class="line">    doAllocateSegment0();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Start the thread.</span></span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator = <span class="keyword">new</span> Thread(<span class="keyword">this</span>::doAllocateSegment);</span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator.setName(<span class="string">&quot;SegmentAllocator&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.segmentAllocator.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAllocateSegment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;SegmentAllocator is started.&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">    doAllocateSegmentInLock();</span><br><span class="line">    doSwapOutSegments(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">&quot;SegmentAllocator exit.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntrys写入方法-多个Entrys"><a href="#appendEntrys写入方法-多个Entrys" class="headerlink" title="appendEntrys写入方法(多个Entrys)"></a>appendEntrys写入方法(多个Entrys)</h3><p>RocksDBLogStorage父类，多个Entrys，WriteContext的notify方法就可以串起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entries == <span class="keyword">null</span> || entries.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> entriesCount = entries.size();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> ret = executeBatch(batch -&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> WriteContext writeCtx = newWriteContext();<span class="comment">//初始化上下文</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entriesCount; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> LogEntry entry = entries.get(i);</span><br><span class="line">      <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">        addConfBatch(entry, batch);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        writeCtx.startJob(); <span class="comment">//开起任务，任务数+1</span></span><br><span class="line">        addDataBatch(entry, batch, writeCtx);<span class="comment">//写入上下文传递</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    writeCtx.joinAll(); <span class="comment">//等待所有job完成</span></span><br><span class="line">    doSync(); <span class="comment">//刷一个Segment到磁盘</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">    <span class="keyword">return</span> entriesCount;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-1"><a href="#getEntry读取方法-1" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><p>同写入方法，RocksDBSegmentLogStorage读取方法，通过扩展父类RocksDBLogStorage的扩展方法，实现Segment文件的读取。</p>
<p>父类的读取扩展方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getEntryFromDB(index);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125; in data path: &#123;&#125;.&quot;</span>, index, <span class="keyword">this</span>.path, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnlyForTest</span></span><br><span class="line"><span class="function">LogEntry <span class="title">getEntryFromDB</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> IOException, RocksDBException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes = getKeyBytes(index);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] bs = onDataGet(index, getValueFromRocksDB(keyBytes));<span class="comment">//扩展方法OnDataGet</span></span><br><span class="line">  <span class="keyword">if</span> (bs != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> LogEntry entry = <span class="keyword">this</span>.logEntryDecoder.decode(bs);</span><br><span class="line">    <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> entry;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Bad log entry format for index=&#123;&#125;, the log data is: &#123;&#125;.&quot;</span>, index, BytesUtil.toHex(bs));</span><br><span class="line">      <span class="comment">// invalid data remove? TODO</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//直接放回，可以复写protected</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataGet(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RocksDBSegmentLogStorage的onDataGet方法，才是关键</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataGet(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value) <span class="keyword">throws</span> IOException &#123;<span class="comment">//这里的Value是从RockDB读取的值</span></span><br><span class="line">  <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length != LOCATION_METADATA_SIZE) &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; offset &lt; SegmentFile.RECORD_MAGIC_BYTES_SIZE; offset++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value[offset] != SegmentFile.RECORD_MAGIC_BYTES[offset]) &#123;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// skip reserved</span></span><br><span class="line">  offset += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex = Bits.getLong(value, offset); <span class="comment">//根据特定格式查找index</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> pos = Bits.getInt(value, offset + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">final</span> SegmentFile file = binarySearchFileByFirstLogIndex(firstLogIndex);<span class="comment">//二分法查找Segment文件</span></span><br><span class="line">  <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> file.read(logIndex, pos);<span class="comment">//从Segment文件读取</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LogitLogStorage"><a href="#LogitLogStorage" class="headerlink" title="LogitLogStorage"></a>LogitLogStorage</h2><p>LogitLogStorage，是Java代码，实现的File文件存储。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A logStorage implemented by java</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogitLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger           LOG                    = LoggerFactory.getLogger(LogitLogStorage.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           INDEX_STORE_PATH       = <span class="string">&quot;LogIndex&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           SEGMENT_STORE_PATH     = <span class="string">&quot;LogSegment&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           CONF_STORE_PATH        = <span class="string">&quot;LogConf&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           FIRST_INDEX_CHECKPOINT = <span class="string">&quot;FirstLogIndexCheckpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FirstLogIndexCheckpoint firstLogIndexCheckpoint;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock           readWriteLock          = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                    readLock               = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock                    writeLock              = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> StoreOptions            storeOptions;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                  indexStorePath; <span class="comment">//索引目录</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                  segmentStorePath; <span class="comment">//segment文件目录</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String                  confStorePath;</span><br><span class="line">  <span class="keyword">private</span> String                        groupId;</span><br><span class="line">  <span class="keyword">private</span> ConfigurationManager          configurationManager;</span><br><span class="line">  <span class="keyword">private</span> LogEntryEncoder               logEntryEncoder;</span><br><span class="line">  <span class="keyword">private</span> LogEntryDecoder               logEntryDecoder;</span><br><span class="line">  <span class="keyword">private</span> SegmentLogDB                  segmentLogDB; <span class="comment">//Segment文件数据库，继承AbstractDB</span></span><br><span class="line">  <span class="keyword">private</span> IndexDB                       indexDB; <span class="comment">//索引文件数据库，继承AbstractDB</span></span><br><span class="line">  <span class="keyword">private</span> ConfDB                        confDB;</span><br><span class="line">  <span class="keyword">private</span> LogStoreFactory               logStoreFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件数据库，都继承AbstractDB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.SegmentLogDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB that stores logEntry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentLogDB</span> <span class="keyword">extends</span> <span class="title">AbstractDB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SegmentLogDB</span><span class="params">(<span class="keyword">final</span> String storePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(storePath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FileType <span class="title">getDBFileType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> FileType.FILE_SEGMENT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDBFileSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.storeOptions.getSegmentFileSize();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.IndexDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB that stores index entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexDB</span> <span class="keyword">extends</span> <span class="title">AbstractDB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">IndexDB</span><span class="params">(<span class="keyword">final</span> String storePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(storePath);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.AbstractDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB parent class that invokes fileManager and anager</span></span><br><span class="line"><span class="comment"> * and wrappers uniform functions such as recover() etc..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDB</span> <span class="keyword">implements</span> <span class="title">Lifecycle</span>&lt;<span class="title">LogStoreFactory</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger      LOG                     = LoggerFactory.getLogger(AbstractDB.class);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String      FLUSH_STATUS_CHECKPOINT = <span class="string">&quot;FlushStatusCheckpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String      ABORT_FILE              = <span class="string">&quot;Abort&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> String           storePath;</span><br><span class="line">  <span class="keyword">protected</span> FileManager            fileManager; <span class="comment">//文件管理器</span></span><br><span class="line">  <span class="keyword">protected</span> ServiceManager         serviceManager;</span><br><span class="line">  <span class="keyword">protected</span> LogStoreFactory        logStoreFactory;</span><br><span class="line">  <span class="keyword">protected</span> StoreOptions           storeOptions;</span><br><span class="line">  <span class="keyword">protected</span> AbortFile              abortFile;</span><br><span class="line">  <span class="keyword">protected</span> FlushStatusCheckpoint  flushStatusCheckpoint;</span><br><span class="line">  <span class="keyword">private</span> ScheduledExecutorService checkpointExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-2"><a href="#getEntry读取方法-2" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; getFirstLogIndex() || index &gt; getLastLogIndex()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> IndexEntry indexEntry = <span class="keyword">this</span>.indexDB.lookupIndex(index);<span class="comment">//先查索引</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> phyPosition = indexEntry.getPosition();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span> logType = indexEntry.getLogType();</span><br><span class="line">    <span class="keyword">if</span> (phyPosition != -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">byte</span>[] logBytes;</span><br><span class="line">      <span class="keyword">if</span> (logType == IndexType.IndexSegment.getType()) &#123;</span><br><span class="line">        logBytes = <span class="keyword">this</span>.segmentLogDB.lookupLog(index, phyPosition);<span class="comment">//再从Segment数据库读取</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logBytes = <span class="keyword">this</span>.confDB.lookupLog(index, phyPosition);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.logEntryDecoder.decode(logBytes);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-2"><a href="#appendEntry写入方法-2" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] logData = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">    <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">      <span class="keyword">return</span> doAppendEntry(logIndex, logData, <span class="keyword">this</span>.confDB, IndexType.IndexConf, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> doAppendEntry(logIndex, logData, <span class="keyword">this</span>.segmentLogDB, IndexType.IndexSegment, <span class="keyword">true</span>);<span class="comment">//具体逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">doAppendEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> AbstractDB logDB,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">final</span> IndexType indexType, <span class="keyword">final</span> <span class="keyword">boolean</span> isWaitingFlush)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (logDB == <span class="keyword">null</span> || <span class="keyword">this</span>.indexDB == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append log async , get position infos</span></span><br><span class="line">    <span class="keyword">final</span> Pair&lt;Integer, Long&gt; logPair = logDB.appendLogAsync(logIndex, data); </span><br><span class="line">    <span class="keyword">if</span> (logPair.getFirst() &lt; <span class="number">0</span> || logPair.getSecond() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Pair&lt;Integer, Long&gt; indexPair = <span class="keyword">this</span>.indexDB</span><br><span class="line">      .appendIndexAsync(logIndex, logPair.getFirst(), indexType); <span class="comment">//写入索引文件数据库</span></span><br><span class="line">    <span class="keyword">if</span> (indexPair.getFirst() &lt; <span class="number">0</span> || indexPair.getSecond() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save first log index</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.firstLogIndexCheckpoint.isInit()) &#123;</span><br><span class="line">      saveFirstLogIndex(logIndex); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isWaitingFlush) &#123;</span><br><span class="line">      <span class="keyword">return</span> waitForFlush(logDB, logPair.getSecond(), indexPair.getSecond());<span class="comment">//写入Segment文件数据库</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitForFlush</span><span class="params">(<span class="keyword">final</span> AbstractDB logDB, <span class="keyword">final</span> <span class="keyword">long</span> exceptedLogPosition,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">final</span> <span class="keyword">long</span> exceptedIndexPosition)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> maxFlushTimes = <span class="keyword">this</span>.storeOptions.getMaxFlushTimes();</span><br><span class="line">  <span class="comment">// We should flush log db first, because even If the power fails after flushing the log db</span></span><br><span class="line">  <span class="comment">// we can restore the index db based on the log db.</span></span><br><span class="line">  <span class="keyword">if</span> (!logDB.waitForFlush(exceptedLogPosition, maxFlushTimes)) &#123; <span class="comment">//写入Segment文件数据库</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.indexDB.waitForFlush(exceptedIndexPosition, maxFlushTimes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="HybridLogStorage"><a href="#HybridLogStorage" class="headerlink" title="HybridLogStorage"></a>HybridLogStorage</h2><p>HybridLogStorage是混合日志存储，有新旧两种实现，可以扩展LogStorage的能力，比如更换LogStorage的具体实现。</p>
<blockquote>
<p>HybridLogStorage is used to be compatible with new and old logStorage</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HybridLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span> </span>&#123;</span><br><span class="line">  <span class="comment">//日志检查点</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String                 STATUS_CHECKPOINT_PATH = <span class="string">&quot;HybridStatusCheckpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> HybridStorageStatusCheckpoint statusCheckpoint;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>                    isOldStorageExist; <span class="comment">//判断是否存在旧LogStorage</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LogStorage                    oldLogStorage; <span class="comment">//旧LogStorage</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LogStorage                    newLogStorage; <span class="comment">//新LogStorage</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The index which separates the oldStorage and newStorage</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span>                                thresholdIndex; <span class="comment">//使用新旧LogStorage的分隔Log Index，即阀值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-3"><a href="#getEntry读取方法-3" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index &gt;= <span class="keyword">this</span>.thresholdIndex) &#123; <span class="comment">//大于阀值，从newLogStorage读取</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.newLogStorage.getEntry(index);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isOldStorageExist()) &#123; <span class="comment">//小于阀值，且存在oldLogStorage，从oldLogStorage读取</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.oldLogStorage.getEntry(index);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-3"><a href="#appendEntry写入方法-3" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.newLogStorage.appendEntry(entry); <span class="comment">//写入，都写入newLogStorage</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何确定thresholdIndex"><a href="#如何确定thresholdIndex" class="headerlink" title="如何确定thresholdIndex"></a>如何确定thresholdIndex</h3><p>使用old或者new LogStorage的关键，是thresholdIndex，如何确定thresholdIndex？在init方法，检查点HybridStorageStatusCheckpoint statusCheckpoint，确认存在oldLogStorage，oldLogStorage的lastLogIndex+1，即为thresholdIndex</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> LogStorageOptions opts)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.statusCheckpoint.load(); <span class="comment">//日志检查点 Checkpoint#load方法</span></span><br><span class="line">    <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">this</span>.statusCheckpoint.isOldStorageExist;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isOldStorageExist) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.oldLogStorage != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.oldLogStorage.init(opts)) &#123;</span><br><span class="line">          LOG.warn(<span class="string">&quot;Init old log storage failed when startup hybridLogStorage&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> lastLogIndex = <span class="keyword">this</span>.oldLogStorage.getLastLogIndex();</span><br><span class="line">        <span class="keyword">if</span> (lastLogIndex == <span class="number">0</span>) &#123;</span><br><span class="line">          shutdownOldLogStorage();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastLogIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// Still exists logs in oldLogStorage, need to wait snapshot</span></span><br><span class="line">          <span class="keyword">this</span>.thresholdIndex = lastLogIndex + <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">true</span>;</span><br><span class="line">          LOG.info(</span><br><span class="line">            <span class="string">&quot;Still exists logs in oldLogStorage, lastIndex: &#123;&#125;,  need to wait snapshot to truncate logs&quot;</span>,</span><br><span class="line">            lastLogIndex);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">false</span>;</span><br><span class="line">        saveStatusCheckpoint();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.newLogStorage.init(opts)) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Init new log storage failed when startup hybridLogStorage&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Error happen when when load hybrid status checkpoint&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//日志检查点 Checkpoint#load方法</span></span><br><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.file.assit.Checkpoint</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Checkpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Checkpoint</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.path = path;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Encode metadata</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span>[] encode();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Decode file data</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] bs)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile file = <span class="keyword">new</span> ProtoBufFile(<span class="keyword">this</span>.path);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] data = <span class="keyword">this</span>.encode();</span><br><span class="line">    <span class="keyword">final</span> LocalFileMeta meta = LocalFileMeta.newBuilder() </span><br><span class="line">      .setUserMeta(ZeroByteStringHelper.wrap(data)) </span><br><span class="line">      .build();</span><br><span class="line">    <span class="keyword">return</span> file.save(meta, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile file = <span class="keyword">new</span> ProtoBufFile(<span class="keyword">this</span>.path); <span class="comment">//文件存储</span></span><br><span class="line">    <span class="keyword">final</span> LocalFileMeta meta = file.load();</span><br><span class="line">    <span class="keyword">if</span> (meta != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] data = meta.getUserMeta().toByteArray();</span><br><span class="line">      decode(data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HybridStorageStatusCheckpoint#decode</span></span><br><span class="line"><span class="comment">// com.alipay.sofa.jraft.storage.file.assit.HybridStorageStatusCheckpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HybridStorageStatusCheckpoint</span> <span class="keyword">extends</span> <span class="title">Checkpoint</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">boolean</span> isOldStorageExist = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HybridStorageStatusCheckpoint</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(path);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span>[] encode() &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">short</span> val = (<span class="keyword">short</span>) (<span class="keyword">this</span>.isOldStorageExist ? <span class="number">1</span> : <span class="number">0</span>); <span class="comment">//是否存在oldLogStorage的标志位</span></span><br><span class="line">    Bits.putShort(bs, <span class="number">0</span>, val);</span><br><span class="line">    <span class="keyword">return</span> bs;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] bs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bs.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">short</span> val = Bits.getShort(bs, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.isOldStorageExist = val == <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HybridLogStorage的局限性"><a href="#HybridLogStorage的局限性" class="headerlink" title="HybridLogStorage的局限性"></a>HybridLogStorage的局限性</h3><p>HybridLogStorage看着很美好，但是目前HybridLogStorage有其局限性，构造函数里面，限制了newLogStorage的实现，只能是Java实现的LogitLogStorage。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HybridLogStorage</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> StoreOptions storeOptions, <span class="keyword">final</span> LogStorage oldStorage)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> String newLogStoragePath = Paths.get(path, storeOptions.getStoragePath()).toString();</span><br><span class="line">  <span class="keyword">this</span>.newLogStorage = <span class="keyword">new</span> LogitLogStorage(newLogStoragePath, storeOptions);<span class="comment">//没办法修改newLogStorage的实现</span></span><br><span class="line">  <span class="keyword">this</span>.oldLogStorage = oldStorage;</span><br><span class="line">  <span class="keyword">final</span> String statusCheckpointPath = Paths.get(path, STATUS_CHECKPOINT_PATH).toString();</span><br><span class="line">  <span class="keyword">this</span>.statusCheckpoint = <span class="keyword">new</span> HybridStorageStatusCheckpoint(statusCheckpointPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SOFAJRaft/" rel="tag"># SOFAJRaft</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="prev" title="SOFAJRaft日志存储分析（二）">
      <i class="fa fa-chevron-left"></i> SOFAJRaft日志存储分析（二）
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" rel="next" title="SOFAJRaft元信息Meta存储分析">
      SOFAJRaft元信息Meta存储分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#LogStorage%E5%85%B6%E4%BB%96%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">LogStorage其他实现分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BDBLogStorage"><span class="nav-number">1.1.</span> <span class="nav-text">BDBLogStorage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getEntry%E8%AF%BB%E5%8F%96%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.1.</span> <span class="nav-text">getEntry读取方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#appendEntry%E5%86%99%E5%85%A5%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.2.</span> <span class="nav-text">appendEntry写入方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RocksDBSegmentLogStorage"><span class="nav-number">1.2.</span> <span class="nav-text">RocksDBSegmentLogStorage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#appendEntry%E5%86%99%E5%85%A5%E6%96%B9%E6%B3%95-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">appendEntry写入方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#appendEntrys%E5%86%99%E5%85%A5%E6%96%B9%E6%B3%95-%E5%A4%9A%E4%B8%AAEntrys"><span class="nav-number">1.2.2.</span> <span class="nav-text">appendEntrys写入方法(多个Entrys)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getEntry%E8%AF%BB%E5%8F%96%E6%96%B9%E6%B3%95-1"><span class="nav-number">1.2.3.</span> <span class="nav-text">getEntry读取方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LogitLogStorage"><span class="nav-number">1.3.</span> <span class="nav-text">LogitLogStorage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getEntry%E8%AF%BB%E5%8F%96%E6%96%B9%E6%B3%95-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">getEntry读取方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#appendEntry%E5%86%99%E5%85%A5%E6%96%B9%E6%B3%95-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">appendEntry写入方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HybridLogStorage"><span class="nav-number">1.4.</span> <span class="nav-text">HybridLogStorage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getEntry%E8%AF%BB%E5%8F%96%E6%96%B9%E6%B3%95-3"><span class="nav-number">1.4.1.</span> <span class="nav-text">getEntry读取方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#appendEntry%E5%86%99%E5%85%A5%E6%96%B9%E6%B3%95-3"><span class="nav-number">1.4.2.</span> <span class="nav-text">appendEntry写入方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9AthresholdIndex"><span class="nav-number">1.4.3.</span> <span class="nav-text">如何确定thresholdIndex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HybridLogStorage%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-number">1.4.4.</span> <span class="nav-text">HybridLogStorage的局限性</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zhan Hao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhan Hao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
