<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="一、SOFAJRaft元信息引用SOFARaft，关于Meta元信息存储定义如下：  Meta 存储，元信息存储，记录 raft 实现的内部状态，比如当前 term,、投票给哪个节点等信息。  Meta信息核心接口： 1com.alipay.sofa.jraft.storage.RaftMetaStorage  RaftMetaStorage主要方法： 1234567891011121314151">
<meta property="og:type" content="article">
<meta property="og:title" content="SOFAJRaft元信息Meta存储分析">
<meta property="og:url" content="http://example.com/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Zhan Hao&#39;s Blogs">
<meta property="og:description" content="一、SOFAJRaft元信息引用SOFARaft，关于Meta元信息存储定义如下：  Meta 存储，元信息存储，记录 raft 实现的内部状态，比如当前 term,、投票给哪个节点等信息。  Meta信息核心接口： 1com.alipay.sofa.jraft.storage.RaftMetaStorage  RaftMetaStorage主要方法： 1234567891011121314151">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-09-19T09:03:51.000Z">
<meta property="article:modified_time" content="2022-09-22T08:32:39.511Z">
<meta property="article:author" content="Zhan Hao">
<meta property="article:tag" content="SOFAJRaft">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>SOFAJRaft元信息Meta存储分析 | Zhan Hao's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zhan Hao's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SOFAJRaft元信息Meta存储分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-19 17:03:51" itemprop="dateCreated datePublished" datetime="2022-09-19T17:03:51+08:00">2022-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-09-22 16:32:39" itemprop="dateModified" datetime="2022-09-22T16:32:39+08:00">2022-09-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Meta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">Meta存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="一、SOFAJRaft元信息"><a href="#一、SOFAJRaft元信息" class="headerlink" title="一、SOFAJRaft元信息"></a>一、SOFAJRaft元信息</h1><p>引用SOFARaft，关于Meta元信息存储定义如下：</p>
<blockquote>
<p>Meta 存储，元信息存储，记录 raft 实现的内部状态，比如当前 term,、投票给哪个节点等信息。</p>
</blockquote>
<p>Meta信息核心接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.RaftMetaStorage</span><br></pre></td></tr></table></figure>

<p>RaftMetaStorage主要方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.RaftMetaStorage</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RaftMetaStorage</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span>&lt;<span class="title">RaftMetaStorageOptions</span>&gt;, <span class="title">Storage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set current term.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setTerm</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get current term.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getTerm</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">PeerId <span class="title">getVotedFor</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set term and voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setTermAndVotedFor</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> PeerId peerId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RaftMetaStorage只有一个实现类：LocalRaftMetaStorage，从名字可以看出来，具体实现，是以本地存储为主。即以本地文件的形式完成Meta信息的存储。</p>
<p>LocalRaftMetaStorage的主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalRaftMetaStorage</span> <span class="keyword">implements</span> <span class="title">RaftMetaStorage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String        path; <span class="comment">//本地文件存储路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>                term; <span class="comment">//选举任期</span></span><br><span class="line">    <span class="keyword">private</span> PeerId              votedFor  = PeerId.emptyPeer(); <span class="comment">//选举投票给谁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LocalRaftMetaStorage的主要方法，主要分为Set，Get两类:</p>
<p>其中Set类，保存term和voteFor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">this</span>.votedFor = peerId;</span><br><span class="line">    <span class="keyword">return</span> save();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">this</span>.votedFor = peerId;</span><br><span class="line">    <span class="keyword">return</span> save();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存主要逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> start = Utils.monotonicMs();</span><br><span class="line">    <span class="keyword">final</span> StablePBMeta meta = StablePBMeta.newBuilder() <span class="comment">//存储格式是Protobuf文件格式内容</span></span><br><span class="line">        .setTerm(<span class="keyword">this</span>.term) </span><br><span class="line">        .setVotedfor(<span class="keyword">this</span>.votedFor.toString()) </span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile pbFile = newPbFile();<span class="comment">//Protobuf文件</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pbFile.save(meta, <span class="keyword">this</span>.raftOptions.isSyncMeta())) &#123;<span class="comment">//写入文件</span></span><br><span class="line">            reportIOError();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Fail to save raft meta&quot;</span>, e);</span><br><span class="line">        reportIOError();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> cost = Utils.monotonicMs() - start;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.nodeMetrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nodeMetrics.recordLatency(<span class="string">&quot;save-raft-meta&quot;</span>, cost);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;Save raft meta, path=&#123;&#125;, term=&#123;&#125;, votedFor=&#123;&#125;, cost time=&#123;&#125; ms&quot;</span>, <span class="keyword">this</span>.path, <span class="keyword">this</span>.term,</span><br><span class="line">            <span class="keyword">this</span>.votedFor, cost);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>StablePBMeta是实现了protobuf的数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.entity.LocalStorageOutter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StablePBMeta</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>   term_;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> java.lang.Object votedfor_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存protobuf文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.io.ProtoBufFile</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> <span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Write message into temp file</span></span><br><span class="line">    <span class="keyword">final</span> File file = <span class="keyword">new</span> File(<span class="keyword">this</span>.path + <span class="string">&quot;.tmp&quot;</span>);<span class="comment">//先保存tmp文件</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="keyword">final</span> FileOutputStream fOut = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            <span class="keyword">final</span> BufferedOutputStream output = <span class="keyword">new</span> BufferedOutputStream(fOut)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] lenBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// name len + name</span></span><br><span class="line">        <span class="keyword">final</span> String fullName = msg.getDescriptorForType().getFullName();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> nameLen = fullName.length();</span><br><span class="line">        Bits.putInt(lenBytes, <span class="number">0</span>, nameLen);</span><br><span class="line">        output.write(lenBytes);</span><br><span class="line">        output.write(fullName.getBytes());</span><br><span class="line">        <span class="comment">// msg len + msg</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> msgLen = msg.getSerializedSize();</span><br><span class="line">        Bits.putInt(lenBytes, <span class="number">0</span>, msgLen);</span><br><span class="line">        output.write(lenBytes);</span><br><span class="line">        msg.writeTo(output);</span><br><span class="line">        output.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sync) &#123; <span class="comment">//同步刷盘</span></span><br><span class="line">        Utils.fsync(file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Utils.atomicMoveFile(file, <span class="keyword">new</span> File(<span class="keyword">this</span>.path), sync); <span class="comment">//tmp文件 -&gt; 正式文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中Get类，读取term和voteFor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTerm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.term; <span class="comment">//直接读取属性，初始化的时候，有load方法，从磁盘文件读取。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PeerId <span class="title">getVotedFor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.votedFor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> RaftMetaStorageOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isInited) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Raft meta storage is already inited.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.node = opts.getNode();</span><br><span class="line">    <span class="keyword">this</span>.nodeMetrics = <span class="keyword">this</span>.node.getNodeMetrics();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileUtils.forceMkdir(<span class="keyword">new</span> File(<span class="keyword">this</span>.path));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Fail to mkdir &#123;&#125;&quot;</span>, <span class="keyword">this</span>.path, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (load()) &#123;<span class="comment">//从磁盘文件读取</span></span><br><span class="line">        <span class="keyword">this</span>.isInited = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile pbFile = newPbFile();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> StablePBMeta meta = pbFile.load();<span class="comment">//从Protobuf文件读取</span></span><br><span class="line">        <span class="keyword">if</span> (meta != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.term = meta.getTerm();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.votedFor.parse(meta.getVotedfor());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Fail to load raft meta storage&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="二、SOFAJRaft元信息使用"><a href="#二、SOFAJRaft元信息使用" class="headerlink" title="二、SOFAJRaft元信息使用"></a>二、SOFAJRaft元信息使用</h1><p>SOFAJRaft元信息的使用，主要发生在选举的过程中，具体代码在Node的实现类NodeImpl.java里面。</p>
<p>场景1：比如开始选举时，把选票投给自己的时候</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">electSelf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> oldTerm;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Node &#123;&#125; start vote and grant vote self, term=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.conf.contains(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; can&#x27;t do electSelf as it is not in &#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.conf);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_FOLLOWER) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Node &#123;&#125; stop election timer, term=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">            <span class="keyword">this</span>.electionTimer.stop();</span><br><span class="line">        &#125;</span><br><span class="line">        resetLeaderId(PeerId.emptyPeer(), <span class="keyword">new</span> Status(RaftError.ERAFTTIMEDOUT,</span><br><span class="line">            <span class="string">&quot;A follower&#x27;s leader_id is reset to NULL as it begins to request_vote.&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.state = State.STATE_CANDIDATE;</span><br><span class="line">        <span class="keyword">this</span>.currTerm++;</span><br><span class="line">        <span class="keyword">this</span>.votedId = <span class="keyword">this</span>.serverId.copy();</span><br><span class="line">        LOG.debug(<span class="string">&quot;Node &#123;&#125; start vote timer, term=&#123;&#125; .&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">        <span class="keyword">this</span>.voteTimer.start();</span><br><span class="line">        <span class="keyword">this</span>.voteCtx.init(<span class="keyword">this</span>.conf.getConf(), <span class="keyword">this</span>.conf.isStable() ? <span class="keyword">null</span> : <span class="keyword">this</span>.conf.getOldConf());</span><br><span class="line">        oldTerm = <span class="keyword">this</span>.currTerm;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// vote need defense ABA after unlock&amp;writeLock</span></span><br><span class="line">        <span class="keyword">if</span> (oldTerm != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; raise term &#123;&#125; when getLastLogId.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : <span class="keyword">this</span>.conf.listPeers()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (peer.equals(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.rpcService.connect(peer.getEndpoint())) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Node &#123;&#125; channel init failed, address=&#123;&#125;.&quot;</span>, getNodeId(), peer.getEndpoint());</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> OnRequestVoteRpcDone done = <span class="keyword">new</span> OnRequestVoteRpcDone(peer, <span class="keyword">this</span>.currTerm, <span class="keyword">this</span>);</span><br><span class="line">            done.request = RequestVoteRequest.newBuilder() <span class="comment">//</span></span><br><span class="line">                .setPreVote(<span class="keyword">false</span>) <span class="comment">// It&#x27;s not a pre-vote request.</span></span><br><span class="line">                .setGroupId(<span class="keyword">this</span>.groupId) <span class="comment">//</span></span><br><span class="line">                .setServerId(<span class="keyword">this</span>.serverId.toString()) <span class="comment">//</span></span><br><span class="line">                .setPeerId(peer.toString()) <span class="comment">//</span></span><br><span class="line">                .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">                .setLastLogIndex(lastLogId.getIndex()) <span class="comment">//</span></span><br><span class="line">                .setLastLogTerm(lastLogId.getTerm()) <span class="comment">//</span></span><br><span class="line">                .build();</span><br><span class="line">            <span class="keyword">this</span>.rpcService.requestVote(peer.getEndpoint(), done.request, done);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(<span class="keyword">this</span>.currTerm, <span class="keyword">this</span>.serverId); <span class="comment">//term和serverId都是Node自身的属性</span></span><br><span class="line">        <span class="keyword">this</span>.voteCtx.grant(<span class="keyword">this</span>.serverId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.voteCtx.isGranted()) &#123;</span><br><span class="line">            becomeLeader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景2：降级，收到更高的任期的时候</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stepDown</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> <span class="keyword">boolean</span> wakeupCandidate, <span class="keyword">final</span> Status status)</span> </span>&#123;</span><br><span class="line">    LOG.debug(<span class="string">&quot;Node &#123;&#125; stepDown, term=&#123;&#125;, newTerm=&#123;&#125;, wakeupCandidate=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm, term,</span><br><span class="line">        wakeupCandidate);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_CANDIDATE) &#123;</span><br><span class="line">        stopVoteTimer();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state.compareTo(State.STATE_TRANSFERRING) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        stopStepDownTimer();</span><br><span class="line">        <span class="keyword">this</span>.ballotBox.clearPendingTasks();</span><br><span class="line">        <span class="comment">// signal fsm leader stop immediately</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_LEADER) &#123;</span><br><span class="line">            onLeaderStop(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// reset leader_id</span></span><br><span class="line">    resetLeaderId(PeerId.emptyPeer(), status);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// soft state in memory</span></span><br><span class="line">    <span class="keyword">this</span>.state = State.STATE_FOLLOWER;</span><br><span class="line">    <span class="keyword">this</span>.confCtx.reset();</span><br><span class="line">    updateLastLeaderTimestamp(Utils.monotonicMs());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.snapshotExecutor.interruptDownloadingSnapshots(term);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// meta state</span></span><br><span class="line">    <span class="keyword">if</span> (term &gt; <span class="keyword">this</span>.currTerm)  <span class="comment">//收到更高的term</span></span><br><span class="line">        <span class="keyword">this</span>.currTerm = term;</span><br><span class="line">        <span class="keyword">this</span>.votedId = PeerId.emptyPeer();</span><br><span class="line">        <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(term, <span class="keyword">this</span>.votedId);<span class="comment">//只更新term</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wakeupCandidate) &#123;</span><br><span class="line">        <span class="keyword">this</span>.wakingCandidate = <span class="keyword">this</span>.replicatorGroup.stopAllAndFindTheNextCandidate(<span class="keyword">this</span>.conf);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.wakingCandidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Replicator.sendTimeoutNowAndStop(<span class="keyword">this</span>.wakingCandidate, <span class="keyword">this</span>.options.getElectionTimeoutMs());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.replicatorGroup.stopAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.stopTransferArg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.transferTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.transferTimer.cancel(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// There is at most one StopTransferTimer at the same term, it&#x27;s safe to</span></span><br><span class="line">        <span class="comment">// mark stopTransferArg to NULL</span></span><br><span class="line">        <span class="keyword">this</span>.stopTransferArg = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Learner node will not trigger the election timer.</span></span><br><span class="line">    <span class="keyword">if</span> (!isLearner()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.electionTimer.restart();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Node &#123;&#125; is a learner, election timer is not started.&quot;</span>, <span class="keyword">this</span>.nodeId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景3：收到其他候选人的选票时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">handleRequestVoteRequest</span><span class="params">(<span class="keyword">final</span> RequestVoteRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; is not in active state, currTerm=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">            <span class="keyword">return</span> RpcFactoryHelper <span class="comment">//</span></span><br><span class="line">                .responseFactory() <span class="comment">//</span></span><br><span class="line">                .newResponse(RequestVoteResponse.getDefaultInstance(), RaftError.EINVAL,</span><br><span class="line">                    <span class="string">&quot;Node %s is not in active state, state %s.&quot;</span>, getNodeId(), <span class="keyword">this</span>.state.name());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> PeerId candidateId = <span class="keyword">new</span> PeerId();</span><br><span class="line">        <span class="keyword">if</span> (!candidateId.parse(request.getServerId())) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; received RequestVoteRequest from &#123;&#125; serverId bad format.&quot;</span>, getNodeId(),</span><br><span class="line">                request.getServerId());</span><br><span class="line">            <span class="keyword">return</span> RpcFactoryHelper <span class="comment">//</span></span><br><span class="line">                .responseFactory() <span class="comment">//</span></span><br><span class="line">                .newResponse(RequestVoteResponse.getDefaultInstance(), RaftError.EINVAL,</span><br><span class="line">                    <span class="string">&quot;Parse candidateId failed: %s.&quot;</span>, request.getServerId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// noinspection ConstantConditions</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// check term</span></span><br><span class="line">            <span class="keyword">if</span> (request.getTerm() &gt;= <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;Node &#123;&#125; received RequestVoteRequest from &#123;&#125;, term=&#123;&#125;, currTerm=&#123;&#125;.&quot;</span>, getNodeId(),</span><br><span class="line">                    request.getServerId(), request.getTerm(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">                <span class="comment">// increase current term, change state to follower</span></span><br><span class="line">                <span class="keyword">if</span> (request.getTerm() &gt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                    stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EHIGHERTERMRESPONSE,</span><br><span class="line">                        <span class="string">&quot;Raft node receives higher term RequestVoteRequest.&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ignore older term</span></span><br><span class="line">                LOG.info(<span class="string">&quot;Node &#123;&#125; ignore RequestVoteRequest from &#123;&#125;, term=&#123;&#125;, currTerm=&#123;&#125;.&quot;</span>, getNodeId(),</span><br><span class="line">                    request.getServerId(), request.getTerm(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            doUnlock = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            doUnlock = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">            <span class="comment">// vote need ABA check after unlock&amp;writeLock</span></span><br><span class="line">            <span class="keyword">if</span> (request.getTerm() != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Node &#123;&#125; raise term &#123;&#125; when get lastLogId.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> logIsOk = <span class="keyword">new</span> LogId(request.getLastLogIndex(), request.getLastLogTerm())</span><br><span class="line">                .compareTo(lastLogId) &gt;= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logIsOk &amp;&amp; (<span class="keyword">this</span>.votedId == <span class="keyword">null</span> || <span class="keyword">this</span>.votedId.isEmpty())) &#123;</span><br><span class="line">                stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EVOTEFORCANDIDATE,</span><br><span class="line">                    <span class="string">&quot;Raft node votes for some candidate, step down to restart election_timer.&quot;</span>));</span><br><span class="line">                <span class="keyword">this</span>.votedId = candidateId.copy();</span><br><span class="line">                <span class="keyword">this</span>.metaStorage.setVotedFor(candidateId); <span class="comment">//更新候选人信息</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RequestVoteResponse.newBuilder() <span class="comment">//</span></span><br><span class="line">            .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">            .setGranted(request.getTerm() == <span class="keyword">this</span>.currTerm &amp;&amp; candidateId.equals(<span class="keyword">this</span>.votedId)) <span class="comment">//</span></span><br><span class="line">            .build();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SOFAJRaft/" rel="tag"># SOFAJRaft</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/" rel="prev" title="SOFAJRaft日志存储分析（三）">
      <i class="fa fa-chevron-left"></i> SOFAJRaft日志存储分析（三）
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/23/SpringBoot3%E5%BF%AB%E9%80%9F%E4%BD%93%E9%AA%8C/" rel="next" title="SpringBoot3快速体验">
      SpringBoot3快速体验 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AF"><span class="nav-number">1.</span> <span class="nav-text">一、SOFAJRaft元信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AF%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">二、SOFAJRaft元信息使用</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zhan Hao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhan Hao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
